# Business Architecture Review: New Inventory System v2

**Дата:** 05.12.2025  
**Статус:** Draft  
**Цель:** Оценка бизнес-логики и операционных рисков внедрения новой системы инвентаризации.

---

## 1. Общая оценка (Executive Summary)

Предложенная архитектура v2 (`new-inventory`) представляет собой **профессиональную WMS (Warehouse Management System)** уровня enterprise. Она закрывает критические дыры текущей системы (партионный учет, FEFO, условия хранения).

Однако, система выглядит **избыточно сложной для операционного персонала** (продавцов и кладовщиков). Главный риск кроется не в коде, а в "физическом мире": если сотрудник в магазине не будет нажимать кнопки с той же точностью, с какой работает код, данные в системе станут мусором ("Garbage In, Garbage Out") через неделю использования.

---

## 2. Операционные "узкие горлышки" (Человеческий фактор)

### 2.1. Смешивание партий (Mixing) — Самый высокий риск
**Как задумано:** При объединении остатков создается `MixedBatch` с усредненной ценой и сроком.
**Реальность:** Продавец высыпает остатки клубники из двух ящиков в один.
- **Проблема:** Чтобы сделать это в системе, он должен: взвесить Партию А, взвесить Партию Б, создать документ смешивания. В реальности он просто высыпет и забудет.
- **Итог:** В системе останется две "виртуальные" партии, а по факту лежит одна смешанная. При продаже по QR-коду одной из коробок пойдет рассинхрон (продаем то, чего "нет", или списываем то, что "есть").
- **Рекомендация:** Убрать явное создание `MixedBatch` для MVP. Сделать "автосмешивание" при инвентаризации или списании, либо списывать старую партию и приходовать новую "сборную" через упрощенный интерфейс.

### 2.2. "Живые" фото (Daily Live Photos)
**Как задумано:** Ежедневные фото, максимум 3 активных, удаление старых.
**Реальность:** В магазине 500+ SKU. Сделать 500 фото ежедневно — это ~8 часов работы (1 минута на фото + загрузку).
- **Риск:** Персонал будет либо игнорировать это, либо грузить "фейковые" вчерашние фото, либо фотографировать только "красивое", скрывая порчу.
- **Рекомендация:** Внедрить алгоритм "Smart Request": просить фото только для:
    - Товаров с истекающим сроком (<3 дней).
    - Товаров High Value (дорогих).
    - Товаров после инцидентов (возвратов).
    - Не чаще 1 раза в 3 дня для Shelf Stable.

### 2.3. Ручная корректировка свежести
**Как задумано:** `freshnessAdjustment` с логированием причин.
**Риск:** Субъективность. Один сотрудник считает банан "слегка потемневшим" (свежесть 70%), другой — "гнилым" (свежесть 20%).
**Последствие:** Динамическое ценообразование будет скакать, вызывая вопросы у покупателей.

---

## 3. Слабые места в Бизнес-логике (Business Logic Gaps)

### 3.1. Возвраты Поставщику (Supplier Returns)
В плане есть модуль `Return` (от клиента), но слабо проработан возврат **Поставщику**.
- **Кейс:** Привезли 100кг, приняли. Через 2 дня обнаружили скрытую гниль внутри партии.
- **Вопрос:** Мы списываем это в убыток (`WriteOff`) или оформляем претензию поставщику?
- **Не хватает:** Статуса партии `DISPUTE` (спор) и связи с балансом поставщика (взаиморасчеты).

### 3.2. Конфликт Офлайн-продаж и Резервов
**Как задумано:** Единый остаток.
**Кейс:** Покупатель в магазине взял с полки последний пакет молока. В эту же секунду падает онлайн-заказ на этот пакет.
- **Проблема:** Кассир пробивает товар (или сканирует QR). Система говорит "Зарезервировано". Покупатель стоит с товаром в руках. Отбирать?
- **Рекомендация:** Приоритет всегда у **физического** покупателя на кассе (если заказ еще не собран). Система должна уметь "жестко" перехватывать резерв и слать отмену онлайн-клиенту.

### 3.3. Тара и Упаковка
В типах товаров есть `NON_FOOD` (упаковка), но не описана логика **оборотной тары**.
- Если мы продаем яблоки в ящиках, ящик нужно возвращать? Если да, это залоговая стоимость? В текущем плане это не учтено.

---

## 4. Финансовые и Юридические "НО"

### 4.1. Себестоимость MixedBatch
Усреднение цены (`weightedPurchasePrice`) математически верно, но бухгалтерски может быть сложным.
- **Вопрос:** Как это бьется с налоговым учетом? Обычно используется FIFO или "по средней", но "по средней" считается за период, а не по факту смешивания двух коробок. Требуется консультация с бухгалтером.

### 4.2. Динамическая цена и Ценники
Если у нас работает "автоскидка по сроку годности":
- **Проблема Офлайн:** На полке стоит ценник 100р. В системе срок подошел, цена стала 80р. Или наоборот (акция закончилась).
- **Риск:** По закону (в РФ и многих странах) магазин обязан продать по цене на ценнике. Электронные ценники (ESL) дороги. Персонал не будет успевать менять бумажки каждые 2 часа.
- **Вывод:** Динамическое ценообразование должно работать только для **Онлайн** витрины. Офлайн цена должна быть более стабильной.

---

## 5. Стратегия Миграции (Migration Risks)

### 5.1. Двойное ведение справочников
План предполагает `Product` (legacy) и `ProductTemplate` (new).
- **Риск:** Менеджеры будут создавать товары в старой админке по привычке. Новая система их не увидит.
- **Решение:** Либо полная синхронизация (CRUD в старой базе триггерит создание в новой), либо полное закрытие доступа к созданию товаров в старой админке.

### 5.2. Инвентаризация при запуске
Запуск новой системы требует полной инвентаризации (перевзвешивания всего склада). Это остановка работы на сутки.
- **Рекомендация:** Rolling Migration. Переводить на новую систему по **категориям** (сначала "Бакалея", потом "Химия", в конце "Фрукты").

---

## 6. Итоговые Рекомендации

1.  **Cut the "Fat" (Упрощение MVP):**
    *   Отложить **IoT/Датчики** на Фазу 10+.
    *   Убрать **MixedBatch** как пользовательскую операцию. Оставить только автосписание.
    *   Сделать **ProductTemplate** просто расширением (через `OneToOne` связь), а не дублированием данных.

2.  **Фокус на "Дуракоустойчивость":**
    *   Интерфейс кладовщика должен иметь кнопку "Сделать хорошо".
    *   Если вес при приемке расходится с накладной на 5% — алерт, но не блокировка.
    *   Если продавец не ввел температуру — брать "среднюю по больнице" (нормативную), а не блокировать процесс.

3.  **Бизнес-фичи:**
    *   Добавить **"Усушку" (Shrinkage)**: Автоматическое списание веса для овощей/фруктов (напр., 1% в сутки испаряется влага). Иначе через неделю на складе будет "недостача", которая по факту является физикой, только сделай это опциональным, например добавь поле в схеме или типо того

**Вердикт:** Система правильная технически, но требует сильного упрощения операционных процессов перед внедрением.
