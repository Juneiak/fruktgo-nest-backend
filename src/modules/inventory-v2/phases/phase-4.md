# Ğ¤Ğ°Ğ·Ğ° 4: Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ + ĞĞ»ĞµÑ€Ñ‚Ñ‹

> **Ğ¡Ñ€Ğ¾Ğº:** 2-3 Ğ´Ğ½Ñ  
> **Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸:** Ğ¤Ğ°Ğ·Ğ° 2, Ğ¤Ğ°Ğ·Ğ° 3 (Ğ½ÑƒĞ¶Ğ½Ñ‹ Batch, BatchLocation, Movement)

---

## Ğ§Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµĞ¼ Ğ² ÑÑ‚Ğ¾Ğ¹ Ñ„Ğ°Ğ·Ğµ

1. **Audit** â€” Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (ÑĞ²ĞµÑ€ĞºĞ° Ñ„Ğ°ĞºÑ‚Ğ° Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ¾Ğ¹)
2. **Alerts** â€” Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹ Ğ¿Ğ¾ ÑÑ€Ğ¾ĞºĞ°Ğ¼ Ğ³Ğ¾Ğ´Ğ½Ğ¾ÑÑ‚Ğ¸

---

## Ğ—Ğ°Ñ‡ĞµĞ¼ ÑÑ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ (Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğ¼Ğ¸ ÑĞ»Ğ¾Ğ²Ğ°Ğ¼Ğ¸)

### Ğ—Ğ°Ñ‡ĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ğ° Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ?

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚: "Ğ£ Ñ‚ĞµĞ±Ñ 50 ĞºĞ³ ÑĞ±Ğ»Ğ¾Ğº"  
Ğ¢Ñ‹ Ğ¸Ğ´Ñ‘ÑˆÑŒ Ğ½Ğ° ÑĞºĞ»Ğ°Ğ´ Ğ¸ Ğ²Ğ¸Ğ´Ğ¸ÑˆÑŒ: 47 ĞºĞ³

**ĞšÑƒĞ´Ğ° Ğ´ĞµĞ»Ğ¸ÑÑŒ 3 ĞºĞ³?**
- ĞœĞ¾Ğ¶ĞµÑ‚, ÑƒĞºÑ€Ğ°Ğ»Ğ¸
- ĞœĞ¾Ğ¶ĞµÑ‚, Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ»Ğ¸ Ğ¼Ğ¸Ğ¼Ğ¾ ĞºĞ°ÑÑÑ‹
- ĞœĞ¾Ğ¶ĞµÑ‚, Ğ½ĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ»Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ĞºĞµ
- ĞœĞ¾Ğ¶ĞµÑ‚, ÑƒĞ¶Ğµ ÑĞ¿Ğ¸ÑĞ°Ğ»Ğ¸, Ğ½Ğ¾ Ğ·Ğ°Ğ±Ñ‹Ğ»Ğ¸

Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ â€” ÑÑ‚Ğ¾ **ÑĞ²ĞµÑ€ĞºĞ°** Ñ‚Ğ¾Ğ³Ğ¾, Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°, Ñ Ñ‚ĞµĞ¼, Ñ‡Ñ‚Ğ¾ ĞµÑÑ‚ÑŒ Ğ½Ğ° ÑĞ°Ğ¼Ğ¾Ğ¼ Ğ´ĞµĞ»Ğµ.

### Ğ—Ğ°Ñ‡ĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ñ‹ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹?

ĞšĞ»ÑƒĞ±Ğ½Ğ¸ĞºĞ° Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ‚ÑÑ Ğ·Ğ° 3 Ğ´Ğ½Ñ. Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ Ğ²Ğ¾Ğ²Ñ€ĞµĞ¼Ñ â€” Ğ¿Ñ€Ğ¸Ğ´Ñ‘Ñ‚ÑÑ ÑĞ¿Ğ¸ÑĞ°Ñ‚ÑŒ.

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° **Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´Ğ°Ñ‚ÑŒ**:
- "âš ï¸ 10 ĞºĞ³ ĞºĞ»ÑƒĞ±Ğ½Ğ¸ĞºĞ¸ Ğ¸ÑÑ‚ĞµĞºĞ°ĞµÑ‚ Ñ‡ĞµÑ€ĞµĞ· 2 Ğ´Ğ½Ñ!"
- "ğŸ”´ 5 ĞºĞ³ Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³Ğ° Ğ¸ÑÑ‚ĞµĞºĞ»Ğ¾ Ğ²Ñ‡ĞµÑ€Ğ° â€” ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾ ÑĞ¿Ğ¸ÑĞ°Ñ‚ÑŒ!"

---

## ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸

### Ğ¨Ğ°Ğ³ 1: Audit (Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ)

**Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾:** Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¾ ÑĞ²ĞµÑ€ĞºĞµ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¾Ğ².

**Ğ¤Ğ°Ğ¹Ğ»Ñ‹:**
- `operations/audit/audit.schema.ts`
- `operations/audit/audit.enums.ts`
- `operations/audit/audit.commands.ts`
- `operations/audit/audit.queries.ts`
- `operations/audit/audit.port.ts`
- `operations/audit/audit.service.ts`
- `operations/audit/audit.module.ts`

**Ğ¢Ğ¸Ğ¿Ñ‹ Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:**

```
FULL    â€” Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ (Ğ²ÑĞµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ² Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸)
PARTIAL â€” Ñ‡Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ°Ñ (Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹/ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸)
CONTROL â€” ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒĞ½Ğ°Ñ (Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°)
```

**ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ:**

```typescript
seller: ObjectId
documentNumber: string      // "AUD-2024-12-05-001"

type: AuditType             // FULL, PARTIAL, CONTROL
storageLocation: ObjectId   // Ğ“Ğ´Ğµ Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ´Ğ¸Ğ¼

// ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸
items: [{
  batch: ObjectId           // ĞšĞ°ĞºĞ°Ñ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ñ
  productTemplate: ObjectId // ĞšĞ°ĞºĞ¾Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
  
  // ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ vs Ñ„Ğ°ĞºÑ‚
  expectedQuantity: number  // ĞŸĞ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ
  actualQuantity: number    // ĞŸĞ¾ Ñ„Ğ°ĞºÑ‚Ñƒ (Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº)
  
  // Ğ Ğ°ÑÑ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ
  discrepancy: number       // actual - expected
  discrepancyPercent: number // Ğ² Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ°Ñ…
  
  comment: string           // "ĞĞ°ÑˆÑ‘Ğ» Ğ² Ğ´Ğ°Ğ»ÑŒĞ½ĞµĞ¼ ÑƒĞ³Ğ»Ñƒ"
}]

// ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ»Ğ¸ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸?
applyCorrections: boolean   // Ğ•ÑĞ»Ğ¸ true â€” Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¸

// Ğ˜Ñ‚Ğ¾Ğ³Ğ¸
summary: {
  totalExpected: number
  totalActual: number
  totalDiscrepancy: number
  itemsWithDiscrepancy: number
}

status: AuditStatus
startedBy: ObjectId
startedAt: Date
completedBy: ObjectId
completedAt: Date
```

**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:**
```
DRAFT       â€” Ñ‡ĞµÑ€Ğ½Ğ¾Ğ²Ğ¸Ğº (Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ°)
IN_PROGRESS â€” Ğ¸Ğ´Ñ‘Ñ‚ Ğ¿Ğ¾Ğ´ÑÑ‡Ñ‘Ñ‚
COMPLETED   â€” Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°
CANCELLED   â€” Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°
```

**Workflow Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:**

```
1. Ğ¡ĞĞ—Ğ”ĞĞĞ˜Ğ• (status: DRAFT)
   â”œâ”€â”€ Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ
   â”œâ”€â”€ Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ‚Ğ¸Ğ¿ (FULL/PARTIAL/CONTROL)
   â”œâ”€â”€ Ğ•ÑĞ»Ğ¸ PARTIAL â€” Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹/ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸
   â”‚
   â””â”€â”€ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¸:
       â””â”€â”€ items Ñ expectedQuantity Ğ¸Ğ· BatchLocation

2. ĞĞĞ§ĞĞ›Ğ (status: IN_PROGRESS)
   â”œâ”€â”€ Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº Ğ¸Ğ´Ñ‘Ñ‚ ÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ
   â””â”€â”€ Ğ’Ğ²Ğ¾Ğ´Ğ¸Ñ‚ actualQuantity Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸

3. Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ˜Ğ• (status: COMPLETED)
   Ğ•ÑĞ»Ğ¸ applyCorrections = true:
   â”‚
   Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ñ discrepancy â‰  0:
   â”‚
   â”œâ”€â”€ Ğ•ÑĞ»Ğ¸ discrepancy > 0 (Ğ½Ğ°ÑˆĞ»Ğ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ):
   â”‚   â”œâ”€â”€ Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ quantity Ğ² BatchLocation
   â”‚   â””â”€â”€ Movement type = ADJUSTMENT_PLUS
   â”‚
   â””â”€â”€ Ğ•ÑĞ»Ğ¸ discrepancy < 0 (Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‡Ğ°):
       â”œâ”€â”€ Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞ°ĞµĞ¼ quantity Ğ² BatchLocation
       â””â”€â”€ Movement type = ADJUSTMENT_MINUS
```

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:**

```
Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ #AUD-001:
â”œâ”€â”€ Ğ›Ğ¾ĞºĞ°Ñ†Ğ¸Ñ: ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ½Ğ° Ğ›ĞµĞ½Ğ¸Ğ½Ğ°
â”œâ”€â”€ Ğ¢Ğ¸Ğ¿: FULL
â”‚
â”œâ”€â”€ ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ 1: Ğ¯Ğ±Ğ»Ğ¾ĞºĞ¸, ĞŸĞ°Ñ€Ñ‚Ğ¸Ñ P-001
â”‚   â”œâ”€â”€ ĞŸĞ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ: 50 ĞºĞ³
â”‚   â”œâ”€â”€ ĞŸĞ¾ Ñ„Ğ°ĞºÑ‚Ñƒ: 47 ĞºĞ³
â”‚   â”œâ”€â”€ Ğ Ğ°ÑÑ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ: -3 ĞºĞ³ (Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‡Ğ°)
â”‚   â””â”€â”€ â†’ Movement: ADJUSTMENT_MINUS, -3 ĞºĞ³
â”‚
â”œâ”€â”€ ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ 2: Ğ“Ñ€ÑƒÑˆĞ¸, ĞŸĞ°Ñ€Ñ‚Ğ¸Ñ P-002
â”‚   â”œâ”€â”€ ĞŸĞ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ: 20 ĞºĞ³
â”‚   â”œâ”€â”€ ĞŸĞ¾ Ñ„Ğ°ĞºÑ‚Ñƒ: 22 ĞºĞ³
â”‚   â”œâ”€â”€ Ğ Ğ°ÑÑ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ: +2 ĞºĞ³ (Ğ¸Ğ·Ğ»Ğ¸ÑˆĞµĞº)
â”‚   â””â”€â”€ â†’ Movement: ADJUSTMENT_PLUS, +2 ĞºĞ³
â”‚
â””â”€â”€ ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ 3: Ğ‘Ğ°Ğ½Ğ°Ğ½Ñ‹, ĞŸĞ°Ñ€Ñ‚Ğ¸Ñ P-003
    â”œâ”€â”€ ĞŸĞ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ: 15 ĞºĞ³
    â”œâ”€â”€ ĞŸĞ¾ Ñ„Ğ°ĞºÑ‚Ñƒ: 15 ĞºĞ³
    â”œâ”€â”€ Ğ Ğ°ÑÑ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ: 0
    â””â”€â”€ â†’ ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ´ĞµĞ»Ğ°ĞµĞ¼
```

**ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ ÑĞ¼ĞµÑˆĞ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ğ¹:**

ĞŸÑ€Ğ¸ Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ñ„Ğ¸Ğ·Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¼ĞµÑˆĞ°Ğ½:

```
Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº: "Ğ’ ÑÑ‚Ğ¾Ğ¹ ĞºĞ¾Ñ€Ğ¾Ğ±ĞºĞµ ÑĞ±Ğ»Ğ¾ĞºĞ¸ Ğ¸Ğ· Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ğ¹, 
            Ğ½Ğµ Ğ¼Ğ¾Ğ³Ñƒ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒ"

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ°: "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞ¼ĞµÑˆĞ°Ğ½Ğ½ÑƒÑ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ñ (MixedBatch)?"

Ğ•ÑĞ»Ğ¸ Ğ´Ğ°:
â”œâ”€â”€ Ğ’Ğ²Ğ¾Ğ´Ğ¸Ğ¼, ĞºĞ°ĞºĞ¸Ğµ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ğ¸ ÑĞ¼ĞµÑˆĞ°Ğ½Ñ‹ Ğ¸ Ğ² ĞºĞ°ĞºĞ¸Ñ… Ğ¿Ñ€Ğ¾Ğ¿Ğ¾Ñ€Ñ†Ğ¸ÑÑ…
â”œâ”€â”€ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ MixedBatch
â””â”€â”€ Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞ°ĞµĞ¼ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğµ BatchLocation
```

---

### Ğ¨Ğ°Ğ³ 2: ExpirationAlertService (Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹)

**Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾:** Ğ¡ĞµÑ€Ğ²Ğ¸Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ ÑĞ»ĞµĞ´Ğ¸Ñ‚ Ğ·Ğ° ÑÑ€Ğ¾ĞºĞ°Ğ¼Ğ¸ Ğ³Ğ¾Ğ´Ğ½Ğ¾ÑÑ‚Ğ¸.

**Ğ¤Ğ°Ğ¹Ğ»Ñ‹:**
- `alerts/expiration-alert.service.ts`
- `alerts/expiration-alert.types.ts`
- `alerts/expiration-alert.module.ts`

**Ğ£Ñ€Ğ¾Ğ²Ğ½Ğ¸ Ğ°Ğ»ĞµÑ€Ñ‚Ğ¾Ğ²:**

```
NORMAL   â€” Ğ²ÑÑ‘ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¾ (> 7 Ğ´Ğ½ĞµĞ¹)
WARNING  â€” Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ (3-7 Ğ´Ğ½ĞµĞ¹)
CRITICAL â€” ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾ (< 3 Ğ´Ğ½ĞµĞ¹)
EXPIRED  â€” Ğ¸ÑÑ‚ĞµĞºĞ»Ğ¾ (Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ¿Ğ¸ÑĞ°Ñ‚ÑŒ)
```

**ĞœĞµÑ‚Ğ¾Ğ´Ñ‹ ÑĞµÑ€Ğ²Ğ¸ÑĞ°:**

```typescript
// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ğ¸ Ğ¿Ğ¾ ÑƒÑ€Ğ¾Ğ²Ğ½ÑĞ¼ Ğ°Ğ»ĞµÑ€Ñ‚Ğ¾Ğ²
async getBatchesByAlertLevel(input: {
  sellerId: string
  storageLocationId?: string
}): Promise<{
  normal: Batch[]
  warning: Batch[]
  critical: Batch[]
  expired: Batch[]
}>

// Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°
async generateDailyReport(sellerId: string): Promise<ExpirationReport>

// ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸ÑÑ‚Ñ‘ĞºÑˆĞ¸Ğµ
async blockExpiredBatches(): Promise<number>

// ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ
async autoWriteOffExpired(sellerId: string): Promise<WriteOff[]>
```

**Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°:**

```typescript
interface ExpirationReport {
  date: Date
  seller: ObjectId
  
  summary: {
    totalBatches: number
    normalCount: number
    warningCount: number
    criticalCount: number
    expiredCount: number
  }
  
  // Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ¿Ğ¾ ÑƒÑ€Ğ¾Ğ²Ğ½ÑĞ¼
  warning: BatchAlertInfo[]
  critical: BatchAlertInfo[]
  expired: BatchAlertInfo[]
  
  // Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
  recommendations: string[]
}

interface BatchAlertInfo {
  batch: ObjectId
  productName: string
  quantity: number
  location: string
  effectiveExpirationDate: Date
  daysRemaining: number
  suggestedAction: 'DISCOUNT' | 'URGENT_SALE' | 'WRITE_OFF'
}
```

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°:**

```
ğŸ“Š ĞÑ‚Ñ‡Ñ‘Ñ‚ Ğ¿Ğ¾ ÑÑ€Ğ¾ĞºĞ°Ğ¼ Ğ³Ğ¾Ğ´Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ·Ğ° 05.12.2024
â”œâ”€â”€ ĞŸÑ€Ğ¾Ğ´Ğ°Ğ²ĞµÑ†: "Ğ¤Ñ€ÑƒĞºÑ‚Ğ¾Ğ²Ğ°Ñ Ğ±Ğ°Ğ·Ğ°"
â”‚
â”œâ”€â”€ ğŸ“ˆ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ğ¹: 45
â”‚   â”œâ”€â”€ ğŸŸ¢ Ğ’ Ğ½Ğ¾Ñ€Ğ¼Ğµ: 32
â”‚   â”œâ”€â”€ ğŸŸ¡ Ğ’Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ: 8
â”‚   â”œâ”€â”€ ğŸ”´ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾: 4
â”‚   â””â”€â”€ â›” Ğ˜ÑÑ‚ĞµĞºĞ»Ğ¾: 1
â”‚
â”œâ”€â”€ ğŸŸ¡ Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ• (3-7 Ğ´Ğ½ĞµĞ¹):
â”‚   â”œâ”€â”€ ĞšĞ»ÑƒĞ±Ğ½Ğ¸ĞºĞ° (P-015): 5 ĞºĞ³, Ğ´Ğ¾ 10.12 (5 Ğ´Ğ½ĞµĞ¹)
â”‚   â”œâ”€â”€ Ğ¢Ğ²Ğ¾Ñ€Ğ¾Ğ³ (P-022): 3 ĞºĞ³, Ğ´Ğ¾ 09.12 (4 Ğ´Ğ½Ñ)
â”‚   â””â”€â”€ ...ĞµÑ‰Ñ‘ 6 Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹
â”‚
â”œâ”€â”€ ğŸ”´ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ (< 3 Ğ´Ğ½ĞµĞ¹):
â”‚   â”œâ”€â”€ ĞœĞ°Ğ»Ğ¸Ğ½Ğ° (P-018): 2 ĞºĞ³, Ğ´Ğ¾ 07.12 (2 Ğ´Ğ½Ñ) âœ Ğ¡ĞºĞ¸Ğ´ĞºĞ° 30%?
â”‚   â”œâ”€â”€ Ğ™Ğ¾Ğ³ÑƒÑ€Ñ‚ (P-025): 10 ÑˆÑ‚, Ğ´Ğ¾ 06.12 (1 Ğ´ĞµĞ½ÑŒ) âœ Ğ¡ĞºĞ¸Ğ´ĞºĞ° 50%?
â”‚   â””â”€â”€ ...ĞµÑ‰Ñ‘ 2 Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸
â”‚
â”œâ”€â”€ â›” Ğ˜Ğ¡Ğ¢Ğ•ĞšĞ›Ğ:
â”‚   â””â”€â”€ Ğ¡Ğ°Ğ»Ğ°Ñ‚ (P-011): 1.5 ĞºĞ³, Ğ¸ÑÑ‚Ñ‘Ğº 04.12 âœ Ğ¡ĞŸĞ˜Ğ¡ĞĞ¢Ğ¬
â”‚
â””â”€â”€ ğŸ’¡ Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸:
    â”œâ”€â”€ ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ÑĞºĞ¸Ğ´ĞºÑƒ 30% Ğ½Ğ° 4 ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸
    â”œâ”€â”€ Ğ¡Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ 1 Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ (ÑĞ°Ğ»Ğ°Ñ‚)
    â””â”€â”€ ĞŸĞµÑ€ĞµĞ¼ĞµÑÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ»ÑƒĞ±Ğ½Ğ¸ĞºÑƒ Ğ² Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ¸Ğ»ÑŒĞ½Ğ¸Ğº
```

**Cron-Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸:**

```typescript
// ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² 06:00
@Cron('0 6 * * *')
async checkExpirations() {
  // 1. Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ Ğ¸ÑÑ‚Ñ‘ĞºÑˆĞ¸Ğµ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ğ¸
  await this.expirationAlerts.blockExpiredBatches()
  
  // 2. Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ²Ñ†Ğ¾Ğ²
  const sellers = await this.sellerModel.find({ status: 'ACTIVE' })
  for (const seller of sellers) {
    const report = await this.expirationAlerts.generateDailyReport(seller._id)
    
    // 3. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Telegram
    if (report.critical.length > 0 || report.expired.length > 0) {
      await this.notificationPort.sendTelegram(seller.telegramId, report)
    }
  }
}
```

---

## Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¿Ğ¾ÑĞ»Ğµ Ğ¤Ğ°Ğ·Ñ‹ 4

```
src/modules/new-inventory/
â”œâ”€â”€ core/                    # Ğ˜Ğ· Ğ¤Ğ°Ğ·Ñ‹ 1
â”œâ”€â”€ entities/                # Ğ˜Ğ· Ğ¤Ğ°Ğ·Ñ‹ 1
â”œâ”€â”€ batch/                   # Ğ˜Ğ· Ğ¤Ğ°Ğ·Ñ‹ 2
â”œâ”€â”€ movement/                # Ğ˜Ğ· Ğ¤Ğ°Ğ·Ñ‹ 3
â”œâ”€â”€ reservation/             # Ğ˜Ğ· Ğ¤Ğ°Ğ·Ñ‹ 3
â”‚
â”œâ”€â”€ operations/
â”‚   â”œâ”€â”€ receiving/           # Ğ˜Ğ· Ğ¤Ğ°Ğ·Ñ‹ 3
â”‚   â”œâ”€â”€ transfer/            # Ğ˜Ğ· Ğ¤Ğ°Ğ·Ñ‹ 3
â”‚   â”œâ”€â”€ write-off/           # Ğ˜Ğ· Ğ¤Ğ°Ğ·Ñ‹ 3
â”‚   â”‚
â”‚   â””â”€â”€ audit/               # ĞĞĞ’ĞĞ•
â”‚       â”œâ”€â”€ audit.schema.ts
â”‚       â”œâ”€â”€ audit.enums.ts
â”‚       â”œâ”€â”€ audit.commands.ts
â”‚       â”œâ”€â”€ audit.queries.ts
â”‚       â”œâ”€â”€ audit.port.ts
â”‚       â”œâ”€â”€ audit.service.ts
â”‚       â”œâ”€â”€ audit.module.ts
â”‚       â””â”€â”€ index.ts
â”‚
â””â”€â”€ alerts/                  # ĞĞĞ’ĞĞ•
    â”œâ”€â”€ expiration-alert.service.ts
    â”œâ”€â”€ expiration-alert.types.ts
    â”œâ”€â”€ expiration-alert.module.ts
    â””â”€â”€ index.ts
```

---

## Ğ§ĞµĞº-Ğ»Ğ¸ÑÑ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸

- [ ] Audit â€” ÑÑ…ĞµĞ¼Ğ° Ñ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼Ğ¸ Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
- [ ] Audit â€” workflow DRAFT â†’ IN_PROGRESS â†’ COMPLETED
- [ ] Audit â€” Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ñ… Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¾Ğ²
- [ ] Audit â€” ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¾Ğ² Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğ¸
- [ ] Audit â€” Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ ÑĞ¼ĞµÑˆĞ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ğ¹
- [ ] Alerts â€” getBatchesByAlertLevel
- [ ] Alerts â€” generateDailyReport
- [ ] Alerts â€” blockExpiredBatches
- [ ] Alerts â€” cron-Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
- [ ] Alerts â€” Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸ÑĞ¼Ğ¸ (Telegram)

---

## Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¤Ğ°Ğ·Ñ‹ 4

ĞŸĞ¾ÑĞ»Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾:
1. ĞŸÑ€Ğ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ, Ñ‡Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½ÑƒÑ, ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒĞ½ÑƒÑ)
2. ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¸ Ğ¿Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°Ğ¼
3. Ğ’Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹ Ğ¿Ğ¾ ÑÑ€Ğ¾ĞºĞ°Ğ¼ Ğ³Ğ¾Ğ´Ğ½Ğ¾ÑÑ‚Ğ¸
4. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ÑŒ ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹ Ğ² Telegram
5. ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸ÑÑ‚Ñ‘ĞºÑˆĞ¸Ğµ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ğ¸
