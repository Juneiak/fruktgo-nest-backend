# New Inventory System — План реализации

> **Цель:** Создать полноценную складскую систему для учёта товаров, партий, остатков, движений и операций.

---

## Архитектура

```
src/modules/new-inventory/
│
├── core/                        # Ядро расчётов
│   ├── storage-preset/          # Пресеты коэффициентов (BERRIES, CITRUS...)
│   ├── storage-conditions/      # Условия хранения
│   └── shelf-life-calculator/   # Расчёт сроков годности
│
├── entities/                    # Базовые сущности
│   ├── product-template/        # ProductTemplate (замена Product)
│   ├── storage-location/        # StorageLocation (склад/магазин)
│   ├── storefront/              # Storefront (витрина магазина)
│   └── storefront-product/      # StorefrontProduct (товар на витрине)
│
├── batch/                       # Партии товара
│   ├── batch/                   # Batch (партия)
│   ├── batch-location/          # BatchLocation (остаток в локации)
│   └── mixed-batch/             # MixedBatch (смешанная партия)
│
├── operations/                  # Операции
│   ├── receiving/               # Приёмка
│   ├── transfer/                # Перемещение
│   ├── write-off/               # Списание
│   ├── return/                  # Возвраты
│   └── audit/                   # Инвентаризация
│
├── movement/                    # История движений
├── reservation/                 # Резервирование
├── alerts/                      # Алерты по срокам
│
└── orchestrator/                # Координация всех операций
```

---

## Фазы реализации

| Фаза | Содержание | Дни | Документ |
|------|------------|-----|----------|
| **1** | Базовые сущности + Ядро | 4-5 | [phase-1.md](./phases/phase-1.md) |
| **2** | Партии + Смешивание | 4-5 | [phase-2.md](./phases/phase-2.md) |
| **3** | Операции + История | 6-8 | [phase-3.md](./phases/phase-3.md) |
| **4** | Инвентаризация + Алерты | 2-3 | [phase-4.md](./phases/phase-4.md) |
| **5** | Возвраты | 2-3 | [phase-5.md](./phases/phase-5.md) |
| **6** | Ценообразование | 2-3 | [phase-6.md](./phases/phase-6.md) |
| **7** | Оркестратор | 3-4 | [phase-7.md](./phases/phase-7.md) |
| **Итого** | | **23-31 дней** | |

---

## Как фазы объединяются в рабочую систему

### Схема зависимостей

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ФАЗА 1: ФУНДАМЕНТ                                │
│  ProductTemplate ─── StorageLocation ─── Storefront ─── StorefrontProduct│
│                            │                                             │
│                    ShelfLifeCalculator                                   │
└────────────────────────────┼─────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    ФАЗА 2: ПАРТИИ И ОСТАТКИ                              │
│                                                                          │
│     Batch ◄──────────► BatchLocation ◄──────────► MixedBatch            │
│       │                     │                                            │
│  (хранит сроки)    (хранит остатки)     (объединённые партии)           │
└─────────────────────────────┼────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│               ФАЗА 3: ОПЕРАЦИИ + ИСТОРИЯ                                 │
│                                                                          │
│  Receiving ──► Batch          Transfer ──► BatchLocation                 │
│      │                            │                                      │
│      └──────────► Movement ◄──────┘                                      │
│                      ▲                                                   │
│      WriteOff ───────┘         Reservation                               │
└─────────────────────────────────┼────────────────────────────────────────┘
                                  │
                   ┌──────────────┴──────────────┐
                   ▼                              ▼
┌───────────────────────────┐    ┌───────────────────────────┐
│   ФАЗА 4: ИНВЕНТАРИЗАЦИЯ  │    │   ФАЗА 5: ВОЗВРАТЫ        │
│                           │    │                           │
│   Audit ──► BatchLocation │    │   Return ──► Batch        │
│     │                     │    │     │                     │
│     └──► Movement         │    │     └──► Movement         │
└───────────────────────────┘    └───────────────────────────┘
                   │                              │
                   └──────────────┬──────────────┘
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    ФАЗА 6: ЦЕНООБРАЗОВАНИЕ                               │
│                                                                          │
│           StorefrontProduct.pricing ◄─── Batch.purchasePrice            │
│                      │                                                   │
│              (онлайн/офлайн цены, скидки, опт)                          │
└─────────────────────────────────┼────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    ФАЗА 7: ОРКЕСТРАТОР                                   │
│                                                                          │
│                    InventoryOrchestrator                                 │
│                           │                                              │
│     ┌─────────┬──────────┼──────────┬─────────┬─────────┐               │
│     ▼         ▼          ▼          ▼         ▼         ▼               │
│  Receiving Transfer  WriteOff   Return    Audit    Reservation          │
│                                                                          │
│  Координирует ВСЕ операции, обеспечивает транзакции                      │
└─────────────────────────────────────────────────────────────────────────┘
```

### Как сущности связаны между собой

```
┌────────────────┐         ┌────────────────┐
│ ProductTemplate│◄────────│     Batch      │
│                │         │                │
│ (что за товар) │         │ (конкретная    │
│                │         │  поставка)     │
└───────┬────────┘         └───────┬────────┘
        │                          │
        │                          │
        ▼                          ▼
┌────────────────┐         ┌────────────────┐
│StorefrontProduct│        │ BatchLocation  │
│                │         │                │
│ (товар на      │◄────────│ (сколько партии│
│  витрине)      │         │  в локации)    │
└───────┬────────┘         └───────┬────────┘
        │                          │
        │                          │
        ▼                          ▼
┌────────────────┐         ┌────────────────┐
│   Storefront   │         │StorageLocation │
│                │         │                │
│ (витрина       │◄────────│ (где хранится) │
│  магазина)     │         │                │
└───────┬────────┘         └────────────────┘
        │
        ▼
┌────────────────┐
│      Shop      │
│                │
│ (магазин)      │
└────────────────┘
```

### Порядок создания

1. **Фаза 1** создаёт "скелет" — все базовые сущности, на которые будут ссылаться остальные
2. **Фаза 2** добавляет "мясо" — партии и остатки, без которых нет смысла в операциях
3. **Фаза 3** добавляет "руки" — операции, которые изменяют остатки
4. **Фазы 4-6** — специализированные модули, работающие с уже созданной базой
5. **Фаза 7** — "мозг", который координирует всё

---

## Технические требования

- **MongoDB транзакции** — все операции атомарные
- **Movement** — каждое изменение остатка записывается в историю
- **FEFO** — First Expired, First Out (продаём сначала то, что истекает раньше)
- **Пересчёт сроков** — при перемещении товара срок пересчитывается
- **Приоритет офлайн** — физический покупатель важнее онлайн-резерва

---

## Детальные документы по фазам

- [Фаза 1: Базовые сущности + Ядро](./phases/phase-1.md)
- [Фаза 2: Партии + Смешивание](./phases/phase-2.md)
- [Фаза 3: Операции + История](./phases/phase-3.md)
- [Фаза 4: Инвентаризация + Алерты](./phases/phase-4.md)
- [Фаза 5: Возвраты](./phases/phase-5.md)
- [Фаза 6: Ценообразование](./phases/phase-6.md)
- [Фаза 7: Оркестратор](./phases/phase-7.md)
