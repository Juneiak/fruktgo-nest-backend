# Складской учёт: Как это работает (v2)

> Единый остаток магазина + мягкое резервирование для онлайн-заказов

---

## Содержание

1. [Общая картина](#1-общая-картина)
2. [Локации: Склады и Магазины](#2-локации-склады-и-магазины)
3. [Шаблоны продуктов и условия хранения](#3-шаблоны-продуктов-и-условия-хранения)
4. [Партии товара и динамический срок годности](#4-партии-товара-и-динамический-срок-годности)
5. [Смешивание партий (Автоматическая консолидация)](#5-смешивание-партий-автоматическая-консолидация)
6. [Ценообразование](#6-ценообразование)
7. [Единый остаток магазина](#7-единый-остаток-магазина)
8. [Мягкое резервирование + офлайн-заказ](#8-мягкое-резервирование)
9. [Конфликт онлайн/офлайн (приоритет офлайн)](#9-конфликт-онлайнофлайн)
10. [Приёмка товара](#10-приёмка-товара)
11. [Перемещения между локациями](#11-перемещения-между-локациями)
12. [Возвраты товара](#12-возвраты-товара)
13. [Списания + Усушка](#13-списания)
14. [Инвентаризация](#14-инвентаризация)
15. [Сроки годности и алерты](#15-сроки-годности-и-алерты)
16. [Роли и доступ](#16-роли-и-доступ)
17. [Сценарии из жизни](#17-сценарии-из-жизни)

---

## 1. Общая картина

### Структура продавца

```
Продавец "Фруктовая база"
│
├── 📦 Центральный склад
│   └── Остаток: яблоки 500 кг, груши 200 кг, ...
│
├── 📦 Склад-холодильник (для ягод)
│   └── Остаток: клубника 50 кг, малина 30 кг, ...
│
├── 🏪 Магазин на Ленина
│   └── Единый остаток: яблоки 80 кг, груши 40 кг, ...
│       (подсобка + витрина = один пул)
│
├── 🏪 Магазин на Пушкина
│   └── Единый остаток: яблоки 60 кг, груши 25 кг, ...
│
└── 🏪 Магазин на рынке (только офлайн)
    └── Единый остаток: яблоки 40 кг, груши 20 кг, ...
```

### Принцип

- **Склад** — хранилище, откуда товар развозится по магазинам
- **Магазин** — точка продаж с единым остатком (подсобка + витрина не разделяются учётно)
- **Онлайн и офлайн** — конкурируют за один остаток, но онлайн резервирует

---

## 2. Локации: Склады и Магазины

### Два типа локаций

| Тип | Назначение | Особенности |
|-----|------------|-------------|
| **WAREHOUSE** | Хранение запасов | Нет прямых продаж, только приёмка и отгрузка в магазины |
| **SHOP** | Продажи (онлайн + офлайн) | Единый остаток, резервирование под заказы |

### Почему не разделяем витрину и подсобку?

**Реальность работы магазина:**
- Клиент (онлайн или офлайн) может взять товар и с витрины, и из подсобки
- Сотрудник выносит из подсобки, если на витрине не хватает
- Учётное разделение создаёт лишнюю работу без пользы

**Физическое расположение ≠ учётное разделение:**
- Подсобка и витрина — это где товар лежит физически
- Система видит общий остаток магазина

---

## 3. Шаблоны продуктов и условия хранения

### Что такое шаблон продукта

Шаблон — это "карточка товара" с характеристиками и требованиями к хранению.

### Типы товаров (Тип → определяет доступные категории)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ТИПЫ ТОВАРОВ (ProductType → Categories)               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  🥬 PERISHABLE (скоропортящийся)                                        │
│     Категории: фрукты, овощи, ягоды, зелень, грибы, яйца                │
│     → Управление свежестью: ДА (если включено)                          │
│     → Динамический срок годности                                        │
│                                                                         │
│  🥫 SHELF_STABLE (длительного хранения)                                 │
│     Категории: консервы, крупы, макароны, мёд, орехи, сухофрукты, масла │
│     → Управление свежестью: НЕТ                                         │
│     → Статический срок годности (от производителя)                      │
│                                                                         │
│  ❄️ FROZEN (замороженный)                                               │
│     Категории: замороженные овощи/фрукты/ягоды, мороженое, полуфабрикаты│
│     → Управление свежестью: ОПЦИОНАЛЬНО                                 │
│     → Критично поддержание температуры                                  │
│                                                                         │
│  🍞 BAKERY (выпечка)                                                    │
│     Категории: хлеб, выпечка, торты, печенье                            │
│     → Управление свежестью: ДА                                          │
│     → Специфичные поля: тип теста, начинка, аллергены                   │
│                                                                         │
│  🥩 MEAT (мясо/птица)                                                   │
│     Категории: говядина, свинина, баранина, курица, индейка, субпродукты│
│     → Управление свежестью: ДА                                          │
│     → Специфичные поля: тип мяса, халяль/кошер, часть туши              │
│                                                                         │
│  🐟 SEAFOOD (рыба/морепродукты)                                         │
│     Категории: рыба, моллюски, ракообразные                             │
│     → Управление свежестью: ДА                                          │
│     → Специфичные поля: способ добычи, регион вылова                    │
│                                                                         │
│  🥛 DAIRY (молочные продукты)                                           │
│     Категории: молоко, сыры, йогурты, масло, сливки                     │
│     → Управление свежестью: ДА                                          │
│     → Специфичные поля: жирность, лактоза, пастеризация                 │
│                                                                         │
│  🧃 BEVERAGES (напитки)                                                 │
│     Категории: соки, вода, газировки, свежевыжатые                      │
│     → Управление свежестью: ЗАВИСИТ ОТ ТИПА                             │
│                                                                         │
│  📦 NON_FOOD (непищевые)                                                │
│     Категории: упаковка, посуда, аксессуары                             │
│     → Управление свежестью: НЕТ                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### КБЖУ и единицы измерения

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           КБЖУ (NutritionInfo)                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  На 100г/100мл:                                                         │
│  ├── calories: number      // Калории (ккал)                            │
│  ├── proteins: number      // Белки (г)                                 │
│  ├── fats: number          // Жиры (г)                                  │
│  ├── carbohydrates: number // Углеводы (г)                              │
│  ├── fiber: number         // Клетчатка (г)                             │
│  ├── sugar: number         // Сахар (г)                                 │
│  └── salt: number          // Соль (г)                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                        ЕДИНИЦЫ ИЗМЕРЕНИЯ (MeasuringScale)                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  PIECE       // Штуки                                                   │
│  KILOGRAM    // Килограммы                                              │
│  GRAM        // Граммы                                                  │
│  LITER       // Литры                                                   │
│  MILLILITER  // Миллилитры                                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 📸 Живые фотографии витринных товаров

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      ЖИВЫЕ ФОТОГРАФИИ (LivePhoto)                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Цель:                                                                  │
│  • Показать клиенту РЕАЛЬНЫЙ товар, который он получит                  │
│  • Повысить доверие к качеству продукции                                │
│  • Отличие от конкурентов (у них только студийные фото)                 │
│                                                                         │
│  Правила:                                                               │
│  • Делаются регулярно (ежедневно или при новых поступлениях)            │
│  • Указывается дата съёмки                                              │
│  • Видно реальное состояние товара                                      │
│  • Несколько фото (витрина, крупный план, в упаковке)                   │
│                                                                         │
│  Поля LivePhoto:                                                        │
│  ├── image: ObjectId        // Ссылка на Image                          │
│  ├── takenAt: Date          // Дата съёмки                              │
│  ├── takenBy: ObjectId      // Кто сделал фото (Employee/Seller)        │
│  ├── caption: string        // Описание (опционально)                   │
│  ├── isActive: boolean      // Показывается клиентам                    │
│  └── order: number          // Порядок отображения                      │
│                                                                         │
│  В StorefrontProduct:                                                   │
│  ├── livePhotos: LivePhoto[]                                            │
│  ├── photosLastUpdatedAt: Date                                          │
│  └── needsPhotoUpdate: boolean  // Напоминание обновить фото            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Собственное производство (Homemade)

Магазины могут создавать товары собственного производства:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    СОБСТВЕННОЕ ПРОИЗВОДСТВО                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Примеры:                                                               │
│  • Фруктовый коктейль/смузи                                             │
│  • Подарочная корзина                                                   │
│  • Нарезка фруктов                                                      │
│  • Свежевыжатый сок                                                     │
│  • Фруктовый салат                                                      │
│  • Букет из фруктов                                                     │
│                                                                         │
│  Поля для homemade товаров:                                             │
│  ├── isHomemade: true                                                   │
│  ├── recipe: "Описание рецепта"                                         │
│  ├── ingredients: [{ product, quantity }] — состав из других товаров    │
│  ├── preparationTime: 15 (минут на приготовление)                       │
│  ├── shelfLifeAfterPreparation: 4 (часов годности после приготовления)  │
│  ├── requiresPreOrder: true/false (нужен предзаказ?)                    │
│  ├── minOrderQuantity: 1 (мин. количество для заказа)                   │
│  └── canBePreparedInAdvance: false (можно готовить заранее?)            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Управление свежестью как опция (💎 Premium)

```
┌─────────────────────────────────────────────────────────────────────────┐
│              УПРАВЛЕНИЕ СВЕЖЕСТЬЮ — ПЛАТНАЯ ФУНКЦИЯ                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  📊 freshnessManagementEnabled: boolean                                 │
│                                                                         │
│  ВЫКЛЮЧЕНО (бесплатно):                                                 │
│  ├── Только статический срок годности (expirationDate от поставщика)   │
│  ├── Нет пересчёта при перемещении                                      │
│  ├── Нет коэффициентов по условиям хранения                             │
│  └── Базовые алерты по сроку (за N дней до истечения)                   │
│                                                                         │
│  ВКЛЮЧЕНО (Premium):                                                    │
│  ├── Динамический срок годности (effectiveExpirationDate)               │
│  ├── Пересчёт при перемещении между локациями                           │
│  ├── Коэффициенты деградации по температуре/влажности                   │
│  ├── Запас свежести (freshnessRemaining)                                │
│  ├── Умные алерты с учётом реальных условий                             │
│  ├── Рекомендации по размещению                                         │
│  └── Автоскидки по динамическому сроку                                  │
│                                                                         │
│  Настройка на уровне:                                                   │
│  ├── Seller (подписка на функцию)                                       │
│  ├── StorageLocation (включено для конкретной локации)                  │
│  └── ProductTemplate (включено для конкретного товара)                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Полный пример шаблона продукта

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 🍓 Клубника свежая                                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ Категория: Ягоды                                                         │
│ SKU: BERRY-STRAWBERRY-001                                                │
│ Единица: КГ                                                              │
│ Тип: PERISHABLE (скоропорт)                                              │
│                                                                         │
│ 🏭 Производство:                                                         │
│ ├── isHomemade: false                                                    │
│ └── (закупается у поставщиков)                                          │
│                                                                         │
│ 💎 Управление свежестью: ВКЛЮЧЕНО                                        │
│                                                                         │
│ 🌡️ Идеальные условия хранения:                                          │
│ ├── Температура: 0-4°C                                                   │
│ ├── Влажность: 90-95%                                                    │
│ ├── Освещение: Тёмное                                                    │
│ └── Особенности: Не мыть перед хранением                                 │
│                                                                         │
│ ⏱️ Сроки годности:                                                       │
│ ├── При идеальных условиях: 7 дней                                       │
│ ├── При комнатной (18-22°C): 2-3 дня                                     │
│ └── Чувствительность: ВЫСОКАЯ                                            │
│                                                                         │
│ 📊 Пресет: BERRIES                                                       │
│ ├── Холодильник (0-4°C): ×0.4 → до 17 дней                              │
│ ├── Прохлада (10-15°C): ×0.8 → до 9 дней                                │
│ ├── Комната (18-22°C): ×1.5 → до 5 дней                                 │
│ └── Тепло (>25°C): ×3.0 → до 2 дней                                     │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 🥫 Варенье клубничное                                                    │
├─────────────────────────────────────────────────────────────────────────┤
│ Категория: Консервация                                                   │
│ SKU: PRESERVE-STRAWBERRY-001                                             │
│ Единица: ШТ (банка 500г)                                                │
│ Тип: SHELF_STABLE (длительного хранения)                                │
│                                                                         │
│ 💎 Управление свежестью: ВЫКЛЮЧЕНО                                       │
│     (не требуется для консервов)                                        │
│                                                                         │
│ 🌡️ Условия хранения:                                                    │
│ ├── Температура: 5-25°C                                                  │
│ └── Влажность: не критична                                               │
│                                                                         │
│ ⏱️ Срок годности: 24 месяца (статический)                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 🍹 Фруктовый смузи "Тропический"                                         │
├─────────────────────────────────────────────────────────────────────────┤
│ Категория: Напитки                                                       │
│ SKU: HOMEMADE-SMOOTHIE-TROPICAL                                          │
│ Единица: ШТ (стакан 400мл)                                               │
│ Тип: PERISHABLE                                                          │
│                                                                         │
│ 🏭 СОБСТВЕННОЕ ПРОИЗВОДСТВО:                                             │
│ ├── isHomemade: true                                                     │
│ ├── recipe: "Манго + банан + ананас + кокосовое молоко"                 │
│ ├── ingredients:                                                         │
│ │   ├── Манго: 100г                                                      │
│ │   ├── Банан: 80г                                                       │
│ │   ├── Ананас: 70г                                                      │
│ │   └── Кокосовое молоко: 150мл                                          │
│ ├── preparationTime: 5 минут                                             │
│ ├── shelfLifeAfterPreparation: 2 часа                                    │
│ ├── requiresPreOrder: false                                              │
│ └── canBePreparedInAdvance: false                                        │
│                                                                         │
│ 💎 Управление свежестью: ВКЛЮЧЕНО                                        │
│    (критично для свежеприготовленного)                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Расширяемые поля по категориям

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   КАТЕГОРИЙНЫЕ РАСШИРЕНИЯ                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  🍞 BAKERY (выпечка):                                                    │
│  ├── doughType: 'YEAST' | 'PUFF' | 'SHORTCRUST' | 'CHOUX'               │
│  ├── filling: string (начинка)                                          │
│  ├── toppings: string[] (украшения)                                      │
│  ├── allergens: string[] (аллергены)                                     │
│  ├── isGlutenFree: boolean                                               │
│  ├── isVegan: boolean                                                    │
│  └── calories: number (на 100г)                                         │
│                                                                         │
│  🥩 MEAT (мясо):                                                         │
│  ├── meatType: 'BEEF' | 'PORK' | 'LAMB' | 'CHICKEN' | 'TURKEY'          │
│  ├── cut: string (часть туши)                                            │
│  ├── fatContent: number (% жирности)                                     │
│  ├── storageState: 'CHILLED' | 'FROZEN'                                  │
│  ├── origin: string (страна происхождения)                               │
│  └── halal: boolean                                                      │
│                                                                         │
│  🐟 SEAFOOD (морепродукты):                                              │
│  ├── seafoodType: 'FISH' | 'SHELLFISH' | 'CRUSTACEAN'                   │
│  ├── species: string (вид)                                               │
│  ├── catchMethod: 'WILD' | 'FARMED'                                      │
│  ├── catchRegion: string                                                 │
│  ├── storageState: 'FRESH' | 'CHILLED' | 'FROZEN'                       │
│  └── cleaned: boolean (очищено)                                          │
│                                                                         │
│  🥛 DAIRY (молочные):                                                    │
│  ├── fatContent: number (% жирности)                                     │
│  ├── lactoseFree: boolean                                                │
│  └── pasteurized: boolean                                                │
│                                                                         │
│  📦 CUSTOM (произвольные поля):                                          │
│  └── customAttributes: Map<string, any>                                  │
│      Продавец может добавлять свои поля                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Пресеты коэффициентов по категориям

Разные продукты по-разному реагируют на условия хранения. Коэффициент зависит от **двух факторов**: температуры и влажности.

#### Базовые коэффициенты по температуре

| Пресет | Продукты | Холод (0-4°C) | Прохлада (10-15°C) | Комната (18-22°C) | Тепло (>25°C) |
|--------|----------|---------------|-------------------|-------------------|---------------|
| **BERRIES** | Клубника, малина, черника | 0.4 | 0.8 | 1.5 | 3.0 |
| **STONE_FRUITS** | Персики, абрикосы, сливы | 0.5 | 0.7 | 1.2 | 2.5 |
| **CITRUS** | Апельсины, лимоны, мандарины | 0.6 | 0.8 | 1.0 | 1.5 |
| **APPLES_PEARS** | Яблоки, груши | 0.3 | 0.6 | 1.0 | 1.8 |
| **TROPICAL** | Бананы, манго, ананасы | 1.2 | 0.8 | 1.0 | 1.3 |
| **LEAFY_GREENS** | Салат, шпинат, зелень | 0.5 | 1.0 | 2.0 | 4.0 |
| **ROOT_VEGETABLES** | Морковь, свёкла, картофель | 0.2 | 0.4 | 0.8 | 1.5 |
| **TOMATOES** | Томаты | 1.5 | 0.8 | 1.0 | 1.5 |
| **CUCUMBERS** | Огурцы, кабачки | 0.8 | 0.7 | 1.0 | 1.8 |
| **MUSHROOMS** | Грибы | 0.4 | 0.9 | 1.8 | 3.5 |

#### Модификаторы влажности

Влажность влияет на коэффициент **мультипликативно**:

| Пресет | Идеальная влажность | Сухо (<50%) | Нормально (50-70%) | Влажно (70-90%) | Очень влажно (>90%) |
|--------|---------------------|-------------|-------------------|-----------------|---------------------|
| **BERRIES** | 90-95% | ×1.8 | ×1.3 | ×1.0 | ×0.9 |
| **STONE_FRUITS** | 85-90% | ×1.5 | ×1.2 | ×1.0 | ×1.1 |
| **CITRUS** | 85-90% | ×1.3 | ×1.0 | ×0.9 | ×1.2 |
| **APPLES_PEARS** | 90-95% | ×1.4 | ×1.1 | ×1.0 | ×1.0 |
| **TROPICAL** | 85-90% | ×1.6 | ×1.2 | ×1.0 | ×1.1 |
| **LEAFY_GREENS** | 95-100% | ×2.5 | ×1.5 | ×1.1 | ×1.0 |
| **ROOT_VEGETABLES** | 95-98% | ×1.3 | ×1.1 | ×1.0 | ×1.0 |
| **TOMATOES** | 90-95% | ×1.4 | ×1.1 | ×1.0 | ×1.3 |
| **CUCUMBERS** | 95% | ×1.8 | ×1.3 | ×1.0 | ×1.1 |
| **MUSHROOMS** | 85-90% | ×1.2 | ×1.0 | ×0.9 | ×1.5 |

**Особенности:**
- Ягоды и зелень очень страдают от сухости
- Грибы гниют при избыточной влажности
- Цитрусовые плесневеют при высокой влажности

#### Формула расчёта итогового коэффициента

```
Итоговый коэффициент = Kтемп × Kвлаж × Kдополн

Где:
- Kтемп — коэффициент по температуре (из таблицы выше)
- Kвлаж — модификатор влажности (из таблицы выше)
- Kдополн — дополнительные факторы (см. ниже)
```

#### Дополнительные факторы (Kдополн)

| Фактор | Модификатор | Применимость |
|--------|-------------|--------------|
| Прямой солнечный свет | ×1.5 | Все, особенно зелень |
| Рядом с этиленовыми (яблоки, бананы) | ×1.2 | Зелень, огурцы |
| Повреждённая упаковка | ×1.3 | Все |
| Товар уже начал портиться | ×2.0 | Все |
| Контролируемая атмосфера (CA) | ×0.3 | Яблоки, груши |

#### Пример расчёта

```
Клубника в торговом зале магазина:

Условия:
├── Температура: 20°C (комната)
├── Влажность: 55% (сухо для ягод)
└── Освещение: обычное

Расчёт:
├── Kтемп (комната): 1.5
├── Kвлаж (сухо): 1.8
├── Kдополн: 1.0 (нет доп. факторов)
└── Итого: 1.5 × 1.8 × 1.0 = 2.7

Результат:
├── Базовый срок: 7 дней
├── Фактический: 7 ÷ 2.7 = 2.6 дня
└── ⚠️ Клубника испортится за 2-3 дня!

Рекомендация: переместить в холодильник (коэф. ~0.36)
```

#### Нелинейные эффекты

Некоторые комбинации условий дают **нелинейный** эффект:

```
┌─────────────────────────────────────────────────────────────┐
│ КРИТИЧЕСКИЕ КОМБИНАЦИИ (коэффициент резко возрастает)       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 🔴 Ягоды + Тепло + Сухо:                                    │
│    Вместо 3.0 × 1.8 = 5.4 → фактически 8.0                 │
│    (ягоды "спекаются", ускоренное увядание)                │
│                                                             │
│ 🔴 Зелень + Тепло + Сухо:                                   │
│    Вместо 4.0 × 2.5 = 10.0 → фактически 15.0               │
│    (необратимое увядание за часы)                          │
│                                                             │
│ 🔴 Грибы + Тепло + Влажно:                                  │
│    Вместо 3.5 × 1.5 = 5.25 → фактически 10.0               │
│    (бактериальное заражение, плесень)                      │
│                                                             │
│ 🔴 Тропические + Холод + Влажно:                            │
│    Вместо 1.2 × 1.1 = 1.32 → фактически 3.0                │
│    ("холодовой ожог", почернение)                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ ОПТИМАЛЬНЫЕ КОМБИНАЦИИ (коэффициент минимален)              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 🟢 Ягоды + Холод + Высокая влажность:                       │
│    0.4 × 0.9 = 0.36 → срок ×2.8                            │
│                                                             │
│ 🟢 Зелень + Холод + Очень влажно:                           │
│    0.5 × 1.0 = 0.5 → срок ×2.0                             │
│                                                             │
│ 🟢 Яблоки + Холод + CA (контр. атмосфера):                  │
│    0.3 × 1.0 × 0.3 = 0.09 → срок ×11!                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### Таблица критических комбинаций

| Пресет | Критическая комбинация | Множитель |
|--------|------------------------|-----------|
| BERRIES | Тепло + Сухо | ×8.0 |
| LEAFY_GREENS | Тепло + Сухо | ×15.0 |
| MUSHROOMS | Тепло + Очень влажно | ×10.0 |
| TROPICAL | Холод + Влажно | ×3.0 |
| TOMATOES | Холод + Очень влажно | ×4.0 |

**Примечания:**
- Коэффициент < 1.0 — порча замедляется
- Коэффициент = 1.0 — базовая скорость (условия "нормальные")
- Коэффициент > 1.0 — порча ускоряется
- Критические комбинации проверяются отдельно и переопределяют расчёт

### Полный пример шаблона

```
┌─────────────────────────────────────────────────────────────┐
│ 🍓 Клубника свежая                                          │
├─────────────────────────────────────────────────────────────┤
│ Категория: Ягоды                                            │
│ SKU: BERRY-STRAWBERRY-001                                   │
│ Единица: КГ                                                 │
│                                                             │
│ 🌡️ Идеальные условия хранения:                             │
│ ├── Температура: 0-4°C                                      │
│ ├── Влажность: 90-95%                                       │
│ ├── Освещение: Тёмное                                       │
│ └── Особенности: Не мыть перед хранением                    │
│                                                             │
│ ⏱️ Сроки годности:                                          │
│ ├── При идеальных условиях: 7 дней                          │
│ ├── При комнатной (18-22°C): 2-3 дня                        │
│ └── Чувствительность: ВЫСОКАЯ                               │
│                                                             │
│ 📊 Пресет: BERRIES                                          │
│ ├── Холодильник (0-4°C): ×0.4 → до 17 дней                 │
│ ├── Прохлада (10-15°C): ×0.8 → до 9 дней                   │
│ ├── Комната (18-22°C): ×1.5 → до 5 дней                    │
│ └── Тепло (>25°C): ×3.0 → до 2 дней                        │
└─────────────────────────────────────────────────────────────┘
```

### Рекомендации по размещению

На основе шаблона система может рекомендовать локацию:

```
⚠️ Партия #P-089 (Клубника) размещена в "Магазин на Ленина"

Текущие условия: 20°C (комната)
Рекомендуемые: 0-4°C (холодильник)

Влияние на срок:
├── При текущих условиях: 5 дней
└── При рекомендуемых: 17 дней

[Переместить в холодильник] [Оставить здесь]
```

---

## 4. Партии товара и динамический срок годности

### Зачем нужны партии

Яблоки — не просто "яблоки". Это конкретные поставки с разными сроками годности:

```
Магазин на Ленина — Яблоки Голден (всего 80 кг):
│
├── Партия #P-001 (привезли 1 дек, годны до 10 дек): 25 кг
├── Партия #P-002 (привезли 3 дек, годны до 15 дек): 35 кг
└── Партия #P-003 (привезли 5 дек, годны до 20 дек): 20 кг
```

### FEFO — First Expired, First Out

**Правило:** Всегда продаём сначала то, что истекает раньше.

Клиент заказал 30 кг яблок:
1. Берём 25 кг из партии #P-001 (истекает раньше всех)
2. Берём 5 кг из партии #P-002
3. Партия #P-003 остаётся нетронутой

### Партия товара содержит

```
Партия #P-001
├── Шаблон товара: Яблоки Голден
├── Номер партии: 2024-12-01-001
├── Дата производства: 28 ноября
│
├── Сроки годности:
│   ├── Оригинальный (от поставщика): до 10 декабря
│   ├── Расчётный (текущий): до 8 декабря  ← пересчитан
│   └── Запас свежести: 4.2 условных дня
│
├── Поставщик: ООО "Сады Кубани"
├── Закупочная цена: 80 ₽/кг
├── Документ приёмки: #R-001
│
└── История локаций:
    ├── 01.12 09:00 → Склад-холодильник (×0.5)
    └── 03.12 14:00 → Магазин на Ленина (×1.3)
```

### Динамический срок годности

Срок годности **пересчитывается** при перемещении товара между локациями с разными условиями хранения.

**Пример: Клубника путешествует**

```
День 1 (01.12): Приёмка на склад-холодильник
├── Поставщик указал: годна 7 дней (до 08.12)
├── Запас свежести: 7.0 условных дней
├── Локация: Склад-холодильник (коэф. 0.4)
└── Расчётный срок: 7 ÷ 0.4 = 17.5 дней → до 18.12

День 4 (04.12): Перемещение в магазин
├── В холодильнике провела: 3 дня
├── Потрачено свежести: 3 × 0.4 = 1.2 условных дня
├── Осталось свежести: 7.0 - 1.2 = 5.8 условных дней
├── Локация: Магазин на Ленина (коэф. 1.3)
└── Расчётный срок: 5.8 ÷ 1.3 = 4.5 дня → до 08.12

День 6 (06.12): Проверка статуса
├── В магазине провела: 2 дня
├── Потрачено свежести: 2 × 1.3 = 2.6 условных дня
├── Осталось свежести: 5.8 - 2.6 = 3.2 условных дня
├── Расчётный срок: 3.2 ÷ 1.3 = 2.5 дня → до 08.12
└── Статус: 🔴 CRITICAL (< 3 дней)
```

**Визуализация:**

```
Свежесть клубники (7 условных дней):

         Склад-холодильник          Магазин
         (×0.4 — медленно)    (×1.3 — быстро)
                │                    │
День 1:  ████████████████░░░░  →     │
         7.0 дней                    │
                │                    │
День 4:  ███████████████░░░░░  →  ███████████░░░░░░░░░
         (потрачено 1.2)          5.8 дней
                                     │
День 6:                           █████████░░░░░░░░░░░
                                  3.2 дня (CRITICAL!)
```

### Формула пересчёта

При перемещении из локации A в локацию B:

```
1. Время в старой локации = сейчас - дата_прибытия
2. Потрачено свежести = время × коэффициент_A
3. Осталось свежести = запас - потрачено
4. Новый срок = сейчас + (осталось ÷ коэффициент_B)
```

---

## 5. Смешивание партий (Автоматическая консолидация)

### ⚠️ Упрощение MVP

**MixedBatch НЕ создаётся пользователем вручную.**

В реальности продавец не будет взвешивать каждую коробку и создавать документ смешивания. Вместо этого:

### Когда создаётся MixedBatch

```
┌─────────────────────────────────────────────────────────────┐
│               АВТОМАТИЧЕСКОЕ СМЕШИВАНИЕ                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1️⃣ ПРИ ИНВЕНТАРИЗАЦИИ:                                    │
│     Сотрудник находит смешанный товар в одном ящике        │
│     → Система спрашивает: "Создать смешанную партию?"      │
│     → Да → MixedBatch                                       │
│                                                             │
│  2️⃣ АВТОКОНСОЛИДАЦИЯ (cron):                              │
│     Раз в день система находит мелкие остатки (<1 кг)      │
│     одного товара в одной локации                          │
│     → Предлагает менеджеру консолидировать                 │
│     → Менеджер подтверждает → MixedBatch                   │
│                                                             │
│  3️⃣ ПРИ СПИСАНИИ ЧАСТИ ПАРТИИ:                            │
│     Списали порченное, остаток < minQuantity               │
│     → Автоматическое объединение с другими остатками       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Что НЕ делаем

- ❌ Не требуем от продавца взвешивать каждую коробку
- ❌ Не блокируем продажи, если партии "виртуально разделены"
- ❌ Не создаём сложные формы для ручного смешивания

### Правила расчёта MixedBatch

| Параметр | Правило расчёта |
|----------|-----------------|
| **Срок годности** | Минимальный из источников |
| **Свежесть** | Средневзвешенная: Σ(freshness × qty) / Σ(qty) |
| **Закупочная цена** | Средневзвешенная: Σ(price × qty) / Σ(qty) |
| **Количество** | Сумма всех источников |

### Трассируемость

Состав MixedBatch всегда сохраняется для аудита:
- Откуда взялся товар
- Сколько от каждой партии
- Когда было смешивание

---

## 6. Ценообразование

### Модель цен

```
┌─────────────────────────────────────────────────────────────┐
│                    СТРУКТУРА ЦЕН                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ProductTemplate (шаблон товара):                           │
│  └── recommendedRetailPrice: 180 ₽/кг (рекомендованная)    │
│                                                             │
│  Партия (Batch):                                            │
│  └── purchasePrice: 80 ₽/кг (закупочная)                   │
│                                                             │
│  Витрина (StorefrontProduct):                              │
│  ├── pricing.purchasePrice: 80 ₽/кг (из последней партии) │
│  ├── pricing.onlinePrice: 150 ₽/кг (для онлайн)           │
│  ├── pricing.offlinePrice: 140 ₽/кг (для офлайн)          │
│  ├── pricing.wholesale: { minQty: 10, price: 120 ₽/кг }   │
│  └── pricing.discount: { type: PERCENT, value: 20 }       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Типы цен

| Тип | Где хранится | Назначение |
|-----|--------------|------------|
| **Рекомендованная** | ProductTemplate | Справочная цена от поставщика/бренда |
| **Закупочная** | Batch → StorefrontProduct | Цена покупки партии, для расчёта маржи |
| **Онлайн** | StorefrontProduct.pricing | Цена в приложении/на сайте |
| **Офлайн** | StorefrontProduct.pricing | Цена на кассе (может отличаться) |
| **Оптовая** | StorefrontProduct.pricing.wholesale | Цена при покупке от N единиц |

### Расчёт финальной цены

```typescript
function calculateFinalPrice(product, quantity, channel) {
  let price = channel === 'online' 
    ? product.pricing.onlinePrice 
    : (product.pricing.offlinePrice ?? product.pricing.onlinePrice);
  
  // Оптовая цена
  if (product.pricing.wholesale && quantity >= product.pricing.wholesale.minQuantity) {
    price = product.pricing.wholesale.price;
  }
  
  // Скидка
  if (product.pricing.discount && isDiscountActive(product.pricing.discount)) {
    if (product.pricing.discount.type === 'PERCENT') {
      price = price * (1 - product.pricing.discount.value / 100);
    } else {
      price = Math.max(0, price - product.pricing.discount.value);
    }
  }
  
  return price * quantity;
}
```

### Скидки

```
┌─────────────────────────────────────────────────────────────┐
│                      ТИПЫ СКИДОК                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  PERCENT (процентная):                                      │
│  └── Цена 150₽, скидка 20% → 150 × 0.8 = 120₽              │
│                                                             │
│  FIXED (фиксированная):                                     │
│  └── Цена 150₽, скидка 30₽ → 150 - 30 = 120₽               │
│                                                             │
└─────────────────────────────────────────────────────────────┘

Причины скидок:
├── EXPIRING_SOON — скоро истекает срок
├── RETURNED_ITEM — возвращённый товар
├── PROMOTION — акция
├── CLEARANCE — распродажа
├── DAMAGED — повреждённая упаковка
├── LOYALTY — программа лояльности
└── MANUAL — ручная скидка менеджера
```

### Автоскидки по сроку годности

**⚠️ ТОЛЬКО ДЛЯ ОНЛАЙН-ЦЕНЫ!**

Офлайн-цена НЕ меняется автоматически (требует смены ценников в магазине).

```
┌─────────────────────────────────────────────────────────────┐
│       ПРАВИЛА АВТОМАТИЧЕСКИХ СКИДОК (ТОЛЬКО ОНЛАЙН)         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📅 Дней до истечения    →    📉 Скидка (onlinePrice)       │
│  ─────────────────────────────────────────                  │
│  7 дней                   →    10%                          │
│  5 дней                   →    20%                          │
│  3 дня                    →    30%                          │
│  1 день                   →    50%                          │
│                                                             │
│  ⚠️ offlinePrice НЕ меняется автоматически!                │
│  Для офлайн — ручная смена ценников менеджером.            │
│                                                             │
│  Cron-задача проверяет сроки ежедневно в 06:00.            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Маржинальность

```
Маржа = (Цена продажи - Закупочная цена) / Цена продажи × 100%

Пример:
├── Закупочная: 80 ₽/кг
├── Продажная: 150 ₽/кг
└── Маржа: (150 - 80) / 150 = 46.7%

Рекомендации:
├── Минимальная маржа: 20% (иначе предупреждение)
├── Целевая маржа: 30-50% (зависит от категории)
└── При марже < 10% — блокировка или требование подтверждения
```

### Разные цены для каналов

```
┌─────────────────────────────────────────────────────────────┐
│  Товар: Яблоки Голден                                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Закупочная цена: 80 ₽/кг                                   │
│                                                             │
│  📱 Онлайн (в приложении):                                  │
│  └── Цена: 150 ₽/кг (маржа 46.7%)                          │
│      Почему выше: включены расходы на сборку/доставку      │
│                                                             │
│  🏪 Офлайн (на кассе):                                      │
│  └── Цена: 140 ₽/кг (маржа 42.9%)                          │
│      Почему ниже: нет расходов на логистику                │
│                                                             │
│  📦 Оптом (от 10 кг):                                       │
│  └── Цена: 120 ₽/кг (маржа 33.3%)                          │
│      Почему ниже: большой объём, лояльность                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. Единый остаток магазина

### Структура остатка

```
Магазин на Ленина — Яблоки Голден
│
├── Всего: 80 кг (физически в магазине)
├── Зарезервировано: 12 кг (под онлайн-заказы)
└── Доступно: 68 кг (можно продать)
```

**Что видят разные участники:**

| Кто | Что видит |
|-----|-----------|
| Онлайн-клиент в приложении | "В наличии: 68 кг" (доступно) |
| Сотрудник на кассе | "Всего: 80 кг, Резерв: 12 кг, Свободно: 68 кг" |
| Менеджер | Полная картина по партиям с датами |

### Детализация по партиям

```
Яблоки Голден — 80 кг
│
├── Партия #P-001 (до 10 дек): всего 25 кг
│   ├── Зарезервировано: 10 кг (заказ #1234)
│   └── Доступно: 15 кг
│
├── Партия #P-002 (до 15 дек): всего 35 кг
│   ├── Зарезервировано: 2 кг (заказ #1235)
│   └── Доступно: 33 кг
│
└── Партия #P-003 (до 20 дек): всего 20 кг
    ├── Зарезервировано: 0 кг
    └── Доступно: 20 кг

Итого: 80 кг, резерв 12 кг, доступно 68 кг
```

---

## 6. Мягкое резервирование

### Что значит "мягкое"

Резерв — это **приоритет**, а не жёсткая блокировка.

- Зарезервированный товар предназначен для конкретного заказа
- Но физически он не заперт в сейфе
- Сотрудник может продать его офлайн (с предупреждением!)

### Почему не жёсткое?

**Жёсткое резервирование** создаёт проблемы:
- Клиент заказал, но не пришёл/отменил → товар простаивал
- Онлайн-заказы "съедают" остаток, офлайн-покупатели уходят
- Нужна сложная логика блокировки/разблокировки

**Мягкое резервирование** — компромисс:
- Онлайн-заказ имеет приоритет (товар "обещан")
- Но если офлайн-покупатель забрал — решаем проблему
- Меньше простоев, выше оборот

### Как работает

```
Состояние остатка:
├── Всего: 50 кг
├── Резерв: 8 кг (заказы #1234, #1235)
└── Доступно: 42 кг

Офлайн-покупатель хочет 45 кг:
├── Доступно только 42 кг
├── Чтобы продать 45 кг — нужно "залезть" в резерв
└── Система предупредит: "⚠️ 3 кг из резерва заказа #1234"
```

---

## 7. Онлайн-заказ: полный цикл

### Шаг 1: Клиент смотрит каталог

```
┌────────────────────────────────┐
│ 🍎 Яблоки Голден               │
│ 150 ₽/кг                       │
│ В наличии: 68 кг               │  ← показываем "доступно"
│ [+ Добавить в корзину]         │
└────────────────────────────────┘
```

### Шаг 2: Добавление в корзину

- Товар добавлен, но **ещё не зарезервирован**
- Клиент может думать, редактировать корзину
- Другие клиенты тоже видят 68 кг

### Шаг 3: Оформление заказа

```
Клиент нажал "Оформить заказ" на 5 кг яблок

1. Система проверяет: доступно 68 кг ≥ 5 кг ✓
2. Создаёт резерв:
   ├── Партия #P-001 (истекает раньше): резерв 5 кг
   └── Заказ #1236: яблоки 5 кг, резерв до 15:30
3. Обновляет остаток:
   ├── Всего: 80 кг
   ├── Резерв: 17 кг (+5)
   └── Доступно: 63 кг (-5)
```

### Шаг 4: Сборка заказа

Сборщик видит в системе:
```
Заказ #1236
├── Яблоки Голден: 5 кг
│   └── Партия #P-001 (до 10 дек) — полка 3
├── Груши: 2 кг
│   └── Партия #P-045 (до 12 дек) — холодильник
└── [Начать сборку]
```

**При сборке:**
- Сборщик взвешивает: фактически 4.8 кг (а не 5)
- Вводит реальный вес
- Система пересчитает сумму заказа

### Шаг 5: Завершение сборки

```
Сборщик подтвердил сборку:

1. Резерв → Продажа
2. Остаток уменьшается на фактический вес (4.8 кг)
3. Неиспользованный резерв (0.2 кг) возвращается в "доступно"
4. Заказ готов к выдаче/доставке
```

### Шаг 6: Отмена заказа (если случилась)

```
Клиент отменил заказ:

1. Резерв снимается
2. Товар возвращается в "доступно"
3. Партии остаются нетронутыми
```

---

## 8. Офлайн-продажа

### Обычная продажа

Покупатель в зале взял 3 кг яблок, платит на кассе.

```
Кассир:
1. Выбирает "Яблоки Голден"
2. Вводит вес: 3 кг
3. Система списывает из "доступно" (FEFO):
   └── Партия #P-001: -3 кг (истекает раньше)
4. Печатает чек
```

### Продажа с выносом из подсобки

Покупатель хочет 10 кг, на витрине только 5 кг.

```
Сотрудник:
1. Выносит 5 кг из подсобки
2. На кассе оформляет продажу 10 кг
3. Система списывает как обычно (ей неважно, откуда физически)
```

**Важно:** Учётно это одна операция. Перекладывание товара внутри магазина не требует оформления.

---

## 9. Конфликт онлайн/офлайн

### ⚠️ Ключевое правило: ПРИОРИТЕТ ОФЛАЙН-ПОКУПАТЕЛЯ

**Если заказ ещё НЕ собран** — физический покупатель на кассе имеет приоритет.

Причина: покупатель стоит с товаром в руках. Отбирать его — плохой клиентский опыт.

```
┌─────────────────────────────────────────────────────────┐
│           ПРИОРИТЕТ ОФЛАЙН-ПОКУПАТЕЛЯ                   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. Покупатель на кассе хочет товар                    │
│  2. Товар зарезервирован для онлайн-заказа             │
│  3. Заказ ЕЩЁ НЕ СОБРАН                                │
│                                                         │
│  → ПРОДАЁМ офлайн-покупателю                           │
│  → Резерв перехватывается                              │
│  → Онлайн-клиенту → уведомление + отмена/замена        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Сценарий: Офлайн хочет зарезервированное

```
Остаток магазина:
├── Всего: 20 кг яблок
├── Резерв: 15 кг (заказ #1234, сборка через 20 мин)
└── Доступно: 5 кг

Офлайн-покупатель хочет 12 кг → нужно 7 кг из резерва.
```

### Что видит кассир

```
┌─────────────────────────────────────────────────────────┐
│ Продажа: Яблоки Голден — 12 кг                          │
├─────────────────────────────────────────────────────────┤
│ ℹ️ ИНФОРМАЦИЯ:                                          │
│                                                         │
│ Доступно без резерва: 5 кг                             │
│ Будет перехвачено из резерва: 7 кг                     │
│                                                         │
│ Затронутые заказы (ещё не собраны):                    │
│ • Заказ #1234 — клиенту отправим уведомление           │
│                                                         │
│ [Продать 12 кг] [Продать только 5 кг]                  │
└─────────────────────────────────────────────────────────┘
```

### Автоматические действия при перехвате резерва

1. **Резерв освобождается** (forceRelease, reason: OFFLINE_PRIORITY)
2. **Онлайн-клиенту** → push-уведомление:
   - "Товар закончился. Предлагаем замену / частичную отмену"
3. **Менеджеру** → алерт в Telegram
4. **Заказ** → статус "NEEDS_ATTENTION"

### Что происходит с онлайн-заказом

```
Заказ #1234 после перехвата:
├── Статус: ⚠️ Требует внимания
├── Яблоки: заказано 15 кг, доступно 8 кг
│
├── Клиенту отправлено:
│   "Часть заказа недоступна. Выберите действие:"
│   ├── [Согласен на 8 кг] — пересчёт суммы
│   ├── [Заменить на Груши]
│   └── [Отменить позицию]
│
└── Если клиент не ответил за 15 мин:
    → Автозамена (если настроено)
    → Или частичная отмена
```

---

## 10. Приёмка товара

### Куда приходит товар

```
Поставщик привёз товар:
├── На склад — если есть центральный склад
└── Сразу в магазин — если прямая поставка
```

### Процесс приёмки

**Шаг 1: Создание документа**

```
Приёмка #R-2024-12-06-001
├── Куда: Центральный склад (или Магазин на Ленина)
├── Поставщик: ООО "Сады Кубани"
├── Статус: ЧЕРНОВИК
│
└── Позиции:
    ├── Яблоки Голден: 100 кг
    │   ├── Срок годности: до 20.12.2024
    │   └── Цена закупки: 80 ₽/кг
    │
    ├── Груши Конференц: 50 кг
    │   ├── Срок годности: до 15.12.2024
    │   └── Цена закупки: 120 ₽/кг
    │
    └── Клубника: 20 кг
        ├── Срок годности: до 10.12.2024
        └── Цена закупки: 350 ₽/кг
```

**Шаг 2: Проверка товара**

Сотрудник проверяет:
- Количество соответствует накладной
- Качество в норме (нет гнили, повреждений)
- Сроки годности приемлемые

Может отредактировать документ (добавить/убрать позиции).

**Шаг 3: Подтверждение**

```
После подтверждения:

1. Создаются партии:
   ├── #P-101: Яблоки Голден, 100 кг, до 20.12
   ├── #P-102: Груши Конференц, 50 кг, до 15.12
   └── #P-103: Клубника, 20 кг, до 10.12

2. Остатки появляются на локации:
   Центральный склад:
   ├── Яблоки: +100 кг
   ├── Груши: +50 кг
   └── Клубника: +20 кг

3. Записывается история движений
```

---

## 11. Перемещения между локациями

### Когда нужно перемещение

- Со склада в магазин (пополнение)
- Между магазинами (перераспределение)
- Из магазина на склад (возврат излишков)

### Процесс перемещения

**Шаг 1: Создание документа**

```
Перемещение #T-2024-12-06-001
├── Откуда: Центральный склад
├── Куда: Магазин на Ленина
├── Статус: ЧЕРНОВИК
│
└── Позиции:
    ├── Партия #P-101 (Яблоки): 30 кг
    └── Партия #P-102 (Груши): 20 кг
```

**Шаг 2: Отправка**

```
Статус: ОТПРАВЛЕНО

Центральный склад:
├── Яблоки: 100 → 70 кг (-30)
└── Груши: 50 → 30 кг (-20)

Товар "в пути" — не на складе, ещё не в магазине.
```

**Шаг 3: Получение**

```
Статус: ПОЛУЧЕНО

Магазин на Ленина:
├── Яблоки: 50 → 80 кг (+30)
└── Груши: 20 → 40 кг (+20)

Партии переехали в новую локацию.
```

### Упрощённый режим (без "в пути")

Для перемещений внутри города можно использовать мгновенное перемещение:
- Создали документ → сразу ПОЛУЧЕНО
- Товар мгновенно переходит из точки А в точку Б

---

## 12. Возвраты товара

### Типы возвратов

| Тип | Источник | Причина | Что происходит с товаром |
|-----|----------|---------|--------------------------|
| **CUSTOMER_RETURN** | Онлайн-клиент | Не понравился, ошибка, повреждён | Оценка → возврат на полку / списание |
| **DELIVERY_RETURN** | Курьер | Клиент не принял, не было дома | Оценка → возврат на полку / списание |
| **SUPPLIER_RETURN** | Приёмка | Брак, несоответствие | Возврат поставщику |
| **INTER_LOCATION** | Магазин → Склад | Излишки, плохие продажи | Перемещение (не возврат) |

### Возврат от клиента (Customer Return)

**Сценарий:** Клиент вернул 2 кг яблок через 30 минут после покупки.

```
Возврат #RET-2024-12-06-001
├── Тип: CUSTOMER_RETURN
├── Заказ: #1234 (онлайн) или чек #5678 (офлайн)
├── Причина: Не понравилось качество
│
├── Позиции:
│   └── Яблоки Голден: 2 кг
│       ├── Исходная партия: #P-001
│       └── Оценка состояния: требуется
│
└── Статус: PENDING_INSPECTION
```

### Процесс оценки возвращённого товара

```
┌─────────────────────────────────────────────────────────────┐
│ 🔍 ОЦЕНКА ВОЗВРАТА                                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Товар: Яблоки Голден, 2 кг                                  │
│ Партия: #P-001 (срок до 10.12)                             │
│ Время вне контроля: 45 минут                               │
│                                                             │
│ Состояние товара:                                           │
│ ○ Отличное (как новый)                                     │
│ ○ Хорошее (незначительные следы)                           │
│ ○ Удовлетворительное (продать со скидкой)                  │
│ ○ Неудовлетворительное (списать)                           │
│                                                             │
│ Упаковка:                                                   │
│ ○ Целая                                                     │
│ ○ Вскрыта, но товар не тронут                              │
│ ○ Повреждена                                                │
│                                                             │
│ Решение:                                                    │
│ [Вернуть на полку] [Вернуть со скидкой] [Списать]          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Влияние на срок годности при возврате

**Ключевой вопрос:** Сколько времени товар был вне контролируемых условий?

```
Расчёт нового срока для возвращённого товара:

Яблоки (партия #P-001):
├── Срок до возврата: осталось 4 дня
├── Время вне контроля: 2 часа при ~25°C
│
├── Расчёт потерь:
│   ├── Kтемп (тепло): 1.8
│   ├── Kвлаж (сухо, допустим): 1.4
│   ├── Итоговый: 1.8 × 1.4 = 2.52
│   └── Потрачено: 2ч × 2.52 / 24 = 0.21 условных дня
│
├── Новый срок: 4 - 0.21 = 3.79 дней
└── Статус: можно вернуть на полку
```

**Правило:** Если потеря > 20% оставшегося срока → рекомендация списать.

### Матрица решений по возврату

| Оставшийся срок | Время вне контроля | Состояние | Решение |
|-----------------|-------------------|-----------|---------|
| > 5 дней | < 2 часов | Отличное | ✅ Вернуть на полку |
| > 5 дней | < 2 часов | Хорошее | ✅ Вернуть со скидкой 10% |
| > 3 дней | 2-4 часа | Отличное | ⚠️ Вернуть со скидкой 20% |
| > 3 дней | 2-4 часа | Хорошее | ⚠️ Вернуть со скидкой 30% |
| < 3 дней | Любое | Любое | 🔴 Списать |
| Любой | > 4 часов (тепло) | Любое | 🔴 Списать |
| Любой | Любое | Неудовлетв. | 🔴 Списать |

### Особенности по категориям

```
┌─────────────────────────────────────────────────────────────┐
│ КАТЕГОРИИ С ОГРАНИЧЕННЫМ ВОЗВРАТОМ                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 🔴 НЕ ПРИНИМАТЬ ВОЗВРАТ:                                    │
│    • Ягоды (BERRIES) — слишком быстро портятся              │
│    • Зелень (LEAFY_GREENS) — увядает необратимо             │
│    • Грибы (MUSHROOMS) — опасны при неправильном хранении   │
│    • Нарезанные фрукты — бактерии                           │
│                                                             │
│ ⚠️ ВОЗВРАТ С ОЦЕНКОЙ:                                       │
│    • Цитрусовые — если целые и < 2 часов                    │
│    • Яблоки/груши — если целые и < 4 часов                  │
│    • Корнеплоды — практически всегда можно                  │
│                                                             │
│ ✅ СТАНДАРТНЫЙ ВОЗВРАТ:                                      │
│    • Корнеплоды (ROOT_VEGETABLES)                           │
│    • Цитрусовые в упаковке                                  │
│    • Яблоки/груши в упаковке                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Возврат от курьера (Delivery Return)

**Сценарий:** Клиент не принял заказ — не было дома.

```
Возврат доставки #DRET-2024-12-06-001
├── Заказ: #1234
├── Причина: CUSTOMER_NOT_HOME
├── Время в пути: 1.5 часа
│
├── Позиции:
│   ├── Яблоки: 3 кг
│   │   ├── Партия: #P-001
│   │   ├── Условия в сумке: ~15°C (термосумка)
│   │   └── Коэффициент: 0.6 (прохлада)
│   │
│   └── Клубника: 0.5 кг
│       ├── Партия: #P-089
│       ├── Условия: ~15°C
│       └── ⚠️ Для ягод 1.5 часа критично!
│
└── Решение:
    ├── Яблоки: вернуть на полку (потеря минимальна)
    └── Клубника: списать или продать со скидкой 50%
```

### Автоматический расчёт при возврате

```
При оформлении возврата система автоматически:

1. Определяет исходную партию (по заказу/чеку)
2. Рассчитывает время вне контроля
3. Применяет коэффициенты условий хранения
4. Пересчитывает оставшийся срок
5. Выдаёт рекомендацию: полка / скидка / списание

Если товар возвращается на полку:
├── Обновляется effectiveExpirationDate
├── Добавляется запись в историю: "RETURN"
└── Товар получает метку "возвращённый" (для аналитики)
```

### Возврат поставщику

```
Возврат поставщику #SRET-2024-12-06-001
├── Поставщик: ООО "Сады Кубани"
├── Причина: QUALITY_MISMATCH
├── Документ приёмки: #R-001
│
├── Позиции:
│   └── Яблоки Голден: 20 кг
│       ├── Партия: #P-001
│       └── Проблема: Гниль внутри, не видна снаружи
│
├── Статус: PENDING_SUPPLIER_APPROVAL
│
└── Финансы:
    ├── Сумма к возврату: 1600 ₽
    └── Статус: ожидает подтверждения поставщика
```

**Процесс:**
1. Создание претензии с фото/описанием
2. Блокировка партии (нельзя продавать)
3. Ожидание ответа поставщика
4. Подтверждение → списание с баланса + возврат денег
5. Отклонение → разблокировка или списание за свой счёт

### Аналитика возвратов

```
┌─────────────────────────────────────────────────────────────┐
│ 📊 Статистика возвратов за декабрь                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Всего возвратов: 47                                         │
│ Сумма: 12,450 ₽                                             │
│                                                             │
│ По причинам:                                                │
│ ├── Качество не устроило: 52% (24)                         │
│ ├── Клиент не принял: 28% (13)                             │
│ ├── Ошибка в заказе: 15% (7)                               │
│ └── Повреждение при доставке: 5% (3)                       │
│                                                             │
│ По категориям:                                              │
│ ├── Ягоды: 35% — ⚠️ много, пересмотреть упаковку           │
│ ├── Зелень: 25%                                            │
│ ├── Фрукты: 30%                                            │
│ └── Овощи: 10%                                             │
│                                                             │
│ Судьба возвращённого товара:                                │
│ ├── Вернули на полку: 40%                                  │
│ ├── Продали со скидкой: 25%                                │
│ └── Списали: 35%                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 13. Списания

### Причины списания

| Причина | Пример |
|---------|--------|
| **EXPIRED** | Срок годности истёк |
| **DAMAGED** | Товар повреждён (помят, разбит) |
| **SPOILED** | Испортился раньше срока |
| **SHORTAGE** | Недостача при инвентаризации |
| **SAMPLES** | Дегустация, образцы |
| **FOR_PRODUCTION** | Использован как ингредиент (homemade товары) |
| **SHRINKAGE** | Усушка (автоматическое списание веса) |
| **OTHER** | Прочее (благотворительность и т.д.) |

### Процесс списания

```
Списание #W-2024-12-06-001
├── Локация: Магазин на Ленина
├── Причина: SPOILED
├── Статус: ЧЕРНОВИК
│
└── Позиции:
    └── Партия #P-089 (Клубника): 2 кг
        Комментарий: "Появилась плесень"
        Фото: [прикреплено]
```

**После подтверждения:**
- Остаток уменьшается
- Записывается в историю
- Если партия закончилась → статус "DEPLETED"

### Автоматическое списание истёкших

Настройка продавца:
```
autoWriteOffExpired: true  // автосписание через день после истечения
```

Система ежедневно:
1. Находит партии с истёкшим сроком
2. Создаёт списания с причиной EXPIRED
3. Уведомляет менеджера

### Усушка (Shrinkage) — Автосписание веса

**Проблема:** Овощи и фрукты теряют вес из-за испарения влаги. Через неделю на складе будет "недостача", которая по факту — физика.

**Решение:** Для товаров с `shrinkageEnabled: true` система ежедневно автоматически уменьшает остаток.

```
┌─────────────────────────────────────────────────────────┐
│                    УСУШКА (SHRINKAGE)                   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ProductTemplate:                                       │
│  ├── shrinkageEnabled: true                            │
│  └── shrinkagePercentPerDay: 0.5  (процент в сутки)   │
│                                                         │
│  Пример:                                                │
│  Картофель 100 кг, усушка 0.5%/день                    │
│  → Через 7 дней: 100 × (1 - 0.005)^7 ≈ 96.5 кг        │
│  → Списано 3.5 кг автоматически                        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**Типичные значения усушки:**
| Товар | Усушка %/сутки |
|-------|----------------|
| Картофель | 0.3-0.5% |
| Морковь | 0.5-0.8% |
| Капуста | 0.2-0.4% |
| Яблоки | 0.1-0.3% |
| Ягоды | 1.0-2.0% |

**Cron-задача:** Ежедневно в 03:00 система находит все батчи с усушкой и списывает рассчитанный вес (reason: SHRINKAGE, auto: true).

---

## 14. Инвентаризация

### Зачем нужна

- Проверить соответствие учёта реальности
- Найти недостачи/излишки
- Скорректировать остатки

### Процесс

**Шаг 1: Создание инвентаризации**

```
Инвентаризация #A-2024-12-06-001
├── Локация: Магазин на Ленина
├── Статус: В ПРОЦЕССЕ
│
└── Позиции (из системы):
    ├── Партия #P-001 (Яблоки, до 10.12): ожидается 25 кг, факт: ___
    ├── Партия #P-002 (Яблоки, до 15.12): ожидается 35 кг, факт: ___
    ├── Партия #P-045 (Груши, до 12.12): ожидается 40 кг, факт: ___
    └── ...
```

**Шаг 2: Подсчёт**

Сотрудник физически считает/взвешивает товар и вводит факт.

**Шаг 3: Сверка**

```
Результаты:
├── Партия #P-001: ожидалось 25 кг, факт 23 кг → НЕДОСТАЧА 2 кг
├── Партия #P-002: ожидалось 35 кг, факт 35 кг → ОК
├── Партия #P-045: ожидалось 40 кг, факт 42 кг → ИЗЛИШЕК 2 кг
└── ...
```

**Шаг 4: Применение корректировок**

```
После подтверждения менеджером:

├── Недостача 2 кг → списание (причина: SHORTAGE)
├── Излишек 2 кг → приход (корректировка)
└── Остатки = факту
```

---

## 15. Сроки годности и алерты

### Уровни срочности

| Уровень | Условие | Что делать |
|---------|---------|------------|
| 🟢 **NORMAL** | > 7 дней | Ничего, всё ок |
| 🟡 **WARNING** | 3-7 дней | Обратить внимание, возможно снизить цену |
| 🔴 **CRITICAL** | < 3 дней | Срочно! Скидка или перемещение в активный магазин |
| ⚫ **EXPIRED** | Срок вышел | Заблокировать, списать |

### Dashboard менеджера

```
┌─────────────────────────────────────────────────────────────┐
│ 📊 Контроль сроков годности                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 🔴 КРИТИЧНО (истекает < 3 дней):                           │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Клубника • Партия #P-089 • 5 кг • завтра               │ │
│ │ 📍 Магазин на Ленина                                    │ │
│ │ [📉 Снизить цену] [📦 Переместить] [🗑 Списать]        │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Малина • Партия #P-092 • 3 кг • послезавтра            │ │
│ │ 📍 Склад-холодильник                                    │ │
│ │ [📉 Снизить цену] [📦 Переместить] [🗑 Списать]        │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 🟡 ВНИМАНИЕ (3-7 дней): 5 позиций                          │
│ ⚫ ТРЕБУЮТ СПИСАНИЯ: 2 позиции                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Уведомления

**Ежедневный отчёт в Telegram (08:00):**

```
📊 Сроки годности на 06.12.2024

🔴 Критично (3):
• Клубника 5 кг — завтра (Ленина)
• Малина 3 кг — послезавтра (Склад)
• Бананы 8 кг — послезавтра (Пушкина)

🟡 Внимание (7):
• Яблоки Голден 25 кг — через 4 дня
• Груши 15 кг — через 5 дней
• ... ещё 5 позиций

⚫ Истекли (2):
• Виноград 2 кг — вчера (Ленина)
• Черешня 1 кг — вчера (Склад)
→ Требуется списание

[Открыть панель управления]
```

**Срочное уведомление (при критичном уровне):**

```
🚨 Срочно! 

Клубника (партия #P-089) истекает ЗАВТРА
Остаток: 5 кг в Магазине на Ленина

Рекомендуем:
• Снизить цену на 30-50%
• Переместить на кассовую зону

[Снизить цену] [Списать]
```

---

## 16. Роли и доступ

### Роли в складском учёте

| Роль | Возможности |
|------|-------------|
| **VIEWER** | Просмотр остатков и истории |
| **OPERATOR** | + Приёмка, перемещения |
| **MANAGER** | + Списания, инвентаризация, настройки |
| **ADMIN** | Полный доступ, управление ролями |

### Ограничение по локациям

```
Сотрудник: Иван Петров
├── Роль: OPERATOR
└── Доступные локации:
    ├── ✅ Магазин на Ленина
    ├── ✅ Магазин на Пушкина
    └── ❌ Центральный склад (нет доступа)
```

Иван может:
- Видеть остатки только в своих магазинах
- Оформлять приёмки и перемещения для этих магазинов
- Не видит данные склада

### Аудит действий

Каждое действие записывается:

```
История партии #P-001 (Яблоки Голден):

06.12 09:15 | ПРИЁМКА     | +100 кг | Центр. склад    | Мария С.
06.12 11:30 | ПЕРЕМЕЩЕНИЕ | -30 кг  | → Маг. Ленина   | Иван П.
06.12 11:31 | ПЕРЕМЕЩЕНИЕ | +30 кг  | Маг. Ленина     | Иван П.
06.12 14:22 | РЕЗЕРВ      | -5 кг   | Заказ #1234     | Система
06.12 15:10 | ПРОДАЖА     | -5 кг   | Заказ #1234     | Система
06.12 16:45 | ПРОДАЖА     | -3 кг   | Офлайн          | Касса #2
07.12 10:00 | СПИСАНИЕ    | -2 кг   | Порча           | Анна К.
```

---

## 17. Сценарии из жизни

### Сценарий 1: Утро в магазине

**07:30** — Менеджер открывает магазин

1. Смотрит уведомления: "🔴 Клубника истекает завтра, 5 кг"
2. Решает снизить цену на 40%
3. Просит продавца выложить клубнику на видное место

**08:00** — Приехала машина с товаром

1. Кладовщик проверяет товар
2. Создаёт приёмку, вводит позиции и сроки
3. Подтверждает — товар на балансе

**09:00** — Открытие для покупателей

1. Онлайн-заказы начинают поступать
2. Офлайн-покупатели заходят в зал
3. Система следит за остатками и резервами

---

### Сценарий 2: Онлайн-заказ с конфликтом

**12:00** — Клиент заказал 5 кг яблок онлайн

```
Остаток: 8 кг, Резерв: 5 кг, Доступно: 3 кг
```

**12:15** — Офлайн-покупатель хочет 5 кг яблок

```
Кассир видит:
• Доступно: 3 кг
• Для 5 кг нужно 2 кг из резерва заказа #1256
```

**Кассир выбирает "Продать частично (3 кг)"**

```
Покупатель берёт 3 кг
Остаток: 5 кг, Резерв: 5 кг, Доступно: 0 кг
Онлайн-заказ #1256 не затронут ✓
```

**12:30** — Сборщик собирает заказ #1256

```
Собирает 5 кг из резерва
Остаток: 0 кг
Заказ готов к выдаче
```

---

### Сценарий 3: Перемещение со склада

**14:00** — В магазине заканчиваются бананы

```
Магазин на Ленина:
└── Бананы: 5 кг (мало!)

Центральный склад:
└── Бананы: 200 кг
```

**Менеджер создаёт перемещение:**

```
Откуда: Центральный склад
Куда: Магазин на Ленина
Позиции:
└── Бананы (партия #P-077): 50 кг
```

**15:30** — Товар привезли, приёмщик подтверждает

```
Магазин на Ленина:
└── Бананы: 55 кг (+50)

Центральный склад:
└── Бананы: 150 кг (-50)
```

---

### Сценарий 4: Инвентаризация выходного дня

**Воскресенье 20:00** — После закрытия магазина

1. Менеджер создаёт инвентаризацию
2. Два сотрудника считают товар
3. Вводят фактические остатки

**Результат:**

```
Расхождения:
├── Яблоки #P-001: -2 кг (недостача)
├── Груши #P-045: +1 кг (излишек)
└── Апельсины #P-088: -0.5 кг (недостача)
```

**Менеджер подтверждает корректировки:**

- Недостачи списываются (причина: SHORTAGE)
- Излишки приходуются
- Остатки теперь соответствуют факту

---

### Сценарий 5: Истёк срок годности

**Понедельник 08:00** — Система прислала алерт

```
⚫ Истекли:
• Виноград (партия #P-071): 2 кг, вчера
• Черешня (партия #P-073): 1.5 кг, вчера
```

**Менеджер:**

1. Проверяет товар — действительно непригоден
2. Подтверждает автоматические списания
3. Партии получают статус EXPIRED, остатки обнуляются

---

## Резюме

### Ключевые принципы

| Принцип | Описание |
|---------|----------|
| **Единый остаток** | Магазин = один пул товара (без разделения на витрину/подсобку) |
| **Мягкий резерв** | Онлайн-заказы резервируют, но офлайн может продать с предупреждением |
| **Партионный учёт** | Каждая поставка отслеживается отдельно |
| **FEFO** | Сначала продаём то, что истекает раньше |
| **Полный аудит** | История каждого движения товара |
| **Проактивные алерты** | Система предупреждает о сроках заранее |

### Потоки товара

```
Поставщик
    │
    ▼
┌──────────┐    Перемещение    ┌──────────┐
│  СКЛАД   │ ───────────────► │  МАГАЗИН │
└──────────┘                   └────┬─────┘
                                   │
                    ┌──────────────┼──────────────┐
                    ▼              ▼              ▼
              ┌──────────┐  ┌──────────┐  ┌──────────┐
              │  Онлайн  │  │ Офлайн   │  │ Списание │
              │  заказ   │  │ продажа  │  │          │
              └──────────┘  └──────────┘  └──────────┘
```
