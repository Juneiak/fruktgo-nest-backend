# Фаза 2: Money Flow

> Подключение платежей и финансовой системы.

**Длительность:** 2-3 недели

**Зависимости:** Требует завершения Фазы 1 (ORDERS, BUSINESS)

---

## Цели

1. Клиент может оплатить заказ онлайн
2. Деньги распределяются между магазином и платформой
3. Селлер видит баланс и может запросить вывод
4. Платформа получает комиссию

---

## Этапы

| Этап | Название | Что делаем |
|------|----------|------------|
| 1 | Платежи | OrderPayment, интеграция ЮKassa, webhooks |
| 2 | Кошельки | ShopAccount, SellerAccount, PlatformAccount |
| 3 | Комиссии | Commission, расчёт 10-40% |
| 4 | Периоды | SettlementPeriod, закрытие, release |
| 5 | Выводы | WithdrawalRequest, обработка |
| 6 | Штрафы | Penalty, применение |

---

## Этап 1: Платежи (OrderPayment)

**Сущности:** Payment

**Интеграция:** ЮKassa

**Задачи:**
- Двухшаговая оплата (hold → capture)
- Idempotency keys
- Webhook обработка
- Возвраты (полные/частичные)

**Детали:** [stage-1.md](./stage-1.md) *(после утверждения)*

---

## Этап 2: Кошельки

**Сущности:** ShopAccount, SellerAccount, PlatformAccount

**Задачи:**
- ShopAccount: balance, pendingBalance, holdBalance
- SellerAccount: агрегация магазинов
- PlatformAccount: комиссии
- Транзакции для каждого

**Детали:** [stage-2.md](./stage-2.md) *(после утверждения)*

---

## Этап 3: Комиссии

**Сущности:** Commission (или CommissionService)

**Задачи:**
- Расчёт комиссии по категориям
- Формула: platformFee = amount × rate
- Запись в PlatformAccount

**Детали:** [stage-3.md](./stage-3.md) *(после утверждения)*

---

## Этап 4: Расчётные периоды

**Сущности:** SettlementPeriod

**Статусы:** OPEN → CLOSED → RELEASED

**Задачи:**
- Накопление в pendingBalance
- Закрытие периода
- Release → перевод на SellerAccount

**Детали:** [stage-4.md](./stage-4.md) *(после утверждения)*

---

## Этап 5: Вывод средств

**Сущности:** WithdrawalRequest

**Статусы:** PENDING → PROCESSING → COMPLETED / REJECTED

**Задачи:**
- Заявка на вывод
- Валидация баланса
- Обработка (ручная/авто)

**Детали:** [stage-5.md](./stage-5.md) *(после утверждения)*

---

## Этап 6: Штрафы

**Сущности:** Penalty

**Задачи:**
- Штраф за отмену заказа
- Штраф за просрочку
- Списание из ShopAccount

**Детали:** [stage-6.md](./stage-6.md) *(после утверждения)*

---

## Ключевые требования

- **Idempotency keys** для всех платёжных операций
- **Feature flags:** FEATURE_ONLINE_PAYMENT
- **Все суммы в копейках (Int)**
- **Аудит-логи** для финансовых операций

---

## Критерии готовности

- [ ] E2E: Заказ → Оплата → Capture → Доход магазина
- [ ] E2E: Закрытие периода → Release → Баланс селлера
- [ ] E2E: Вывод средств
- [ ] Idempotency работает
- [ ] Комиссия правильно рассчитывается
