# Architecture V2 — Модульная архитектура

> Переработанная архитектура с чёткой изоляцией модулей по бизнес-доменам.

## Обзор

Архитектура разделена на **5 групп** по функциональному назначению:

| Группа | Назначение | Модули |
|--------|------------|--------|
| **A** | Core Commerce | CATALOG, INVENTORY, ORDERS, STOREFRONT |
| **B** | Back-office | BUSINESS, WORKFORCE, FINANCE, PLATFORM |
| **C** | Engagement | CUSTOMER, MARKETING, LOYALTY, REPUTATION, SUPPORT |
| **D** | Infra & Data | AUTH, COMMUNICATIONS, MEDIA, AUDIT, ANALYTICS, INTEGRATIONS |
| **E** | Logistics | LOGISTICS, GEO |

---

## Слои архитектуры

```
┌─────────────────────────────────────────────────────────┐
│                   INTERFACE LAYER                        │
│   HTTP (Role APIs)  │  WebSockets  │  Telegram Bots     │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                  APPLICATION LAYER                       │
│   RoleServices: права, DTO→Command, маппинг ошибок      │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                   PROCESS LAYER                          │
│   Orchestrators: кросс-модульные бизнес-процессы        │
│   (OrderProcess, CheckoutProcess, FinanceProcess)       │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    DOMAIN LAYER                          │
│   Модули групп A, B, C (бизнес-логика)                  │
│   Port + Service + Schema + Commands/Queries            │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                 INFRASTRUCTURE LAYER                     │
│   Модули группы D, E (инфра, внешние сервисы)           │
└─────────────────────────────────────────────────────────┘
```

### Правила зависимостей

```
Interface → Application → Process → Domain → Infrastructure
    ↓                                   ↓
  common ←─────────────────────────────┘

✅ Оркестраторы работают ТОЛЬКО через Ports модулей
✅ Модули общаются через Events или Ports
❌ Модули НЕ импортируют схемы других модулей напрямую
❌ Нет циклических зависимостей
```

---

## Группа A: Торговля (Core Commerce)

Ядро платформы — товары, остатки, заказы, витрина.

### CATALOG

**Назначение:** Мастер-данные товаров, категории, бренды, характеристики.

**Характеристики:**
- **Read-heavy** — высокая нагрузка на чтение
- Источник истины для карточек товаров
- Не хранит остатки и цены (это INVENTORY/STOREFRONT)

**Ответственность:**
- Категории и их иерархия (дерево)
- Бренды и производители
- Мастер-товары (Product) — описание, характеристики, медиа
- Атрибуты и фильтры (размер, цвет, материал)
- Варианты товаров (SKU)

**Входящие зависимости:**
- STOREFRONT читает для витрины
- INVENTORY ссылается на SKU
- ORDERS ссылается на товары

**Исходящие зависимости:**
- MEDIA — хранение изображений
- BUSINESS — привязка к магазину/селлеру

---

### INVENTORY

**Назначение:** Склады, остатки, партии, списания.

**Характеристики:**
- **Write-heavy** — частые операции изменения остатков
- **ACID critical** — транзакционная целостность обязательна
- Источник истины для наличия товара

**Ответственность:**
- Склады (Warehouse) — локации хранения
- Остатки (Stock) — количество по SKU на складе
- Партии (Batch):
  - Учёт сроков годности (expiresAt)
  - Динамический срок хранения (зависит от условий)
  - Пресеты хранения (температура, влажность, этилен)
  - FEFO (принцип ротации)
  - Себестоимость
- Резервирование (Reserve) — бронь под заказ
- Списания и инвентаризация
- Движения товара (StockMovement) — аудит
- Алерты свежести — рекомендации (снизить цену, списать)

**Входящие зависимости:**
- ORDERS резервирует и списывает остатки
- STOREFRONT запрашивает доступность

**Исходящие зависимости:**
- CATALOG — информация о SKU
- BUSINESS — привязка склада к магазину

---

### ORDERS

**Назначение:** Чеки, корзины, история покупок.

**Характеристики:**
- Полный цикл заказа от корзины до завершения
- Event-driven для интеграций

**Ответственность:**
- Корзина (Cart) — сборка заказа
- Заказ (Order) — оформление, статусы, история
- Позиции заказа (OrderItem)
- Логика веса (Tolerance):
  - Допустимая погрешность (±10% по умолчанию)
  - Компенсация недовеса баллами (LOYALTY)
  - Перевес за счёт продавца
- Оплата (Payment) — интеграция с платёжными системами
- Возвраты (Refund) — частичные/полные
- События заказа (OrderEvent) — аудит

**Входящие зависимости:**
- CUSTOMER — кто заказывает
- STOREFRONT — откуда товары

**Исходящие зависимости:**
- INVENTORY — резервирование/списание
- FINANCE — записи транзакций
- LOGISTICS — создание доставки
- COMMUNICATIONS — уведомления

---

### STOREFRONT

**Назначение:** Витрина, поиск, листинги.

**Характеристики:**
- **Read-heavy** — оптимизация под быстрый поиск
- ElasticSearch для полнотекстового поиска
- Кэширование (Redis)

**Ответственность:**
- Листинги магазинов (ShopProduct) — цены, доступность
- Живые фотографии (LivePhotos):
  - Актуальные фото с прилавка
  - Дата съёмки
  - Показывают реальное состояние товара
- Поиск товаров (Search) — фильтры, сортировка
- Индексация (Indexer) — синхронизация с ES
- Рекомендации (Recommendations) — "похожие товары"
- SEO-данные — meta, canonical URLs

**Входящие зависимости:**
- Публичный API — покупатели
- ORDERS — выбор товаров

**Исходящие зависимости:**
- CATALOG — данные товаров
- INVENTORY — остатки
- BUSINESS — информация о магазинах

---

## Группа B: Управление и Операции (Back-office)

Бизнес-сущности продавцов, сотрудники, финансы, админка.

### BUSINESS

**Назначение:** Профили селлеров, настройки магазинов.

**Ответственность:**
- Селлер (Seller) — юрлицо, реквизиты, документы
- Магазин (Shop) — торговая точка селлера
- Настройки магазина — график, зоны доставки, минимальный заказ
- Подписки и тарифы

**Входящие зависимости:**
- Все модули группы A — привязка к магазину

**Исходящие зависимости:**
- FINANCE — биллинг селлера
- PLATFORM — KYC проверки

---

### WORKFORCE

**Назначение:** Сотрудники селлеров, смены, задачи, права доступа.

**Ответственность:**
- Сотрудник (Employee) — профиль работника магазина
- Смены (Shift) — рабочие периоды, SLA-снэпшоты
- Задачи (Task) — picking, packing, delivery, stock operations
- Роли и права (RBAC) — что может делать сотрудник
- Заявки на работу (JobApplication)

**Входящие зависимости:**
- ORDERS — кто собирает заказ
- LOGISTICS — кто доставляет

**Исходящие зависимости:**
- BUSINESS — привязка к магазину
- COMMUNICATIONS — уведомления сотрудникам

---

### FINANCE

**Назначение:** Биллинг, кошельки, транзакции, выплаты, налоги.

**Характеристики:**
- **ACID critical** — финансовая целостность
- Двойная запись (double-entry)

**Ответственность:**
- Кошелёк магазина (ShopAccount) — баланс, холды
- Кошелёк селлера (SellerAccount) — агрегация по магазинам
- Кошелёк платформы (PlatformAccount) — комиссии
- Транзакции (Transaction) — все движения денег
- Расчётные периоды (SettlementPeriod)
- Выплаты (Payout) — вывод на банк
- Штрафы (Penalty)
- Комиссии (Commission) — расчёт 10-40%

**Входящие зависимости:**
- ORDERS — оплата заказа

**Исходящие зависимости:**
- BUSINESS — привязка к селлеру
- INTEGRATIONS — банковские API

---

### PLATFORM

**Назначение:** Управление платформой, сотрудники платформы, настройки.

**Ответственность:**
- Сотрудники платформы (PlatformStaff):
  - `platform_admin` — полный доступ
  - `platform_finance` — финансы, выплаты
  - `platform_support` — поддержка
  - `platform_moderator` — модерация контента
- KYC — верификация документов селлеров
- Модерация товаров и отзывов
- Настройки платформы (комиссии, лимиты, города)
- Блокировки и санкции
- Контент (Article) — статьи, блог, новости

**Входящие зависимости:**
- Все модули — администрирование

**Исходящие зависимости:**
- COMMUNICATIONS — уведомления о блокировках
- AUDIT — логирование действий
- ANALYTICS — дашборды

---

## Группа C: Взаимодействие (Engagement)

Клиенты, маркетинг, отзывы, поддержка.

### CUSTOMER

**Назначение:** CRM, профили покупателей.

**Ответственность:**
- Профиль покупателя (Customer) — имя, контакты
- Адреса доставки
- Избранное (Wishlist)
- История просмотров
- Сегментация для маркетинга

**Входящие зависимости:**
- ORDERS — кто заказывает
- MARKETING — таргетинг

**Исходящие зависимости:**
- COMMUNICATIONS — уведомления

---

### MARKETING

**Назначение:** Акции, баннеры, рекламные кампании.

**Ответственность:**
- Промокоды (Promo) — скидки, условия
- Акции (Campaign) — "2 по цене 1", happy hours
- Баннеры — главная, категории
- Рекламные кампании селлеров
**Входящие зависимости:**
- ORDERS — применение скидок
- STOREFRONT — отображение акций

**Исходящие зависимости:**
- CUSTOMER — сегменты
- ANALYTICS — эффективность кампаний

---

### LOYALTY

**Назначение:** Программа лояльности, бонусы, баллы.

**Ответственность:**
- Бонусный счёт клиента (BonusAccount)
- Начисление баллов:
  - За недовес (tolerance compensation)
  - За отзывы
  - Кэшбэк с заказов
- Списание баллов при оплате
- Реферальная программа (будущее)
- Уровни лояльности (будущее)

**Входящие зависимости:**
- ORDERS — начисление/списание баллов
- REPUTATION — баллы за отзывы

**Исходящие зависимости:**
- CUSTOMER — привязка к клиенту
- COMMUNICATIONS — уведомления о баллах

---

### REPUTATION

**Назначение:** Отзывы, рейтинги, Q&A.

**Ответственность:**
- Отзывы на товары (ProductReview)
- Отзывы на магазины (ShopReview)
- Отзывы на курьеров (CourierReview)
- Рейтинги (агрегация)
- Вопросы о товарах (Q&A)
- Модерация отзывов

**Входящие зависимости:**
- ORDERS — проверка покупки перед отзывом
- STOREFRONT — отображение рейтингов

**Исходящие зависимости:**
- CUSTOMER — кто оставил отзыв
- PLATFORM — модерация
- LOYALTY — баллы за отзывы

---

### SUPPORT

**Назначение:** Тикетная система, чаты, арбитраж.

**Ответственность:**
- Тикеты (Issue/Ticket) — обращения в поддержку
- Чаты (Chat):
  - Покупатель ↔ Селлер
  - Селлер ↔ Платформа
- Споры (Dispute) — арбитраж возвратов
- SLA и эскалация
- База знаний (FAQ)

**Входящие зависимости:**
- ORDERS — споры по заказам
- CUSTOMER — кто обращается

**Исходящие зависимости:**
- COMMUNICATIONS — уведомления
- FINANCE — возвраты по спорам

---

## Группа D: Инфраструктура и Данные (Infra & Data)

Аутентификация, уведомления, медиа, аудит, аналитика, интеграции.

### AUTH

**Назначение:** Аутентификация и авторизация всех ролей.

**Характеристики:**
- **@Global()** — доступен всем модулям
- Stateless JWT

**Ответственность:**
- JWT токены (access, refresh)
- Одноразовые коды (OTP) для входа
- Telegram OAuth
- Guards: `JwtAuthGuard`, `TypeGuard`, `RolesGuard`
- Strategies: `JwtStrategy`
- Декораторы: `@GetUser()`, `@UserType()`, `@Roles()`

**Входящие зависимости:**
- Все модули — защита endpoints

**Исходящие зависимости:**
- CUSTOMER, BUSINESS, WORKFORCE, PLATFORM — проверка пользователей
- COMMUNICATIONS — отправка OTP

---

### COMMUNICATIONS

**Назначение:** Шлюз уведомлений.

**Ответственность:**
- Email — отправка через SMTP/SendGrid
- SMS — интеграция с провайдерами
- Push — мобильные/веб уведомления
- Telegram Bot — уведомления в TG
- Webhooks — для внешних систем
- Шаблоны сообщений
- Очередь отправки (Queue)

**Входящие зависимости:**
- Все модули — отправка уведомлений

**Исходящие зависимости:**
- Внешние сервисы (SendGrid, Twilio, FCM)

---

### MEDIA

**Назначение:** Загрузка и обработка файлов.

**Ответственность:**
- Загрузка файлов в S3/R2
- Оптимизация изображений (resize, compression)
- Генерация превью (thumbnails)
- CDN интеграция
- Очистка неиспользуемых файлов

**Входящие зависимости:**
- CATALOG — изображения товаров
- BUSINESS — логотипы магазинов
- REPUTATION — фото в отзывах

**Исходящие зависимости:**
- S3/R2 storage

---

### AUDIT

**Назначение:** Аудит-логирование критичных действий.

**Характеристики:**
- **Write-only** — логи не редактируются
- Возможна репликация в SIEM

**Ответственность:**
- AuditLog — кто, что, когда, над чем
- Типы действий:
  - Финансовые операции
  - Блокировки/разблокировки
  - Изменения настроек
  - Складские операции
  - Административные действия
- Ретенция и архивация

**Входящие зависимости:**
- PLATFORM — действия админов
- FINANCE — финансовые операции
- INVENTORY — складские движения
- ORDERS — изменения статусов

**Исходящие зависимости:**
- MongoDB / ClickHouse (write-only storage)

---

### ANALYTICS

**Назначение:** Сбор данных и дашборды.

**Ответственность:**
- События (Event) — просмотры, клики, добавления в корзину
- ETL — агрегация из ORDERS, CATALOG
- Дашборды админов:
  - GMV (Gross Merchandise Value)
  - Revenue
  - Активность пользователей
- Дашборды селлеров:
  - Воронка продаж
  - Конверсия
  - Популярные товары
- Экспорт отчётов

**Входящие зависимости:**
- Все модули — события

**Исходящие зависимости:**
- ClickHouse/TimescaleDB — хранение событий
- ElasticSearch — логи

---

### INTEGRATIONS

**Назначение:** Внешние интеграции и API.

**Ответственность:**
- Public API Gateway — для ERP (1C, SAP)
- Импорт товаров (YML, CSV, Excel)
- Экспорт фидов (Яндекс.Маркет, Google Shopping)
- Webhooks для селлеров:
  - Новый заказ
  - Изменение статуса
  - Возврат
- OAuth для внешних сервисов

**Входящие зависимости:**
- CATALOG — импорт товаров
- ORDERS — webhooks

**Исходящие зависимости:**
- Внешние API

---

## Группа E: Логистика и Реальный мир (Logistics & Real World)

Доставка, геолокация, ПВЗ.

### LOGISTICS

**Назначение:** Fulfillment, доставка, трекинг.

**Подмодули:**

#### Fulfillment
- Маршрутизация внутри склада
- Сборка заказов
- Упаковка

#### Delivery
- Интеграция с 3PL (СДЭК, Почта, DPD, Uber)
- Свой автопарк (если есть)
- Расчёт стоимости доставки
- Создание накладных

#### Tracking
- Агрегация статусов от разных служб
- Единый трек для покупателя
- Webhook обновления статуса

#### Pickup Points
- Сеть ПВЗ и постаматов
- Интеграция с партнёрами (Boxberry, 5Post)
- Управление своими точками

**Входящие зависимости:**
- ORDERS — создание доставки

**Исходящие зависимости:**
- GEO — расчёт расстояний
- COMMUNICATIONS — уведомления о доставке

---

### GEO

**Назначение:** Карты, геокодинг, зоны доставки.

**Подмодули:**

#### Mapping
- Прокси для карт (Google/Yandex/OSM)
- Отображение на фронте

#### Geocoding
- Нормализация адресов
- Конвертация адрес ↔ координаты
- Интеграция с DaData

#### Zones
- Полигоны зон доставки
- Рисование зон на карте (админка селлера)
- Расчёт принадлежности точки зоне
- Ценообразование по зонам

**Входящие зависимости:**
- BUSINESS — настройка зон магазина
- LOGISTICS — расчёт маршрутов

**Исходящие зависимости:**
- Внешние API (DaData, Google Maps, Yandex Maps)

---

## Коммуникация между модулями

### Синхронная (Ports)

```typescript
// Модуль экспортирует порт
export interface CatalogPort {
  getProduct(query: GetProductQuery): Promise<Product>;
  getProducts(query: GetProductsQuery): Promise<Product[]>;
}

// Другой модуль инжектит через DI
@Inject(CATALOG_PORT) private readonly catalogPort: CatalogPort
```

### Асинхронная (Events)

```typescript
// Публикация события
this.eventEmitter.emit('order.created', new OrderCreatedEvent(order));

// Подписка в другом модуле
@OnEvent('order.created')
async handleOrderCreated(event: OrderCreatedEvent) {
  // INVENTORY: резервирование
  // COMMUNICATIONS: уведомление
  // ANALYTICS: запись события
}
```

### Правила коммуникации

1. **Запрещено:** Прямой импорт схем/сервисов между модулями
2. **Разрешено:** Только через порты и события
3. **Транзакции:** Только внутри одного модуля (или через Saga)
4. **Eventual consistency:** Между модулями через события

---

## Telegram Bots

Боты являются частью Interface Layer и используют COMMUNICATIONS для отправки уведомлений.

| Бот | Роль | Функции |
|-----|------|----------|
| `@fruktgo_bot` | Customer | Авторизация, уведомления о заказах |
| `@fruktgo_seller_bot` | Seller/Employee | Вход в панель, уведомления о заказах, сменах |
| `@fruktgo_admin_bot` | Platform | Алерты, критические уведомления |

---

## Process Orchestrators

Оркестраторы координируют кросс-модульные бизнес-процессы.

| Оркестратор | Модули | Операции |
|-------------|--------|----------|
| **CheckoutProcess** | ORDERS, INVENTORY, LOYALTY, FINANCE | Создание заказа из корзины |
| **OrderProcess** | ORDERS, INVENTORY, WORKFORCE, LOGISTICS | Жизненный цикл заказа |
| **FinanceProcess** | FINANCE, ORDERS, LOYALTY | Закрытие периодов, выплаты |
| **InventoryProcess** | INVENTORY, CATALOG, STOREFRONT | Приёмка, списания, инвентаризация |
| **DisputeProcess** | SUPPORT, ORDERS, FINANCE, LOYALTY | Споры и возвраты |

**Правила:**
- Работают ТОЛЬКО через Ports модулей
- MongoDB транзакции для атомарности
- События через EventEmitter2
- Saga pattern для длительных операций

---

## Миграция с V1

| V1 | V2 | Примечания |
|----|-----|-----------|
| `product` | `CATALOG` | + категории, бренды |
| `shop-product` | `STOREFRONT` | + поиск, рекомендации, LivePhotos |
| `shop` | `BUSINESS.Shop` | |
| `seller` | `BUSINESS.Seller` | |
| `customer` | `CUSTOMER` | |
| `employee` | `WORKFORCE.Employee` | |
| `shift` | `WORKFORCE.Shift` | + Task |
| `job-application` | `WORKFORCE.JobApplication` | |
| `order` | `ORDERS` | + Tolerance логика |
| `cart` | `ORDERS.Cart` | |
| `finance/*` | `FINANCE` | |
| `issue` | `SUPPORT.Issue` | + Chat, Dispute |
| `article` | `PLATFORM.Article` | |
| `images` | `MEDIA` | |
| `addresses` | `GEO.Geocoding` | |
| `logs` | `AUDIT` | Аудит-логи |
| `notification` | `COMMUNICATIONS` | + Telegram Bots |
| `auth` | `AUTH` | |
| `access` | Распределён по модулям | |
| — | `LOYALTY` | Новый модуль |
| — | `REPUTATION` | Новый модуль |
| — | `ANALYTICS` | Новый модуль |
| — | `INTEGRATIONS` | Новый модуль |
| — | `LOGISTICS` | Новый модуль |

---

## TODO

### Документация
- [ ] Детализация схем данных каждого модуля
- [ ] Port интерфейсы и контракты
- [ ] Event catalog — список всех событий
- [ ] API документация по ролям

### Миграция
- [ ] Стратегия миграции данных
- [ ] План поэтапного перехода
- [ ] Feature flags для A/B миграции

### Техническое
- [ ] Тестовое покрытие границ модулей
- [ ] Мониторинг и метрики
- [ ] Схема деплоя
