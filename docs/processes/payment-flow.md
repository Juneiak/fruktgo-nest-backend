# –ü—Ä–æ—Ü–µ—Å—Å: –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–æ–≤

**–£—á–∞—Å—Ç–Ω–∏–∫–∏:** Customer, Shop, PaymentProvider (–ÆKassa), PlatformStaff  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** Order Module, Finance Module (OrderPayment)

---

## –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

### –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è

–ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –∑–∞–∫–∞–∑ –æ–Ω–ª–∞–π–Ω —á–µ—Ä–µ–∑ **–ÆKassa** (–±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞, –°–ë–ü, –∫–æ—à–µ–ª—å–∫–∏). –î–µ–Ω—å–≥–∏ –ø–æ—Å—Ç—É–ø–∞—é—Ç –Ω–∞ —Å—á—ë—Ç **–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã**, –∫–æ—Ç–æ—Ä–∞—è –≤—ã—Å—Ç—É–ø–∞–µ—Ç **–∞–≥–µ–Ω—Ç–æ–º** –ø—Ä–æ–¥–∞–≤—Ü–∞. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏—é, –æ—Å—Ç–∞—Ç–æ–∫ –ø–µ—Ä–µ—á–∏—Å–ª—è–µ—Ç –º–∞–≥–∞–∑–∏–Ω—É.

**–°—Ö–µ–º–∞:** –ö–ª–∏–µ–Ω—Ç ‚Üí –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ (–∞–≥–µ–Ω—Ç) ‚Üí –ú–∞–≥–∞–∑–∏–Ω (–ø—Ä–∏–Ω—Ü–∏–ø–∞–ª). –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —á–µ–∫ —Å –∞–≥–µ–Ω—Ç—Å–∫–∏–º –ø—Ä–∏–∑–Ω–∞–∫–æ–º (54-–§–ó).

### –ö–ª—é—á–µ–≤–∞—è –ª–æ–≥–∏–∫–∞

**–î–≤—É—Ö—à–∞–≥–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞:**
- –®–∞–≥ 1: **Hold** (—Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –¥–µ–Ω–µ–≥ –Ω–∞ –∫–∞—Ä—Ç–µ) –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
- –®–∞–≥ 2: **Capture** (—Å–ø–∏—Å–∞–Ω–∏–µ –¥–µ–Ω–µ–≥) –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ –∑–∞–∫–∞–∑–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º
- –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—ë–Ω –¥–æ capture ‚Äî hold –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è, –∫–ª–∏–µ–Ω—Ç –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è

**Webhook –æ—Ç –ÆKassa:**
- –ÆKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
- –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç: `succeeded` ‚Üí –∑–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω, `canceled` ‚Üí –æ–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –æ–¥–∏–Ω webhook –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑

**–í–æ–∑–≤—Ä–∞—Ç—ã:**
- –ü–æ–ª–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç: –≤—Å—è —Å—É–º–º–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É (–ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞)
- –ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç: —Ä–∞–∑–Ω–∏—Ü–∞ –ø—Ä–∏ –Ω–µ–¥–æ–≤–µ—Å–µ –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ –ÆKassa API, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π

**–ê–≥–µ–Ω—Ç—Å–∫–∏–π —á–µ–∫:**
- –í —á–µ–∫–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è: –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ (–∞–≥–µ–Ω—Ç) + –º–∞–≥–∞–∑–∏–Ω (–ø—Ä–∏–Ω—Ü–∏–ø–∞–ª)
- –ê–≥–µ–Ω—Ç—Å–∫–∏–π –ø—Ä–∏–∑–Ω–∞–∫ (—Ç–µ–≥–∏ 1057, 1222, 1223) –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è 54-–§–ó
- –ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ email/—Ç–µ–ª–µ—Ñ–æ–Ω

### –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–æ–∫–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –¥–µ–Ω—å–≥–∏ –∏–¥—É—Ç:
1. **–ö–ª–∏–µ–Ω—Ç ‚Üí –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞** (–ø–æ–ª–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞)
2. **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ ‚Üí ShopAccount** (–≤—ã—Ä—É—á–∫–∞ –∑–∞ –≤—ã—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏, –≤ —Ä–∞–º–∫–∞—Ö —Ä–∞—Å—á—ë—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞)
3. **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç** –∫–æ–º–∏—Å—Å–∏—é (10-30% –æ—Ç –∑–∞–∫–∞–∑–∞)

---

## –û–±–∑–æ—Ä

–ü—Ä–æ—Ü–µ—Å—Å –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∞–Ω–∫–∞-—ç–∫–≤–∞–π–µ—Ä–∞ –∏ **–∞–≥–µ–Ω—Ç—Å–∫–æ–π —Å—Ö–µ–º—ã**.

**–°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã:**
- –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –≤—ã—Å—Ç—É–ø–∞–µ—Ç **–∞–≥–µ–Ω—Ç–æ–º** —Å–µ–ª–ª–µ—Ä–∞
- –î–µ–Ω—å–≥–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É ‚Üí —É–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ ‚Üí –≤—ã–ø–ª–∞—Ç–∞ —Å–µ–ª–ª–µ—Ä—É
- –§–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (—á–µ–∫–∏ 54-–§–ó)

**–ü—Ä–æ–≤–∞–π–¥–µ—Ä:** –ÆKassa (–Ø–Ω–¥–µ–∫—Å.–ö–∞—Å—Å–∞)

---

## –ê–≥–µ–Ω—Ç—Å–∫–∞—è –º–æ–¥–µ–ª—å

### –ü—Ä–∏–Ω—Ü–∏–ø

```
Customer ‚Üí –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ (–∞–≥–µ–Ω—Ç) ‚Üí Seller (–ø—Ä–∏–Ω—Ü–∏–ø–∞–ª)
           ‚Üì
        –ö–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –∑–∞–∫–∞–∑
2. –î–µ–Ω—å–≥–∏ –ø–æ—Å—Ç—É–ø–∞—é—Ç –Ω–∞ —Å—á—ë—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
3. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏—é (10-30%)
4. –û—Å—Ç–∞—Ç–æ–∫ –ø–µ—Ä–µ—á–∏—Å–ª—è–µ—Ç—Å—è —Å–µ–ª–ª–µ—Ä—É –≤ —Ä–∞–º–∫–∞—Ö —Ä–∞—Å—á—ë—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞

### –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è —Å—Ç–æ—Ä–æ–Ω–∞

- **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞** - –∞–≥–µ–Ω—Ç, –ø—Ä–∏–Ω–∏–º–∞—é—â–∏–π –ø–ª–∞—Ç–µ–∂–∏
- **Seller** - –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª, –≤–ª–∞–¥–µ–ª–µ—Ü —Ç–æ–≤–∞—Ä–∞
- **–ß–µ–∫** —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π –∫–∞–∫ –∞–≥–µ–Ω—Ç–æ–º
- **–ê–≥–µ–Ω—Ç—Å–∫–∏–π –ø—Ä–∏–∑–Ω–∞–∫** –≤ —á–µ–∫–µ (—Ç–µ–≥ 1057, 1222, 1223)

---

## 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞

**–ê–∫—Ç–æ—Ä:** Customer

### –°—Ü–µ–Ω–∞—Ä–∏–π

1. –ö–ª–∏–µ–Ω—Ç –æ—Ñ–æ—Ä–º–∏–ª –∑–∞–∫–∞–∑ ‚Üí `Order` –≤ —Å—Ç–∞—Ç—É—Å–µ `DRAFT`
2. –ö–ª–∏–µ–Ω—Ç –Ω–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å" ‚Üí `POST /customer/orders/:id/pay`
3. –°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞—ë—Ç `OrderPayment`:
   ```typescript
   {
     order: orderId,
     shopAccount: shop.account,
     amount: order.totalAmount,
     status: "PENDING",
     yookassa: {
       paymentId: null,  // –°–æ–∑–¥–∞—Å—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞ –≤ –ÆKassa
       status: "pending",
       paymentMethod: null,
       paid: false
     }
   }
   ```
4. –ó–∞–ø—Ä–æ—Å –≤ –ÆKassa API:
   ```json
   {
     "amount": {
       "value": "1500.00",
       "currency": "RUB"
     },
     "capture": false,  // –î–≤—É—Ö—à–∞–≥–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞
     "confirmation": {
       "type": "redirect",
       "return_url": "https://app.fruktgo.com/orders/{orderId}/success"
     },
     "description": "–ó–∞–∫–∞–∑ #12345 –≤ –º–∞–≥–∞–∑–∏–Ω–µ –§—Ä—É–∫—Ç–æ–≤–∞—è –±–∞–∑–∞",
     "receipt": {
       "customer": {
         "email": "customer@example.com",
         "phone": "+79991234567"
       },
       "items": [
         {
           "description": "–Ø–±–ª–æ–∫–æ –ì–∞–ª–∞",
           "quantity": "2.5",
           "amount": { "value": "625.00", "currency": "RUB" },
           "vat_code": 1,  // –ù–î–°
           "payment_subject": "commodity",
           "payment_mode": "full_prepayment",
           "agent_type": "payment_agent"  // –ê–≥–µ–Ω—Ç—Å–∫–∞—è —Å—Ö–µ–º–∞
         }
       ]
     },
     "metadata": {
       "orderId": "507f...",
       "shopId": "507f...",
       "customerId": "507f..."
     }
   }
   ```
5. –ÆKassa –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
   ```json
   {
     "id": "2d7c3f9a-000f-5000-a000-1ebf6c199b31",
     "status": "pending",
     "confirmation": {
       "type": "redirect",
       "confirmation_url": "https://yoomoney.ru/checkout/payments/v2/..."
     },
     "expires_at": "2024-11-23T12:00:00.000Z"
   }
   ```
6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `OrderPayment`:
   ```typescript
   {
     yookassa: {
       paymentId: "2d7c3f9a-000f-5000-a000-1ebf6c199b31",
       status: "pending",
       expiresAt: Date
     }
   }
   ```
7. –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ `confirmation_url`

**API:** `POST /customer/orders/:id/pay`

### –í–∞–∂–Ω–æ

- **capture: false** - –¥–≤—É—Ö—à–∞–≥–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞ (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)
- **receipt** - –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏–∏ (54-–§–ó)
- **agent_type** - —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∞–≥–µ–Ω—Ç—Å–∫—É—é —Å—Ö–µ–º—É

---

## 2. –û–ø–ª–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–º

**–ê–∫—Ç–æ—Ä:** Customer + –ÆKassa

### –°—Ü–µ–Ω–∞—Ä–∏–π

1. –ö–ª–∏–µ–Ω—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ÆKassa –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:
   - –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞
   - –°–ë–ü (–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)
   - –ÆMoney
   - –î—Ä—É–≥–∏–µ (QIWI, –±–∞–ª–∞–Ω—Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ —Ç.–¥.)
2. –í–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ (–Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã/—Ç–µ–ª–µ—Ñ–æ–Ω–∞)
3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—É (3D-Secure –¥–ª—è –∫–∞—Ä—Ç)
4. –ÆKassa **–∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç** –ø–ª–∞—Ç—ë–∂:
   - –î–µ–Ω—å–≥–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ
   - –°—Ç–∞—Ç—É—Å ‚Üí `waiting_for_capture`
5. –ÆKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç **webhook** –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É

---

## 3. Webhook –æ—Ç –ÆKassa

**–ê–∫—Ç–æ—Ä:** –ÆKassa ‚Üí Platform

### –°—Ü–µ–Ω–∞—Ä–∏–π

1. –ÆKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST-–∑–∞–ø—Ä–æ—Å: `POST /webhooks/yookassa`
2. Payload:
   ```json
   {
     "type": "notification",
     "event": "payment.waiting_for_capture",
     "object": {
       "id": "2d7c3f9a-000f-5000-a000-1ebf6c199b31",
       "status": "waiting_for_capture",
       "amount": { "value": "1500.00", "currency": "RUB" },
       "payment_method": {
         "type": "bank_card",
         "card": {
           "first6": "555555",
           "last4": "4444",
           "card_type": "MasterCard"
         }
       },
       "captured_at": null,
       "metadata": {
         "orderId": "507f...",
         "shopId": "507f..."
       }
     }
   }
   ```
3. –°–∏—Å—Ç–µ–º–∞ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç webhook (IP, –ø–æ–¥–ø–∏—Å—å)
4. –û–±–Ω–æ–≤–ª—è–µ—Ç `OrderPayment`:
   ```typescript
   {
     status: "WAITING_FOR_CAPTURE",
     yookassa: {
       status: "waiting_for_capture",
       paymentMethod: "bank_card",
       paid: false
     }
   }
   ```
5. `Order.status = PENDING_CAPTURE`

**API:** `POST /webhooks/yookassa`

### –í–∞–ª–∏–¥–∞—Ü–∏—è webhook

```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ IP –ÆKassa
const allowedIPs = ['185.71.76.0/27', '185.71.77.0/27', '77.75.153.0/25'];

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
const signature = req.headers['x-yookassa-signature'];
```

---

## 4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (Capture)

**–ê–∫—Ç–æ—Ä:** Platform (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

### –°—Ü–µ–Ω–∞—Ä–∏–π

1. **–£—Å–ª–æ–≤–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:**
   - `OrderPayment.status = WAITING_FOR_CAPTURE`
   - –¢–æ–≤–∞—Ä—ã –¥–æ—Å—Ç—É–ø–Ω—ã (—Ä–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–µ–Ω)
   - –ú–∞–≥–∞–∑–∏–Ω –ø—Ä–∏–Ω—è–ª –∑–∞–∫–∞–∑
2. –°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ –ÆKassa:
   ```json
   POST /payments/{payment_id}/capture
   {
     "amount": {
       "value": "1500.00",
       "currency": "RUB"
     }
   }
   ```
3. –ÆKassa **—Å–ø–∏—Å—ã–≤–∞–µ—Ç** –¥–µ–Ω—å–≥–∏ —Å –∫–∞—Ä—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞
4. Webhook —Å `event: payment.succeeded`
5. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è:
   ```typescript
   {
     // OrderPayment
     status: "SUCCEEDED",
     yookassa: {
       status: "succeeded",
       paid: true,
       capturedAt: new Date(),
       receiptId: "..."  // ID —Ñ–∏—Å–∫–∞–ª—å–Ω–æ–≥–æ —á–µ–∫–∞
     }
   }
   
   {
     // Order
     status: "PAID",
     paidAt: new Date()
   }
   ```
6. –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤: `shopProduct.stockQuantity -= quantity`
7. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω—É: "üì¶ –ù–æ–≤—ã–π –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑ #12345"

**–í–∞–∂–Ω–æ:** Capture –¥–µ–ª–∞–µ—Ç—Å—è **–ø–æ—Å–ª–µ** –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–∫–∞–∑–∞ –º–∞–≥–∞–∑–∏–Ω–æ–º, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∏—Å—ã–≤–∞—Ç—å –¥–µ–Ω—å–≥–∏ –∑—Ä—è.

---

## 5. –û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞ (Cancel)

**–ê–∫—Ç–æ—Ä:** Platform –∏–ª–∏ Customer

### –ü—Ä–∏—á–∏–Ω—ã

- –ö–ª–∏–µ–Ω—Ç –æ—Ç–º–µ–Ω–∏–ª –∑–∞–∫–∞–∑ –¥–æ capture
- –ú–∞–≥–∞–∑–∏–Ω –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–∞–∫–∞–∑
- –ò—Å—Ç—ë–∫ —Å—Ä–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (expiresAt)
- –¢–æ–≤–∞—Ä–∞ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π

1. –°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –ÆKassa:
   ```json
   POST /payments/{payment_id}/cancel
   ```
2. –ÆKassa **—Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç** –¥–µ–Ω—å–≥–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
3. Webhook: `payment.canceled`
4. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è:
   ```typescript
   {
     // OrderPayment
     status: "CANCELED",
     yookassa: {
       status: "canceled"
     }
   }
   
   {
     // Order
     status: "PAYMENT_CANCELED"
   }
   ```
5. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É: "–ü–ª–∞—Ç—ë–∂ –æ—Ç–º–µ–Ω—ë–Ω, –¥–µ–Ω—å–≥–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã"

**API:** `POST /platform/payments/:id/cancel`

---

## 6. –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ (Refund)

**–ê–∫—Ç–æ—Ä:** PlatformStaff –∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –ü—Ä–∏—á–∏–Ω—ã

- –ö–ª–∏–µ–Ω—Ç –≤–µ—Ä–Ω—É–ª —Ç–æ–≤–∞—Ä
- –ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–∞—á–µ—Å—Ç–≤–æ–º
- –ú–∞–≥–∞–∑–∏–Ω –Ω–µ –¥–æ—Å—Ç–∞–≤–∏–ª –∑–∞–∫–∞–∑
- –°–ø–æ—Ä —Ä–µ—à—ë–Ω –≤ –ø–æ–ª—å–∑—É –∫–ª–∏–µ–Ω—Ç–∞

### –°—Ü–µ–Ω–∞—Ä–∏–π (–ø–æ–ª–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç)

1. –°–æ–∑–¥–∞–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞:
   ```json
   POST /refunds
   {
     "payment_id": "2d7c3f9a-000f-5000-a000-1ebf6c199b31",
     "amount": {
       "value": "1500.00",
       "currency": "RUB"
     },
     "receipt": {
       "customer": {...},
       "items": [...]  // –¢–µ –∂–µ –ø–æ–∑–∏—Ü–∏–∏ —Å –ø—Ä–∏–∑–Ω–∞–∫–æ–º –≤–æ–∑–≤—Ä–∞—Ç–∞
     }
   }
   ```
2. –ÆKassa –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç (1-7 –¥–Ω–µ–π)
3. Webhook: `refund.succeeded`
4. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è:
   ```typescript
   {
     // OrderPayment
     status: "REFUNDED",
     refundedAmount: 1500,
     yookassa: {
       refundedAmount: 1500
     },
     references: {
       refundIds: ["2d7c4000-000f-5000-9000-1c3e2c7b5f9a"]
     }
   }
   
   {
     // Order
     status: "REFUNDED"
   }
   ```
5. –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ `SettlementPeriod`: —É–º–µ–Ω—å—à–µ–Ω–∏–µ –≤—ã—Ä—É—á–∫–∏ —Å–µ–ª–ª–µ—Ä–∞
6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –∫–ª–∏–µ–Ω—Ç—É –∏ —Å–µ–ª–ª–µ—Ä—É

**API:** `POST /platform/refunds`

### –ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç

```json
{
  "amount": {
    "value": "500.00",  // –ß–∞—Å—Ç—å —Å—É–º–º—ã
    "currency": "RUB"
  }
}
```

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:
```typescript
{
  status: "PARTIALLY_REFUNDED",
  refundedAmount: 500
}
```

---

## –°—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–∞

| –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ | –§–∏–Ω–∞–ª—å–Ω—ã–π? |
|--------|----------|------------|
| `PENDING` | –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã | ‚ùå |
| `WAITING_FOR_CAPTURE` | –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –∂–¥—ë—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è | ‚ùå |
| `SUCCEEDED` | –û–ø–ª–∞—á–µ–Ω –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω | ‚úÖ |
| `CANCELED` | –û—Ç–º–µ–Ω—ë–Ω (–¥–µ–Ω—å–≥–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã) | ‚úÖ |
| `REFUNDED` | –ü–æ–ª–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç | ‚úÖ |
| `PARTIALLY_REFUNDED` | –ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç | ‚ùå |

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª

```
PENDING ‚Üí WAITING_FOR_CAPTURE ‚Üí SUCCEEDED
   ‚Üì              ‚Üì                  ‚Üì
CANCELED      CANCELED           REFUNDED / PARTIALLY_REFUNDED
```

---

## –ú–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã

–ÆKassa –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:

| –ú–µ—Ç–æ–¥ | –ö–æ–¥ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|-------|-----|------------|
| –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ | `bank_card` | Visa, MasterCard, –ú–∏—Ä |
| –°–ë–ü | `sbp` | –°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π |
| –ÆMoney | `yoo_money` | –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∫–æ—à–µ–ª—ë–∫ |
| QIWI | `qiwi` | –ö–æ—à–µ–ª—ë–∫ QIWI |
| –ë–∞–ª–∞–Ω—Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ | `mobile_balance` | –û–ø–µ—Ä–∞—Ç–æ—Ä—ã —Å–≤—è–∑–∏ |
| –ù–∞–ª–∏—á–Ω—ã–µ | `cash` | –¢–µ—Ä–º–∏–Ω–∞–ª—ã (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) |

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:** –±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –∏ –°–ë–ü (–±–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞).

---

## –§–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è (–ß–µ–∫–∏)

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è 54-–§–ó

–ß–µ–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
- **–ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞** —Å —Ü–µ–Ω–∞–º–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
- **–ù–î–°** (vat_code: 1 - 20%, 2 - 10%, 6 - –±–µ–∑ –ù–î–°)
- **–ü—Ä–∏–∑–Ω–∞–∫ —Å–ø–æ—Å–æ–±–∞ —Ä–∞—Å—á—ë—Ç–∞:** full_prepayment (–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 100%)
- **–ü—Ä–∏–∑–Ω–∞–∫ –ø—Ä–µ–¥–º–µ—Ç–∞ —Ä–∞—Å—á—ë—Ç–∞:** commodity (—Ç–æ–≤–∞—Ä)
- **–ê–≥–µ–Ω—Ç—Å–∫–∏–π –ø—Ä–∏–∑–Ω–∞–∫:** payment_agent

### –ê–≥–µ–Ω—Ç—Å–∫–∞—è —Å—Ö–µ–º–∞ –≤ —á–µ–∫–µ

```json
{
  "agent_type": "payment_agent",
  "supplier_info": {
    "name": "–û–û–û –§—Ä—É–∫—Ç–æ–≤–∞—è –±–∞–∑–∞",
    "inn": "1234567890",
    "phones": ["+79991234567"]
  }
}
```

**–¢–µ–≥–∏:**
- 1057 - –ø—Ä–∏–∑–Ω–∞–∫ –∞–≥–µ–Ω—Ç–∞ (payment_agent)
- 1222 - –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
- 1223 - —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞

### –ö–æ–≥–¥–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —á–µ–∫

1. **–ü—Ä–∏ –æ–ø–ª–∞—Ç–µ (–ø—Ä–∏—Ö–æ–¥):** –∫–ª–∏–µ–Ω—Ç –ø–ª–∞—Ç–∏—Ç ‚Üí –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø—Ä–æ–±–∏–≤–∞–µ—Ç —á–µ–∫
2. **–ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ (–≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏—Ö–æ–¥–∞):** –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç ‚Üí —á–µ–∫ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç

**receiptId** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `orderPayment.yookassa.receiptId`.

---

## Webhook —Å–æ–±—ã—Ç–∏—è

| –°–æ–±—ã—Ç–∏–µ | –ö–æ–≥–¥–∞ | –î–µ–π—Å—Ç–≤–∏–µ |
|---------|-------|----------|
| `payment.waiting_for_capture` | –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω | –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å, –æ–∂–∏–¥–∞—Ç—å capture |
| `payment.succeeded` | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω | –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –∑–∞–∫–∞–∑ –≤ PAID, –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã |
| `payment.canceled` | –û—Ç–º–µ–Ω—ë–Ω | –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å, —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã |
| `refund.succeeded` | –í–æ–∑–≤—Ä–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω | –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å, —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å—ã |

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ IP –∏—Å—Ç–æ—á–Ω–∏–∫–∞:** —Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å–∞ –ÆKassa
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏:** `X-YooKassa-Signature` (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
3. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ webhook –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –≤—Å–µ webhook –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞

---

## –ö–æ–º–∏—Å—Å–∏–∏ –∏ —Ä–∞—Å—á—ë—Ç—ã

### –ö–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

```
–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞: 1500‚ÇΩ
–ö–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã: 300‚ÇΩ (20%)
–í—ã–ø–ª–∞—Ç–∞ —Å–µ–ª–ª–µ—Ä—É: 1200‚ÇΩ
```

**–£–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- –°–µ–ª–ª–µ—Ä –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –≤—ã—Ä—É—á–∫—É (1200‚ÇΩ)
- –ö–æ–º–∏—Å—Å–∏—è —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ `SettlementPeriod`

### –ö–æ–º–∏—Å—Å–∏—è –ÆKassa

```
–¢–∞—Ä–∏—Ñ: ~2.8% + 10‚ÇΩ –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏—é
–û—Ç 1500‚ÇΩ: 52‚ÇΩ

–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–ª–∞—Ç–∏—Ç –∏–∑ —Å–≤–æ–µ–π –∫–æ–º–∏—Å—Å–∏–∏.
```

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–≤–æ–¥–∫–∞

### –°—É—â–Ω–æ—Å—Ç—å OrderPayment

```typescript
{
  order: ObjectId,
  shopAccount: ObjectId,
  amount: number,
  settlementPeriod: ObjectId,
  status: OrderPaymentStatus,
  refundedAmount: number,
  yookassa: {
    paymentId: string,
    status: string,
    paymentMethod: string,
    paid: boolean,
    capturedAt?: Date,
    expiresAt?: Date,
    refundedAmount?: number,
    receiptId?: string,
    metadata?: any
  },
  references: {
    transactionIds?: string[],
    refundIds?: string[]
  }
}
```

### API

**Customer:**
- `POST /customer/orders/:id/pay` - –∏–Ω–∏—Ü–∏–∞—Ü–∏—è –æ–ø–ª–∞—Ç—ã

**Platform:**
- `POST /webhooks/yookassa` - webhook –æ—Ç –ÆKassa
- `POST /platform/payments/:id/capture` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- `POST /platform/payments/:id/cancel` - –æ—Ç–º–µ–Ω–∞
- `POST /platform/refunds` - –≤–æ–∑–≤—Ä–∞—Ç

**–ÆKassa:**
- `POST /payments` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- `POST /payments/:id/capture` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- `POST /payments/:id/cancel` - –æ—Ç–º–µ–Ω–∞
- `POST /refunds` - –≤–æ–∑–≤—Ä–∞—Ç

### –ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞

1. **–î–≤—É—Ö—à–∞–≥–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞:** –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Üí capture (–ø–æ—Å–ª–µ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–∫–∞–∑–∞ –º–∞–≥–∞–∑–∏–Ω–æ–º)
2. **–ê–≤—Ç–æ–æ—Ç–º–µ–Ω–∞:** –µ—Å–ª–∏ –º–∞–≥–∞–∑–∏–Ω –Ω–µ –ø—Ä–∏–Ω—è–ª –∑–∞ N –º–∏–Ω—É—Ç ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π cancel
3. **–†–µ–∑–µ—Ä–≤ —Ç–æ–≤–∞—Ä–æ–≤:** —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ capture
4. **–§–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞:** —á–µ–∫ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
5. **–ê–≥–µ–Ω—Ç—Å–∫–∞—è —Å—Ö–µ–º–∞:** –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∫–∞–∫ payment_agent –≤ —á–µ–∫–∞—Ö
6. **–í–æ–∑–≤—Ä–∞—Ç:** —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ captured, —á–∞—Å—Ç–∏—á–Ω—ã–π –∏–ª–∏ –ø–æ–ª–Ω—ã–π
7. **–ö–æ–º–∏—Å—Å–∏—è —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:** –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ —Å —Å–µ–ª–ª–µ—Ä–æ–º
8. **Webhook –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è

---

## –ü—Ä–∏–º–µ—Ä—ã

### –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞

```typescript
// 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
const payment = await paymentService.create(orderId);
// ‚Üí redirect –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –ÆKassa

// 2. Webhook: waiting_for_capture
await paymentService.handleWebhook({
  event: "payment.waiting_for_capture",
  object: { id: paymentId, status: "waiting_for_capture" }
});
// ‚Üí Order.status = PENDING_CAPTURE

// 3. –ú–∞–≥–∞–∑–∏–Ω –ø—Ä–∏–Ω—è–ª –∑–∞–∫–∞–∑ ‚Üí capture
await paymentService.capturePayment(paymentId);
// ‚Üí Order.status = PAID, —Ç–æ–≤–∞—Ä—ã –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω—ã

// 4. Webhook: succeeded
await paymentService.handleWebhook({
  event: "payment.succeeded",
  object: { id: paymentId, status: "succeeded" }
});
// ‚Üí –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è, —á–µ–∫ –ø—Ä–æ–±–∏—Ç
```

### –í–æ–∑–≤—Ä–∞—Ç

```typescript
// –ö–ª–∏–µ–Ω—Ç –≤–µ—Ä–Ω—É–ª —Ç–æ–≤–∞—Ä ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞
await paymentService.createRefund({
  paymentId,
  amount: 1500,  // –ü–æ–ª–Ω–∞—è —Å—É–º–º–∞
  reason: "–¢–æ–≤–∞—Ä –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–∞—á–µ—Å—Ç–≤—É"
});

// Webhook: refund.succeeded (—á–µ—Ä–µ–∑ 1-7 –¥–Ω–µ–π)
// ‚Üí OrderPayment.status = REFUNDED
// ‚Üí SettlementPeriod –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è
```

---

## –°–≤—è–∑—å —Å –¥—Ä—É–≥–∏–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏

**Order Flow:**
- –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞—ë—Ç—Å—è ‚Üí –ø–ª–∞—Ç—ë–∂ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç—Å—è
- –ü–ª–∞—Ç—ë–∂ capture ‚Üí –∑–∞–∫–∞–∑ –≤ —Ä–∞–±–æ—Ç—É
- –í–æ–∑–≤—Ä–∞—Ç ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞–∫–∞–∑–∞

**Finance Flow:**
- –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç—ë–∂ ‚Üí +–≤—ã—Ä—É—á–∫–∞ –≤ SettlementPeriod
- –í–æ–∑–≤—Ä–∞—Ç ‚Üí -–≤—ã—Ä—É—á–∫–∞ –≤ SettlementPeriod
- –ö–æ–º–∏—Å—Å–∏—è —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ

---

> **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤  
> **–ü—Ä–æ–≤–∞–π–¥–µ—Ä:** –ÆKassa  
> **–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 2024-11-23