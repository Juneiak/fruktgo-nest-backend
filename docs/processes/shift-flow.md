# Процесс: Управление сменами

**Участники:** Employee, Seller, Shop, PlatformStaff  
**Зависимости:** Shift Module, Shop Module, Employee Module

---

## Краткое содержание

### Основная идея

Сотрудник открывает **смену** перед началом работы в магазине. Смена фиксирует SLA (время принятия заказа, время сборки), отслеживает все действия сотрудника, накапливает статистику. В конце дня сотрудник **закрывает** смену — система подсчитывает итоги: выручка, количество заказов, штрафы.

**Главное:** на магазин может быть только одна активная смена. Все операции магазина (принятие заказов, сборка) возможны только в рамках открытой смены.

### Ключевая логика

**State Machine (машина состояний):**
- `OPEN` — смена работает, сотрудник обслуживает заказы
- `PAUSED` — временная пауза (обед, перерыв)
- `CLOSING` — идёт закрытие (пересчёт денег, инвентаризация)
- `CLOSED` — смена закрыта нормально
- `ABANDONED` — смена прервана аварийно (сотрудник забыл закрыть, технические проблемы)

**Фиксация SLA:**
- При открытии смены копируются текущие SLA магазина (snapshot)
- Даже если магазин изменит SLA в настройках, смена работает по старым значениям
- Это защищает от изменения правил в середине дня

**Event Log (журнал событий):**
- Все действия логируются: открытие, пауза, возобновление, закрытие
- Каждое событие с timestamp и актором
- Используется для аудита и разбирательств

**Статистика в реальном времени:**
- Количество принятых/отклонённых заказов
- Выручка смены
- Средние времена обработки
- Штрафы за просрочки

### Паузы и закрытие

Сотрудник может поставить смену на паузу (обед, перерыв). В это время магазин не принимает новые заказы. При закрытии система проверяет: все ли заказы смены выполнены? Если есть незавершённые — предупреждение.

---

## Обзор

Жизненный цикл рабочих смен магазина с использованием **State Machine** и **Event Sourcing**.

**Смена** - период работы магазина с фиксированными SLA параметрами и отслеживанием всех действий.

**Ключевые принципы:**
- На магазин может быть **только одна** активная смена (OPEN/CLOSING)
- Все действия логируются в журнале событий (Event Log)
- SLA фиксируется на момент открытия (snapshot)
- Статистика пересчитывается в реальном времени

---

## State Machine (Машина состояний)

```
              ┌──────────────────────────┐
              │      OPEN (открыта)      │
              └──────────────────────────┘
                 │    │    │         │
    ┌────────────┘    │    └─────────┼──────────┐
    │                 │              │          │
    ▼                 ▼              ▼          ▼
┌────────┐      ┌──────────┐   ┌─────────┐  ┌───────────┐
│ PAUSED │◄─────┤ CLOSING  │   │ CLOSED  │  │ ABANDONED │
└────────┘      └──────────┘   └─────────┘  └───────────┘
    │                 │              ▲          ▲
    │                 │              │          │
    └─────────────────┼──────────────┼──────────┘
                      │              │
                      └──────────────┘
```

### Статусы

| Статус | Описание | Тип | Активная? |
|--------|----------|-----|-----------|
| `OPEN` | Смена открыта, работает | Рабочий | ✅ Да |
| `PAUSED` | На паузе (перерыв) | Рабочий | ❌ Нет |
| `CLOSING` | В процессе закрытия | Рабочий | ✅ Да |
| `CLOSED` | Закрыта нормально | Финальный | ❌ Нет |
| `ABANDONED` | Прервана аварийно | Финальный | ❌ Нет |

**Активная смена:** OPEN или CLOSING (магазин не может открыть новую, пока текущая активна)

---

## 1. Открытие смены

**Актор:** Employee

### Сценарий

1. Сотрудник приходит на работу → в панели магазина → "Открыть смену"
2. **Валидация:**
   - Магазин не имеет активных смен ✓
   - Сотрудник имеет право открывать смены ✓
3. Система создаёт `Shift`:
   ```typescript
   {
     shop: shopId,
     status: "OPEN",
     sla: {
       acceptanceTimeLimit: 300,    // 5 минут на принятие
       assemblyTimeLimit: 900,       // 15 минут на сборку
       minOrderSum: 500,
       openAt: Date,                 // Время работы магазина
       closedAt: Date
     },
     openedBy: {
       actorType: "Employee",
       actorId: employeeId,
       actorName: "Иван Иванов"
     },
     openedAt: new Date(),
     events: [
       { type: "OPEN", at: Date, by: Actor, comment: "Начало смены" }
     ]
   }
   ```
4. Обновления:
   - `shop.currentShift = shiftId`
   - `shop.status = OPENED`
   - `employee.openedShift = shiftId`

**API:** `POST /employee/shifts/open`

### Зачем SLA snapshot?

SLA магазина может измениться во время смены. Snapshot гарантирует:
- Корректную аналитику за смену
- Честные метрики по принятым в эту смену заказам
- Историческую точность

---

## 2. Пауза смены

**Актор:** Employee

### Сценарий

1. Сотрудник → "Поставить на паузу" (например, обед)
2. **Валидация:** Текущий статус `OPEN`
3. Система обновляет:
   ```typescript
   {
     status: "PAUSED",
     events: [
       ...,
       { type: "PAUSE", at: Date, by: Actor, comment: "Перерыв на обед" }
     ]
   }
   ```
4. **Эффект:**
   - Магазин перестаёт принимать новые заказы
   - `shop.status` остаётся `OPENED` (смена активна)
   - Активные заказы продолжают обрабатываться

**API:** `PATCH /employee/shifts/:id/pause`

---

## 3. Возобновление смены

**Актор:** Employee

### Сценарий

1. Сотрудник → "Возобновить"
2. **Валидация:** Текущий статус `PAUSED`
3. Обновление:
   ```typescript
   {
     status: "OPEN",
     events: [
       ...,
       { type: "RESUME", at: Date, by: Actor }
     ]
   }
   ```
4. Магазин снова принимает заказы

**API:** `PATCH /employee/shifts/:id/resume`

---

## 4. Начало закрытия

**Актор:** Employee

### Сценарий

1. Сотрудник в конце смены → "Начать закрытие"
2. **Валидация:** Статус `OPEN` или `PAUSED`
3. Обновление:
   ```typescript
   {
     status: "CLOSING",
     events: [
       ...,
       { type: "START_CLOSING", at: Date, by: Actor }
     ]
   }
   ```
4. **Эффекты:**
   - Магазин перестаёт принимать **новые** заказы
   - Текущие заказы завершаются
   - Сотрудник проводит закрывающие операции (инвентаризация, уборка и т.д.)

**API:** `PATCH /employee/shifts/:id/start-closing`

---

## 5. Закрытие смены

**Актор:** Employee

### Сценарий

1. Завершены все операции → "Закрыть смену"
2. **Валидация:** 
   - Текущий статус `CLOSING`
   - Нет активных заказов (опционально, зависит от бизнес-логики)
3. Обновление:
   ```typescript
   {
     status: "CLOSED",  // Финальный статус
     closedBy: Actor,
     closedAt: new Date(),
     events: [
       ...,
       { type: "CLOSE", at: Date, by: Actor, comment: "Смена закрыта" }
     ]
   }
   ```
4. Обновления:
   - `shop.currentShift = null`
   - `employee.openedShift = null`
   - Финальная статистика зафиксирована

**API:** `PATCH /employee/shifts/:id/close`

**Важно:** Из статуса `CLOSED` нельзя вернуться. Это финальное состояние.

---

## 6. Принудительное закрытие

**Актор:** PlatformStaff (Admin) или Seller

### Причины

- Аварийная ситуация
- Блокировка магазина
- Технические проблемы
- Нарушения со стороны сотрудника

### Сценарий

1. Админ/Seller → "Принудительно закрыть смену"
2. **Валидация:**
   - Актор имеет права (Admin всегда, Seller для своих магазинов)
   - Текущий статус `OPEN`, `PAUSED` или `CLOSING`
3. Обновление:
   ```typescript
   {
     status: "CLOSED",
     closedBy: Actor,
     closedAt: new Date(),
     events: [
       ...,
       { 
         type: "FORCE_CLOSE", 
         at: Date, 
         by: Actor, 
         comment: "Магазин закрыт на ремонт" 
       }
     ]
   }
   ```
4. **Эффекты:**
   - Активные заказы отменяются или переназначаются
   - Сотрудник получает уведомление

**API:** 
- `PATCH /platform/shifts/:id/force-close` (Admin)
- `PATCH /seller/shifts/:id/abandon` (Seller)

---

## 7. Прерывание смены (Abandon)

**Актор:** Seller или PlatformStaff

### Причины

- Критическая ошибка
- Сотрудник не закрыл смену
- Форс-мажор

### Сценарий

1. Актор → "Прервать смену"
2. Обновление:
   ```typescript
   {
     status: "ABANDONED",  // Финальный статус
     closedBy: Actor,
     closedAt: new Date(),
     events: [
       ...,
       { 
         type: "ABANDON", 
         at: Date, 
         by: Actor, 
         reason: "Сотрудник не закрыл смену" 
       }
     ]
   }
   ```

**Отличие от FORCE_CLOSE:**
- `FORCE_CLOSE` → `CLOSED` (нормальное закрытие администратором)
- `ABANDON` → `ABANDONED` (аварийное прерывание, требует расследования)

**API:** `PATCH /seller/shifts/:id/abandon`

---

## Event Log (Журнал событий)

Все действия со сменой записываются в массив `events`:

```typescript
[
  { type: "OPEN", at: "2024-11-22T08:00:00Z", by: Employee, comment: "Начало смены" },
  { type: "PAUSE", at: "2024-11-22T12:00:00Z", by: Employee, comment: "Обед" },
  { type: "RESUME", at: "2024-11-22T13:00:00Z", by: Employee },
  { type: "START_CLOSING", at: "2024-11-22T20:00:00Z", by: Employee },
  { type: "CLOSE", at: "2024-11-22T20:30:00Z", by: Employee, comment: "Смена закрыта" }
]
```

**Использование:**
- Аудит всех действий
- Восстановление истории смены
- Анализ производительности
- Расследование инцидентов

---

## Статистика смены

Агрегируется в реальном времени при изменении заказов:

```typescript
{
  ordersCount: 45,                  // Всего заказов
  deliveredOrdersCount: 42,         // Доставлено
  canceledOrdersCount: 2,           // Отменено клиентом
  declinedOrdersCount: 1,           // Отклонено магазином
  totalIncome: 45000,               // Доход ₽
  declinedIncome: 1200,             // Упущенный доход ₽
  avgOrderPrice: 1000,              // Средний чек ₽
  avgOrderAcceptanceDuration: 180,  // Среднее принятие (сек)
  avgOrderAssemblyDuration: 720     // Средняя сборка (сек)
}
```

**Обновление:** При каждом изменении статуса заказа через `UpdateStatisticsCommand`.

---

## Матрица переходов статусов

| Из \ В | OPEN | PAUSED | CLOSING | CLOSED | ABANDONED |
|--------|------|--------|---------|--------|-----------|
| **OPEN** | ❌ | ✅ | ✅ | ✅* | ✅* |
| **PAUSED** | ✅ | ❌ | ✅ | ✅* | ✅* |
| **CLOSING** | ❌ | ❌ | ❌ | ✅ | ✅* |
| **CLOSED** | ❌ | ❌ | ❌ | ❌ | ❌ |
| **ABANDONED** | ❌ | ❌ | ❌ | ❌ | ❌ |

`*` - только через force_close или abandon

**Правила:**
- Финальные статусы (CLOSED, ABANDONED) необратимы
- PAUSED ↔ OPEN - свободный переход
- CLOSING → только в финальные статусы

---

## Actor-based tracking

Каждое действие привязывается к актору:

```typescript
interface Actor {
  actorType: "Employee" | "Seller" | "Admin",
  actorId: ObjectId,
  actorName: string  // Для человекочитаемости
}
```

**Примеры:**
- Employee открыл смену
- Seller принудительно закрыл
- Admin прервал из-за нарушений

**Польза:**
- Ответственность за действия
- Аудит и расследования
- Метрики производительности

---

## Бизнес-правила

1. **Уникальная активная смена:** Магазин не может открыть новую смену, пока текущая OPEN/CLOSING
2. **SLA snapshot:** Фиксируется при открытии, не меняется во время смены
3. **Event Sourcing:** Все события логируются, нельзя изменить прошлое
4. **Финальные статусы:** CLOSED и ABANDONED необратимы
5. **Обязательный актор:** Каждое действие требует указания, кто его совершил
6. **Пауза не закрывает смену:** PAUSED - это всё ещё активная смена
7. **CLOSING блокирует новые заказы:** Но текущие завершаются

---

## Техническая сводка

### Сущность Shift

```typescript
{
  shop: ObjectId,
  status: ShiftStatus,              // OPEN/PAUSED/CLOSING/CLOSED/ABANDONED
  sla: SlaSnapshot,                 // Зафиксированные SLA на момент открытия
  statistics: Statistics,           // Агрегаты по заказам
  openedBy: Actor,
  openedAt: Date,
  closedBy?: Actor,
  closedAt?: Date,
  events: ShiftEvent[],             // Журнал всех событий
  createdAt: Date,
  updatedAt: Date
}
```

### API

**Employee:**
- `POST /employee/shifts/open` - открыть смену
- `PATCH /employee/shifts/:id/pause` - пауза
- `PATCH /employee/shifts/:id/resume` - возобновить
- `PATCH /employee/shifts/:id/start-closing` - начать закрытие
- `PATCH /employee/shifts/:id/close` - закрыть

**Seller:**
- `GET /seller/shifts` - история смен магазинов
- `GET /seller/shifts/:id` - детали смены
- `PATCH /seller/shifts/:id/abandon` - прервать

**Platform:**
- `GET /platform/shifts` - все смены (фильтры)
- `PATCH /platform/shifts/:id/force-close` - принудительно закрыть

### Индексы

```typescript
// Гарантирует только одну активную смену на магазин
{
  shop: 1
} unique where status in [OPEN, CLOSING]
```

---

## Примеры

### Нормальная рабочая смена

```typescript
// 08:00 - Сотрудник открывает смену
await shiftPort.openShift({
  shopId,
  sla: {...},
  actor: { actorType: "Employee", actorId, actorName: "Иван" }
});

// 12:00 - Обед
await shiftPort.pauseShift(shiftId, {
  actor: employeeActor,
  comment: "Обед"
});

// 13:00 - Возвращение
await shiftPort.resumeShift(shiftId, { actor: employeeActor });

// 20:00 - Начало закрытия
await shiftPort.startClosing(shiftId, { actor: employeeActor });

// 20:30 - Смена закрыта
await shiftPort.closeShift(shiftId, {
  actor: employeeActor,
  comment: "Все операции завершены"
});

// Итог: 5 событий в журнале, финальная статистика
```

### Принудительное закрытие

```typescript
// Админ закрывает смену из-за нарушений
await shiftPort.forceCloseShift(shiftId, {
  actor: {
    actorType: "Admin",
    actorId: adminId,
    actorName: "Админ Платформы"
  },
  comment: "Магазин закрыт на проверку"
});

// Статус: CLOSED
// Событие: FORCE_CLOSE
// Сотрудник получает уведомление
```

---

## Связь с другими процессами

**Order Flow:**
- Заказы обрабатываются только в активной смене
- При закрытии смены (CLOSING) новые заказы не принимаются
- Статистика смены обновляется при изменении статусов заказов

**Employee:**
- `employee.openedShift` указывает на текущую смену
- При открытии смены: привязка
- При закрытии: отвязка

**Shop:**
- `shop.currentShift` указывает на активную смену
- `shop.status` зависит от статуса смены

---

> **Статус:** ✅ Готов  
> **Обновлено:** 2024-11-23