# Процесс: Корзина (Cart Flow)

**Участники:** Customer  
**Длительность:** от добавления первого товара до checkout  
**Зависимости:** Customer Module, Shop Module, ShopProduct Module

---

## Краткое содержание

### Основная идея

Клиент выбирает товары из каталога магазина, добавляет их в **корзину** с указанием количества. Корзина привязана к **одному магазину** — при смене магазина корзина очищается. Перед checkout клиент указывает **адрес доставки**, система рассчитывает стоимость и время. После успешного checkout корзина очищается, создаётся заказ.

**Весь цикл:** выбор магазина → добавление товаров → настройка доставки → валидация → checkout.

### Ключевая логика

**Один магазин:**
- Корзина содержит товары только из одного магазина
- Попытка добавить товар из другого магазина — предупреждение + требование подтверждения очистки
- Это упрощает логистику: один заказ = один магазин = одна доставка

**Актуальность данных:**
- При открытии корзины проверяется актуальность всех товаров
- Если товар стал недоступен — автоматическое удаление с уведомлением
- Если остаток уменьшился — корректировка количества

**Валидация перед checkout:**
- Проверка магазина (открыт, есть активная смена)
- Проверка товаров (в наличии, достаточно остатков)
- Проверка суммы (>= минимальной суммы заказа)
- Проверка доставки (адрес установлен)

### Состояния корзины

`EMPTY` → `SHOP_SELECTED` → `HAS_PRODUCTS` → `DELIVERY_SET` → `READY_TO_ORDER`

При любой проблеме корзина возвращается в состояние `HAS_PRODUCTS` или ниже.

---

## Обзор

Корзина — временное хранилище выбранных клиентом товаров перед оформлением заказа. Корзина привязана к конкретному магазину и содержит информацию о доставке.

---

## Жизненный цикл корзины

```
[Пустая корзина]
       │
       ▼ (добавление первого товара)
[Выбор магазина] ──────────────────────────────┐
       │                                        │
       ▼                                        │
[Наполнение корзины]                           │
       │                                        │
       ├── добавить товар ◄─────────────────────┤
       ├── изменить количество                  │
       ├── удалить товар                        │
       │                                        │
       ▼ (установка адреса доставки)            │
[Выбор доставки]                               │
       │                                        │
       ▼ (валидация)                            │
[Готова к оформлению] ─── checkout ─► [Заказ создан]
       │                                        │
       └── смена магазина ──────────────────────┘
              (очистка корзины)
```

---

## Ключевые правила

### 1. Привязка к магазину

- Корзина может содержать товары **только из одного магазина**
- При добавлении первого товара корзина привязывается к магазину этого товара
- При смене магазина корзина **полностью очищается** (с подтверждением от клиента)
- После checkout корзина очищается и отвязывается от магазина

### 2. Товары в корзине

| Поле | Описание |
|------|----------|
| `shopProduct` | Ссылка на товар в магазине (ShopProduct) |
| `selectedQuantity` | Выбранное количество/вес |

### 3. Управление количеством

- **Штучные товары**: quantity = целое число (1, 2, 3...)
- **Весовые товары**: quantity = вес в граммах/кг (0.5, 1.2, 2.0...)
- **Минимум**: зависит от measuringScale товара
- **Максимум**: не больше `stockQuantity` товара

### 4. Информация о доставке

```typescript
deliveryInfo: {
  addressId: string;        // ID выбранного адреса клиента
  price: number;            // Стоимость доставки
  estimatedTime: number;    // Ожидаемое время в минутах
}
```

---

## Операции с корзиной

### Выбор магазина (`selectShop`)

**Входные данные:**
- `customerId` — ID клиента
- `shopId` — ID магазина

**Логика:**
1. Если корзина пуста — установить `selectedShopId`
2. Если корзина не пуста и магазин другой:
   - Вернуть предупреждение о необходимости очистки
   - Клиент должен подтвердить действие
3. При подтверждении — очистить корзину и установить новый магазин

**Результат:**
- Магазин выбран
- Или ошибка с требованием подтверждения

---

### Добавление товара (`addProduct`)

**Входные данные:**
- `customerId` — ID клиента
- `shopProductId` — ID товара в магазине
- `quantity` — количество/вес

**Логика:**
1. Проверить, что товар существует и активен
2. Проверить, что товар принадлежит выбранному магазину
3. Если магазин не выбран — установить магазин товара
4. Если товар уже в корзине — увеличить количество
5. Проверить доступный остаток (`stockQuantity`)
6. Добавить товар в корзину
7. Пересчитать `totalSum`

**Валидации:**
- Товар не архивирован
- Товар в статусе `ACTIVE`
- `quantity > 0`
- `quantity <= stockQuantity`
- Товар из того же магазина

**Результат:**
- Товар добавлен
- Обновлённая корзина

---

### Изменение количества (`updateQuantity`)

**Входные данные:**
- `customerId` — ID клиента
- `shopProductId` — ID товара в корзине
- `quantity` — новое количество

**Логика:**
1. Найти товар в корзине
2. Проверить доступный остаток
3. Обновить количество
4. Пересчитать `totalSum`

**Результат:**
- Количество изменено
- Обновлённая корзина

---

### Удаление товара (`removeProduct`)

**Входные данные:**
- `customerId` — ID клиента
- `shopProductId` — ID товара в корзине

**Логика:**
1. Найти товар в корзине
2. Удалить из массива `products`
3. Пересчитать `totalSum`
4. Если корзина стала пустой — сбросить `selectedShopId`

**Результат:**
- Товар удалён
- Обновлённая корзина

---

### Очистка корзины (`clearCart`)

**Входные данные:**
- `customerId` — ID клиента

**Логика:**
1. Очистить массив `products`
2. Сбросить `totalSum = 0`
3. Сбросить `selectedShopId = null`
4. Сбросить `deliveryInfo = null`
5. Установить `isReadyToOrder = false`

**Результат:**
- Корзина очищена

---

### Установка доставки (`setDelivery`)

**Входные данные:**
- `customerId` — ID клиента
- `addressId` — ID адреса доставки

**Логика:**
1. Проверить, что адрес принадлежит клиенту
2. Рассчитать стоимость доставки (на основе расстояния)
3. Рассчитать примерное время доставки
4. Сохранить `deliveryInfo`
5. Обновить флаг `isReadyToOrder`

**Расчёт стоимости доставки:**
```
если расстояние <= бесплатный_радиус:
    цена = 0
иначе:
    цена = базовая_цена + (расстояние - бесплатный_радиус) * цена_за_км
```

**Результат:**
- Доставка установлена
- `isReadyToOrder = true` (если всё валидно)

---

### Валидация перед checkout (`validateCart`)

**Входные данные:**
- `customerId` — ID клиента

**Проверки:**
1. Корзина не пуста
2. Магазин выбран и открыт
3. У магазина есть активная смена
4. Все товары доступны (статус `ACTIVE`)
5. Достаточно остатков для всех товаров
6. Адрес доставки установлен
7. Сумма заказа >= минимальной суммы магазина

**Результат:**
- `{ isValid: true }` — корзина готова
- `{ isValid: false, errors: [...] }` — список проблем

---

## Пересчёт корзины

При любом изменении корзины выполняется пересчёт:

```typescript
function recalculateCart(cart: Cart): void {
  // Пересчёт суммы товаров
  cart.totalSum = cart.products.reduce((sum, item) => {
    const price = item.shopProduct.product.price;
    return sum + (price * item.selectedQuantity);
  }, 0);
  
  // Проверка готовности к заказу
  cart.isReadyToOrder = 
    cart.products.length > 0 &&
    cart.selectedShopId != null &&
    cart.deliveryInfo != null;
}
```

---

## Автоматическая валидация и очистка

### При открытии корзины

Когда клиент открывает корзину, выполняется проверка актуальности:

1. **Проверка магазина:**
   - Магазин всё ещё существует и открыт?
   - Если нет — уведомить клиента и очистить корзину

2. **Проверка товаров:**
   - Для каждого товара в корзине:
     - Товар всё ещё активен?
     - Достаточно остатков?
   - Если товар недоступен — удалить с уведомлением
   - Если остатков меньше — уменьшить количество с уведомлением

3. **Проверка доставки:**
   - Адрес всё ещё существует?
   - Если нет — сбросить `deliveryInfo`

---

## Структура данных

### Cart Schema

```typescript
interface Cart {
  _id: ObjectId;
  
  // Связь с клиентом
  customer: ObjectId;  // ref: Customer
  
  // Выбранный магазин
  selectedShopId: ObjectId | null;  // ref: Shop
  
  // Товары в корзине
  products: Array<{
    shopProduct: ObjectId;      // ref: ShopProduct
    selectedQuantity: number;   // количество/вес
  }>;
  
  // Итоговая сумма товаров (без доставки)
  totalSum: number;
  
  // Информация о доставке
  deliveryInfo: {
    addressId: ObjectId;    // ref: Address
    price: number;          // стоимость доставки
    estimatedTime: number;  // минуты
  } | null;
  
  // Готовность к оформлению
  isReadyToOrder: boolean;
  
  // Timestamps
  createdAt: Date;
  updatedAt: Date;
}
```

---

## События

| Событие | Когда | Payload |
|---------|-------|---------|
| `cart.shop.selected` | Выбран магазин | `{ customerId, shopId }` |
| `cart.product.added` | Добавлен товар | `{ customerId, shopProductId, quantity }` |
| `cart.product.updated` | Изменено количество | `{ customerId, shopProductId, quantity }` |
| `cart.product.removed` | Удалён товар | `{ customerId, shopProductId }` |
| `cart.cleared` | Корзина очищена | `{ customerId }` |
| `cart.delivery.set` | Установлена доставка | `{ customerId, addressId }` |
| `cart.validated` | Валидация пройдена | `{ customerId, isValid, errors? }` |

---

## Ошибки

| Код | Описание |
|-----|----------|
| `CART_EMPTY` | Корзина пуста |
| `CART_SHOP_MISMATCH` | Товар из другого магазина |
| `CART_SHOP_CLOSED` | Магазин закрыт |
| `CART_PRODUCT_UNAVAILABLE` | Товар недоступен |
| `CART_INSUFFICIENT_STOCK` | Недостаточно остатков |
| `CART_MIN_ORDER_NOT_MET` | Сумма меньше минимальной |
| `CART_DELIVERY_NOT_SET` | Доставка не установлена |
| `CART_ADDRESS_INVALID` | Адрес не существует |

---

## Взаимодействие с другими процессами

### → Order Flow

После успешного `checkout`:
1. Корзина передаёт данные в `OrderProcessOrchestrator`
2. Оркестратор создаёт заказ
3. Корзина очищается

### ← ShopProduct

При изменении товара в магазине:
- Если товар стал недоступен — удалить из корзин
- Если остаток уменьшился — скорректировать количество

### ← Shop

При изменении статуса магазина:
- Если магазин закрылся — уведомить клиентов с активными корзинами

---

## Статус реализации

**Модуль:** `src/modules/cart/`  
**Документация:** `docs/modules/main/cart.md`

- [x] Базовые операции с корзиной (selectShop, addProduct, updateQuantity, removeProduct, clearCart)
- [x] Валидация при checkout (validateCart)
- [x] Интеграция с Order Flow (OrderProcessOrchestrator)
- [ ] Автоматическая очистка устаревших данных
- [ ] Расчёт стоимости доставки на основе расстояния
- [ ] События корзины (real-time уведомления)
