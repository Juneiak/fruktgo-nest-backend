# Процесс: Заказ (Order Flow)

**Участники:** Customer, Shop, Employee, PlatformStaff  
**Длительность:** от создания до получения ~30-90 минут  
**Зависимости:** Регистрация клиента, Каталог товаров, Оплата

---

## Краткое содержание

### Основная идея

Клиент добавляет товары в **корзину**, оформляет **заказ**, оплачивает онлайн. Сотрудник магазина **собирает** заказ, курьер **доставляет**. После доставки деньги распределяются: магазину выручка, платформе комиссия.

**Весь цикл:** корзина → оформление → оплата → сборка → доставка → получение → финансовые расчёты.

### Ключевая логика

**Фиксация данных:**
- При оформлении заказа цены товаров фиксируются (не меняются, даже если продавец изменит цену в каталоге)
- Состав заказа копируется из корзины в `OrderItem[]` и больше не синхронизируется
- Это защищает и клиента (цена не вырастет), и магазин (цена не упадёт)

**Сборка и взвешивание:**
- Сотрудник собирает товар, взвешивает весовые позиции
- Если фактический вес меньше заказанного за пределами tolerance — клиент получает компенсацию баллами
- Если больше максимального tolerance — перевес за счёт магазина (клиент не доплачивает)

**Один заказ = один магазин:**
- Нельзя заказать из разных магазинов в одном заказе
- Для каждого магазина нужен отдельный заказ

**Финансовые расчёты:**
- После доставки создаётся запись в `SettlementPeriod` магазина
- Деньги аккумулируются, комиссия удерживается
- Выплата продавцу раз в 2-3 недели по закрытию периода

### Статусы заказа

`DRAFT` → `PENDING_PAYMENT` → `PAID` → `ACCEPTED` → `IN_ASSEMBLY` → `READY_FOR_DELIVERY` → `IN_DELIVERY` → `DELIVERED`

Альтернативные: `CANCELLED` (отменён клиентом/магазином), `FAILED` (не доставлен)

---

## 1. Обзор

Процесс заказа охватывает полный цикл: от добавления товаров в корзину до получения заказа клиентом и финансовых расчётов.

**Цель:** Обеспечить быструю доставку свежих продуктов с гарантией качества.

**Результат:** 
- Клиент получает заказ
- Магазин получает выручку (за вычетом комиссии)
- Платформа получает комиссию

---

## 2. Входные условия

- ✅ Клиент авторизован (`Customer` существует)
- ✅ Выбран магазин (`Shop` со статусом `OPENED`)
- ✅ Магазин верифицирован (`verifiedStatus = VERIFIED`)
- ✅ Есть товары в наличии (`ShopProduct` со статусом `ACTIVE`, `stockQuantity > 0`)
- ✅ У магазина открыта смена (`Shift` со статусом `OPEN`)

---

## 3. Основной сценарий (Happy Path)

### Шаг 1: Формирование корзины

**Актор:** Customer

1. Клиент просматривает каталог магазина (`GET /public/shop-products?shopId=...`)
2. Добавляет товары в корзину с указанием количества
3. Система создает/обновляет `Cart`:
   - Валидирует количество (должно быть кратно `product.stepRate`)
   - Проверяет доступность (`shopProduct.stockQuantity >= quantity`)
   - Пересчитывает общую сумму

**Сущности:** `Cart`, `CartProduct`  
**API:** 
- `POST /customer/cart/items` - добавить товар
- `PATCH /customer/cart/items/:productId` - изменить количество
- `GET /customer/cart` - получить корзину

**Валидации:**
- `quantity % stepRate === 0`
- `quantity <= stockQuantity`
- `cart.totalSum >= shop.minOrderSum`

---

### Шаг 2: Оформление заказа

**Актор:** Customer

1. Клиент переходит к оформлению (`POST /customer/orders/checkout`)
2. Выбирает:
   - Адрес доставки (из сохранённых или новый)
   - Способ получения (доставка/самовывоз)
   - Промокод (опционально)
3. Система создаёт черновик `Order`:
   - Статус: `DRAFT`
   - Фиксирует состав корзины в `OrderItem[]`
   - Фиксирует цены на момент заказа
   - Рассчитывает итоговую сумму
4. Проверки:
   - Зона доставки (если доставка)
   - Доступность товаров не изменилась
   - Минимальная сумма заказа

**Сущности:** `Order`, `OrderItem`, `Address`  
**API:** `POST /customer/orders/checkout`

**Бизнес-правила:**
- Цены фиксируются на момент создания заказа (не могут измениться после)
- Состав заказа фиксируется (нельзя добавить/удалить товары после оплаты)

---

### Шаг 3: Оплата

**Актор:** Customer + Payment Provider

1. Клиент инициирует оплату (`POST /customer/orders/:orderId/pay`)
2. Система создаёт `Payment`:
   - Статус: `INITIATED`
   - Генерирует ссылку на оплату (ЮKassa)
3. Клиент перенаправляется на платёжную страницу
4. Платёжный провайдер обрабатывает оплату
5. Webhook от провайдера (`POST /webhooks/payment`)
6. Система обновляет:
   - `Payment.status = SUCCESS`
   - `Order.status = PAID`
   - Резервирует товары (уменьшает `shopProduct.stockQuantity`)

**Сущности:** `Payment`  
**API:** 
- `POST /customer/orders/:orderId/pay`
- `POST /webhooks/payment` (callback)

**Альтернатива:** Если оплата не прошла → см. раздел 4.1

---

### Шаг 4: Сборка заказа

**Актор:** Employee (сборщик)

1. Заказ появляется в панели магазина (`GET /shop/orders?status=PAID`)
2. Сотрудник берёт заказ в работу:
   - Создаётся `Task` (type: `PICKING`)
   - `Order.status = IN_PROGRESS`
3. Сотрудник собирает товары:
   - Отмечает собранные позиции
   - Для весовых товаров фиксирует фактический вес
   - При недоступности товара отмечает замену/отмену позиции
4. Завершает сборку:
   - `Task.status = COMPLETED`
   - `Order.status = READY_FOR_DELIVERY` (или `READY_FOR_PICKUP`)
   - Списываются остатки со склада

**Сущности:** `Task`, `Shift`  
**API:** 
- `GET /shop/orders`
- `PATCH /shop/orders/:orderId/pick`
- `POST /shop/orders/:orderId/complete-picking`

**Бизнес-правила:**
- Сборка должна завершиться в пределах `shop.assemblyTimeLimit`
- При недовесе: разница возвращается клиенту баллами
- При перевесе: клиент не доплачивает (за счёт магазина)

---

### Шаг 5: Доставка/самовывоз

#### Вариант A: Доставка

**Актор:** Employee (курьер)

1. Создаётся `Task` (type: `DELIVERY`)
2. Курьер получает список заказов на доставку
3. Доставляет заказ клиенту
4. Отмечает статус:
   - `Order.status = DELIVERED` (успешно)
   - `Order.status = DELIVERY_FAILED` (не доставлено)

#### Вариант B: Самовывоз

**Актор:** Employee (кассир/выдача)

1. Клиент приходит в магазин
2. Сотрудник проверяет идентификатор (QR/код/телефон)
3. Выдаёт заказ
4. Отмечает: `Order.status = DELIVERED`

**Сущности:** `Task`  
**API:** 
- `POST /shop/orders/:orderId/deliver`
- `POST /shop/orders/:orderId/pickup`

---

### Шаг 6: Завершение и финансы

**Актор:** Система (автоматически)

1. После `Order.status = DELIVERED`:
   - Создаётся `SettlementTransaction` для `SettlementPeriod`
   - Фиксируется выручка магазина
   - Рассчитывается комиссия платформы (с учётом динамики)
2. Клиенту предлагается оценить заказ/магазин
3. В конце расчётного периода:
   - Деньги аккумулируются в `SellerAccount`
   - Создаётся `Payout` для выплаты

**Сущности:** `SettlementPeriod`, `SettlementTransaction`, `Payout`

---

## 4. Альтернативные сценарии

### 4.1. Оплата не прошла

- **Когда:** Payment Provider вернул ошибку
- **Действие:** 
  - `Payment.status = FAILED`
  - `Order.status = PAYMENT_FAILED`
  - Резерв товаров снимается
  - Клиенту показывается ошибка с возможностью повторить оплату

---

### 4.2. Товар недоступен при сборке

- **Когда:** `shopProduct.stockQuantity = 0` на момент сборки
- **Действие:**
  - Сотрудник отмечает позицию как недоступную
  - Система пересчитывает сумму заказа
  - Инициируется частичный возврат `Refund`
  - Клиент уведомляется

---

### 4.3. Клиент отменяет заказ

- **Когда:** До начала сборки (`status = PAID`)
- **Действие:**
  - `Order.status = CANCELED`
  - Инициируется полный возврат `Refund`
  - Резерв товаров снимается

**Ограничение:** После начала сборки отмена только через поддержку

---

### 4.4. Доставка не удалась

- **Когда:** Клиент не отвечает, неверный адрес
- **Действие:**
  - `Order.status = DELIVERY_FAILED`
  - Создаётся `SupportCase`
  - Попытка повторной доставки или возврат

---

## 5. Выходные результаты

**Успешный сценарий:**
- ✅ `Order` со статусом `DELIVERED`
- ✅ Клиент получил товары
- ✅ `SettlementTransaction` создана
- ✅ Остатки обновлены
- ✅ Уведомления отправлены
- ✅ Возможность оставить отзыв

**Неуспешный сценарий:**
- ❌ `Order` со статусом `CANCELED` / `PAYMENT_FAILED` / `DELIVERY_FAILED`
- ❌ `Refund` инициирован (если была оплата)
- ❌ `SupportCase` создан (если проблема)

---

## 6. Бизнес-правила и инварианты

1. **Один заказ = один магазин** (нет мульти-магазинной корзины в MVP)
2. **Цены фиксируются** на момент создания заказа (не могут измениться после)
3. **Оплаченный заказ не удаляется** (только отмена/возврат через статусы)
4. **Сборка выполняется Employee** с активной сменой, привязанным к Shop
5. **При недовесе:** клиент получает баллы
6. **При перевесе:** клиент не доплачивает (убыток магазина)
7. **Возвраты после оплаты:** только через `Refund` и `SettlementTransaction`
8. **SLA контроль:**
   - Принятие заказа: `shop.acceptanceTimeLimit`
   - Сборка заказа: `shop.assemblyTimeLimit`

---

## 7. Технические детали

### Сущности:

**Order:**
```typescript
{
  _id, orderId,
  customer: Customer,
  shop: Shop,
  items: OrderItem[],
  status: OrderStatus,
  totalAmount: number,
  deliveryInfo: DeliveryInfo,
  payment: Payment,
  createdAt, updatedAt
}
```

**Статусы Order:**
- `DRAFT` → `PAID` → `IN_PROGRESS` → `READY_FOR_DELIVERY` → `DELIVERED`
- Альтернативы: `PAYMENT_FAILED`, `CANCELED`, `DELIVERY_FAILED`

### API endpoints:

| Роль | Endpoint | Описание |
|------|----------|----------|
| Customer | `POST /customer/cart/items` | Добавить в корзину |
| Customer | `POST /customer/orders/checkout` | Создать заказ |
| Customer | `POST /customer/orders/:id/pay` | Оплатить |
| Customer | `GET /customer/orders/:id` | Статус заказа |
| Shop | `GET /shop/orders` | Очередь заказов |
| Shop | `PATCH /shop/orders/:id/pick` | Взять в сборку |
| Shop | `POST /shop/orders/:id/deliver` | Доставлено |
| Platform | `POST /webhooks/payment` | Webhook оплаты |

### События:

- `OrderCreated`
- `PaymentCompleted`
- `OrderPickingStarted`
- `OrderReadyForDelivery`
- `OrderDelivered`
- `OrderCanceled`

---

## 8. Связанные процессы

- **Оплата (payment-flow.md):** детали работы с платёжным провайдером
- **Финансы (finance-flow.md):** расчётные периоды и выплаты
- **Складской учёт (inventory-flow.md):** списание остатков при сборке
- **Смены (shift-flow.md):** контроль рабочего времени сотрудников
- **Поддержка (support-flow.md):** обработка проблем и споров

---

> **Статус:** ✅ Реализован  
> **Последнее обновление:** Ноябрь 2024  
> **Реализация:** [src/processes/order/](../../src/processes/order/) | [Документация оркестратора](../modules/orchestrators/order-process.md)  
> **TODO:** Интеграция с платёжным провайдером, бонусные баллы, частичные возвраты