# Процесс: Поддержка пользователей

**Участники:** Customer, Seller, Employee, PlatformStaff  
**Зависимости:** Issue Module

---

## Краткое содержание

### Основная идея

Любой пользователь (клиент, продавец, сотрудник) может создать **обращение** в поддержку через свою панель. Обращение попадает в общую очередь **PlatformStaff** (админов), которые категоризируют, назначают приоритет, отвечают. Вся переписка ведётся внутри обращения в формате чата.

**Схема:** Создание обращения → категоризация админом → обработка → ответ → закрытие.

### Ключевая логика

**Создание обращения:**
- Пользователь описывает проблему (10-5000 символов)
- Может выбрать категорию (техническая, оплата, доставка, товар)
- Обращение создаётся со статусом `new`

**Категоризация админом:**
- PlatformStaff назначает категорию и уровень (low, medium, high, critical)
- Статус меняется на `in_progress`
- High/Critical обращения приоритизируются

**Переписка:**
- Формат чата: пользователь → админ → пользователь
- Каждое сообщение с timestamp и автором
- Уведомления в Telegram при новых сообщениях

**Закрытие:**
- Админ закрывает обращение после решения проблемы
- Статус: `resolved` (решено) или `closed` (закрыто без решения)
- Клиент может переоткрыть в течение 7 дней

### Связь со спорами

Обращения в поддержку отличаются от споров. Споры — это претензии к качеству товара с финансовыми последствиями. Обращения — это вопросы, технические проблемы, пожелания. Обращение может перерасти в спор, если обнаружится проблема с заказом.

---

## Обзор

Система обращений в поддержку для всех типов пользователей платформы.

**Кто может обращаться:**
- **Customer** - проблемы с заказом, доставкой, оплатой, товаром
- **Seller** - технические проблемы, вопросы по работе платформы
- **Employee** - проблемы в работе магазина

**Кто обрабатывает:** PlatformStaff (админы)

---

## 1. Создание обращения

**Актор:** Customer / Seller / Employee

### Основной сценарий

1. Пользователь в своей панели → "Поддержка" → "Создать обращение"
2. Заполнение формы:
   - Текст проблемы (10-5000 символов)
   - Категория (опционально): техническая, оплата, доставка, товар, аккаунт, возврат, запрос функционала, прочее
3. Система создаёт `Issue`:
   ```typescript
   {
     fromUserType: "Customer",  // или Seller/Employee
     from: userId,              // Динамическая ссылка (refPath)
     fromTelegramId: 123456789,
     issueText: "Заказ #12345 доставлен с опозданием...",
     status: "new",
     category: null,            // Категорию установит админ
     level: null                // Приоритет установит админ
   }
   ```
4. Создаётся уведомление для PlatformStaff

**API:**
- `POST /customer/issues`
- `POST /seller/issues`
- `POST /employee/issues`

### Альтернативные сценарии

- **Текст слишком короткий (<10 символов):** ошибка валидации
- **Текст слишком длинный (>5000 символов):** ошибка валидации

---

## 2. Обработка обращения

**Актор:** PlatformStaff

### Сценарий

1. Админ в `/platform/issues` → просмотр новых обращений
2. Открывает обращение → видит:
   - Текст проблемы
   - Тип пользователя (Customer/Seller/Employee)
   - Данные создателя (телефон, email, Telegram)
   - Дата создания
3. Устанавливает категорию и приоритет:
   ```typescript
   {
     category: "delivery",  // Проблема с доставкой
     level: "high",         // Высокий приоритет
     status: "inProgress"   // Взято в работу
   }
   ```
4. Обрабатывает обращение (связывается с пользователем через Telegram/телефон)
5. После решения → закрывает с резолюцией:
   ```typescript
   {
     status: "closed",
     resolution: "Клиенту возвращены средства. Магазин получил предупреждение.",
     resolvedAt: new Date()
   }
   ```

**API:** `PATCH /platform/issues/:id`

### Фильтрация обращений

Админ может фильтровать по:
- **Статусу:** NEW, IN_PROGRESS, CLOSED
- **Приоритету:** LOW, MEDIUM, HIGH
- **Категории:** technical, payment, delivery, product, account, refund, feature, other
- **Типу пользователя:** Customer, Seller, Employee
- **Дате:** fromDate, toDate

---

## 3. Просмотр статуса обращения

**Актор:** Customer / Seller / Employee

Пользователь может просматривать свои обращения:

1. В панели → "Поддержка" → "Мои обращения"
2. Список обращений с фильтром по статусу
3. Детали обращения:
   - Текст
   - Статус (новое/в работе/закрыто)
   - Дата создания
   - Резолюция (если закрыто)

**API:**
- `GET /customer/issues` (только свои)
- `GET /seller/issues` (только свои)
- `GET /employee/issues` (только свои)

---

## Статусы Issue

| Статус | Описание | Кто устанавливает |
|--------|----------|-------------------|
| `NEW` | Новое обращение | Автоматически при создании |
| `IN_PROGRESS` | В работе | PlatformStaff |
| `CLOSED` | Закрыто | PlatformStaff (требуется резолюция) |

**Жизненный цикл:**
```
NEW → IN_PROGRESS → CLOSED
```

---

## Приоритеты

| Уровень | Описание | Когда |
|---------|----------|-------|
| `LOW` | Низкий | Общие вопросы, запросы функционала |
| `MEDIUM` | Средний | Проблемы с аккаунтом, технические |
| `HIGH` | Высокий | Проблемы с деньгами, доставкой, товаром |

---

## Категории проблем

| Категория | Описание | Примеры |
|-----------|----------|---------|
| `TECHNICAL` | Технические проблемы | Баги, недоступность сервиса |
| `PAYMENT` | Проблемы с оплатой | Деньги списались, но заказ не создан |
| `DELIVERY` | Проблемы с доставкой | Опоздание, не нашли адрес |
| `PRODUCT` | Проблемы с товаром | Качество, недовес, пересорт |
| `ACCOUNT` | Проблемы с аккаунтом | Не могу войти, забыл пароль |
| `REFUND` | Возврат средств | Хочу вернуть деньги за заказ |
| `FEATURE_REQUEST` | Запрос функционала | Добавьте возможность... |
| `OTHER` | Прочее | Всё остальное |

---

## Динамическая ссылка (refPath)

Issue использует динамическую ссылку на создателя:

```typescript
{
  fromUserType: "Customer" | "Seller" | "Employee",
  from: ObjectId  // Ссылается на соответствующую модель
}
```

**Как работает:**
- Если `fromUserType = Customer` → `from` ссылается на `Customer`
- Если `fromUserType = Seller` → `from` ссылается на `Seller`
- Если `fromUserType = Employee` → `from` ссылается на `Employee`

Это позволяет:
- Хранить обращения от всех типов пользователей в одной коллекции
- Делать populate для получения данных создателя
- Фильтровать по типу пользователя

---

## Техническая сводка

### Сущность Issue

```typescript
{
  fromUserType: IssueUserType,   // Customer/Seller/Employee
  from: ObjectId,                // refPath на создателя
  fromTelegramId: number,
  issueText: string,             // 10-5000 символов
  status: IssueStatus,           // new/inProgress/closed
  level?: IssueLevel,            // low/medium/high
  category?: IssueCategory,
  resolution?: string,           // Текст решения
  resolvedAt?: Date,             // Когда закрыто
  createdAt: Date,
  updatedAt: Date
}
```

### API

**Создание:**
- `POST /customer/issues` - Customer
- `POST /seller/issues` - Seller
- `POST /employee/issues` - Employee

**Просмотр:**
- `GET /customer/issues` - свои обращения
- `GET /seller/issues` - свои обращения
- `GET /employee/issues` - свои обращения
- `GET /{role}/issues/:id` - детали обращения

**Управление (Platform):**
- `GET /platform/issues` - все обращения (с фильтрами)
- `GET /platform/issues/:id` - детали
- `PATCH /platform/issues/:id` - обновить статус/категорию/приоритет
- `PATCH /platform/issues/:id/close` - закрыть с резолюцией

### Бизнес-правила

1. **Любой пользователь** может создать обращение
2. **Только PlatformStaff** может устанавливать категорию, приоритет, статус
3. **Закрытие требует резолюцию** - текстовое описание решения проблемы
4. **resolvedAt** устанавливается автоматически при `status = CLOSED`
5. Пользователь видит **только свои обращения**
6. Админ видит **все обращения** с фильтрацией

---

## Примеры

### Customer создаёт обращение

```typescript
// Customer: проблема с доставкой
const issue = await issuePort.createIssue({
  fromUserType: IssueUserType.CUSTOMER,
  from: customerId,
  fromTelegramId: 123456789,
  issueText: "Заказ #12345 доставлен с опозданием на 2 часа. Товары повреждены."
});

// Статус: NEW
// Админ получит уведомление
```

### Seller создаёт обращение

```typescript
// Seller: техническая проблема
const issue = await issuePort.createIssue({
  fromUserType: IssueUserType.SELLER,
  from: sellerId,
  fromTelegramId: 987654321,
  issueText: "Не могу загрузить изображение товара. Ошибка 500."
});
```

### Админ обрабатывает

```typescript
// Установка категории и приоритета
await issuePort.updateIssue(issueId, {
  category: IssueCategory.DELIVERY,
  level: IssueLevel.HIGH,
  status: IssueStatus.IN_PROGRESS
});

// После решения - закрытие
await issuePort.updateIssue(issueId, {
  status: IssueStatus.CLOSED,
  resolution: "Клиенту возвращены средства за поврежденные товары. Магазин получил предупреждение о качестве упаковки."
});

// resolvedAt устанавливается автоматически
```

---

## Возможные улучшения (backlog)

- [ ] Система сообщений (переписка в обращении)
- [ ] Прикрепление файлов (скриншоты, фото проблем)
- [ ] Автоматическая категоризация через ML
- [ ] SLA (время ответа/решения в зависимости от приоритета)
- [ ] Связь с Order (автозаполнение при проблеме с заказом)
- [ ] Эскалация обращений (автоповышение приоритета)
- [ ] Рейтинг качества поддержки
- [ ] Шаблоны ответов для админов
- [ ] Уведомления в Telegram о смене статуса

---

> **Статус:** ✅ Готов  
> **Обновлено:** 2024-11-23