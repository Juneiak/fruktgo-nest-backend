# Сквозные процессы – Панель управления магазином (draft v0.1)

Документ описывает сквозные процессы и модель доступа для **панели управления магазином** ("дашборд магазина"), через которую:

* магазин принимает и обрабатывает заказы,
* управляет операциями (сборка, выдача, доставка),
* ведёт базовые складские операции (приёмка, списания, инвентаризация).

Важно:

* Зайти в панель и видеть общие параметры может владелец/менеджер магазина (селлер).
* **Непосредственно работать с заказами и складом могут только сотрудникам магазина (Employee), привязанные к магазину и одобренные селлером.**

---

## 1. Роли и режимы доступа в панели магазина

В контексте панели магазина есть три основных типа акторов:

1. **Селлер / владелец магазина** (через свою панель селлера):

   * может открыть панель конкретного магазина в режиме владельца/менеджера,
   * видит агрегированные показатели и операционный статус,
   * управляет сотрудниками и настройками магазина,
   * по бизнес-правилам **не должен руками выполнять операционные действия** (сборка/списания) — это зона сотрудников.

2. **Сотрудники магазина (Employee)**:

   * имеют доступ в панель только если:

     * есть запись `Employee`,
     * сотрудник привязан к магазину,
     * сотрудник активен и одобрен селлером,
   * в панели выполняют операционную работу: приём заказов, сборка, выдача, доставка, приёмка и списания.

3. **(Опционально) PlatformStaff**:

   * может иметь read-only или диагностический доступ в панель магазина для поддержки/отладки,
   * не является основным пользователем панели.

Режимы панели:

* **Viewer (селлер)** — видит, не трогает операции.
* **Operator (employee)** — может менять статусы заказов и выполнять складские операции в рамках своих ролей.

---

## 2. Доступ и авторизация в панель магазина

### 2.1. Вход селлера (режим владельца/менеджера)

1. Селлер авторизуется в своей селлер-панели (см. `seller-flows.md`).
2. В списке магазинов выбирает конкретный `Shop`.
3. Нажимает "Открыть панель магазина" / "Дашборд магазина".
4. Система:

   * проверяет, что селлер является владельцем/уполномоченным для этого магазина,
   * открывает панель магазина в режиме владельца/менеджера с соответствующими правами (viewer + управление сотрудниками/настройками).

### 2.2. Вход сотрудника (операторский доступ)

1. Сотрудник получает приглашение от селлера (через панель селлера; см. `seller-flows.md`):

   * запись `Employee` создана и привязана к магазину(ам),
   * сотрудник одобрен.
2. Авторизация сотрудника (варианты):

   * через отдельный логин (телефон + код),
   * через Telegram-бот (выбор магазина и вход в web-панель/взаимодействие прямо в боте).
3. При входе в панель магазина система проверяет:

   * что существует `Employee` с таким идентификатором,
   * что `Employee` привязан к данному `Shop`,
   * что статус `Employee` активен.
4. Если проверки пройдены, сотрудник получает доступ в панель в роли оператора (в рамках своих под-ролей: кассир, упаковщик, курьер, кладовщик и т.д.).

**Инвариант:**

* Любое действие, меняющее состояние заказов/склада в панели магазина, должно быть выполнено от имени активного `Employee`, привязанного к этому магазину.

---

## 3. Панель магазина: обзор и мониторинг

### 3.1. Главный экран панели

При входе в панель (для селлера и сотрудников с нужной ролью) отображается:

* статус магазина (открыт/закрыт для заказов);
* очередь заказов по статусам (новые, в сборке, готовые к выдаче, в доставке, проблемные);
* ключевые показатели за сегодня/текущую смену:

  * количество заказов,
  * оборот (можно ограничить для сотрудников),
  * среднее время сборки/доставки;
* индикаторы проблем:

  * просроченные заказы,
  * много отмен/возвратов.

Селлер видит агрегированную картину, сотрудники — операционный фокус (задачи).

### 3.2. Управление статусом магазина

1. Менеджер магазина (селлер или назначенный сотрудник с нужной ролью) может:

   * перевести магазин в статус "принимает заказы" / "приостановлен";
   * указать причину приостановки (техработы, нет персонала, проблем с поставками и т.д.).
2. Система:

   * не даёт создавать новые заказы для клиентов, если магазин приостановлен,
   * уже созданные заказы продолжают обрабатываться по текущим правилам.

---

## 4. Работа с заказами в панели магазина

Панель магазина — основной интерфейс для сотрудников по обработке заказов (см. также `employee-flows.md`).

### 4.1. Очередь заказов

1. На вкладке "Заказы" отображаются заказы, привязанные к магазину, с фильтрами:

   * по статусу (новые, в сборке, готовые, в доставке, завершённые, отменённые),
   * по типу получения (доставка / самовывоз),
   * по времени (текущие, будущие, просроченные).
2. Сотрудники видят только те действия, которые им доступны по ролям:

   * сборщики — заказы в статусах "новый" / "оплачен, ждёт сборки",
   * курьеры — заказы "готовы к доставке" и т.д.

### 4.2. Принятие заказа в работу (сборка)

1. Новый оплаченный заказ попадает в очередь с внутренним статусом (например, `ready_for_picking`).
2. Сотрудник-сборщик:

   * выбирает заказ из списка,
   * нажимает "Взять в работу".
3. Система:

   * создаёт/обновляет `Task` типа `picking` и привязывает к сотруднику,
   * меняет статус заказа на "в сборке".

### 4.3. Сборка и завершение сборки

1. Через панель сотрудник видит состав заказа:

   * товары, количество, вес,
   * комментарии клиента.
2. По мере сборки:

   * отмечает собранные позиции,
   * может отмечать "нет в наличии" / предлагать замены (по бизнес-логике).
3. После завершения:

   * нажимает "Сборка завершена";
   * заказ переходит в статус "готов к упаковке" / "готов к выдаче/доставке".
4. Складские остатки обновляются согласно бизнес-правилам (резервирование / списание).

### 4.4. Выдача при самовывозе

1. При приходе клиента на самовывоз сотрудник открывает заказ в панели.
2. Проверяет данные (ФИО/код/QR).
3. Нажимает "Выдан клиенту".
4. Заказ получает статус "доставлен / завершён".

### 4.5. Передача на доставку

1. Для заказов с доставкой панель позволяет:

   * сформировать список заказов для курьера,
   * либо назначить курьера на конкретный заказ.
2. Все действия проходят через `Task` типа `delivery` (см. `employee-flows.md`):

   * создаётся задача доставки,
   * статус заказа меняется на "в доставке".

---

## 5. Складские операции через панель магазина

### 5.1. Приёмка товара

1. Кладовщик или сотрудник с ролью приёмки открывает вкладку "Склад" → "Поступления".
2. Создаёт новый документ поступления:

   * указывает поставку (опционально),
   * добавляет позиции (товар, количество),
   * сохраняет.
3. Система:

   * создаёт `StockMovement` типа `intake`,
   * увеличивает остатки по соответствующим SKU.

### 5.2. Списания (порча, просрочка)

1. На вкладке "Склад" → "Списания" сотрудник выбирает или создаёт документ списания.
2. Указывает:

   * товар,
   * количество,
   * причину (порча, просрочка, пересортица и т.д.).
3. Система:

   * создаёт `StockMovement` типа `write_off`,
   * уменьшает остатки.

### 5.3. Инвентаризация

1. Менеджер создаёт инвентаризацию для магазина (по всему складу или части ассортимента).
2. В панели появляется список позиций с текущими учётными остатками.
3. Сотрудники вводят фактические остатки.
4. Система:

   * сравнивает учётные и фактические,
   * формирует корректирующие `StockMovement` (излишки/недостачи).

---

## 6. Управление сотрудниками через панель магазина

### 6.1. Приглашение и привязка сотрудников

1. Владелец/менеджер магазина открывает раздел "Сотрудники".
2. Добавляет сотрудника:

   * ФИО,
   * контакты (телефон/Telegram),
   * роли (кассир, сборщик, курьер, кладовщик, менеджер смены),
   * привязка к магазину (если работает в нескольких — список магазинов).
3. Система создаёт сущность `Employee` и связку с `Shop`.
4. Сотруднику отправляется приглашение (смс/telegram-ссылка/код).

### 6.2. Управление статусом сотрудников

1. Менеджер магазина может:

   * активировать/деактивировать сотрудника,
   * менять роли внутри магазина,
   * удалять привязку к магазину.
2. Неактивному сотруднику закрывается доступ в панель магазина (операторский доступ).

---

## 7. Аналитика и мониторинг на уровне магазина

(Минимально в MVP, глубже — позже.)

1. В панели отображаются базовые показатели за выбранный период:

   * количество заказов,
   * оборот,
   * средний чек,
   * доля отмен/возвратов.
2. Для внутренней работы магазина могут показываться:

   * эффективность сотрудников (по задачам, по времени сборки/доставки),
   * проблемные заказы.

Селлер видит полную картину по своему магазину; отдельным сотрудникам показатели могут показываться в урезанном виде.

---

## 8. Ограничения и инварианты панели магазина

1. Любые операции, изменяющие состояние заказов или склада, выполняются только от имени `Employee`, привязанного к магазину и активного.
2. Селлер через панель магазина может:

   * управлять сотрудниками,
   * управлять настройками магазина,
   * видеть показатели и статус,
   * **но не обязан** выполнять операционные действия (сборка, списания) — это зона сотрудников.
3. Панель магазина работает только в контексте одного `Shop` за раз: любые заказы, задачи и складские операции в рамках текущего магазина.
4. При блокировке магазина (через селлера или платформу) панель должна явно показывать статус и запрещать операции, которые противоречат статусу (например, приём новых заказов).

---

Этот документ — v0.1. В следующих итерациях можно:

* детализировать права по ролям внутри магазина (manager/cashier/packer/courier/storekeeper),
* описать state machine для заказов и складских задач в контексте панели,
* добавить сценарии работы на планшете (киоск-режим, автологин по магазину и т.д.).
