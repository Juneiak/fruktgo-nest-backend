# –ü—Ä–æ—Ü–µ—Å—Å: –õ–æ—è–ª—å–Ω–æ—Å—Ç—å –∏ –±–æ–Ω—É—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

**–£—á–∞—Å—Ç–Ω–∏–∫–∏:** Customer, Seller, PlatformStaff  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** Order Module, CustomerLoyalty Module, LoyaltyTransaction Module

---

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Å –±–æ–Ω—É—Å–Ω—ã–º–∏ –±–∞–ª–ª–∞–º–∏ –¥–ª—è —Å—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫ –∏ –≤–æ–≤–ª–µ—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤.

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
- **1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å** –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
- –ú–∞–∫—Å–∏–º—É–º **30% –æ—Ç —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞** –º–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏
- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –±–∞–ª–ª–æ–≤: **6-12 –º–µ—Å—è—Ü–µ–≤** –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
- –°–ø–∏—Å–∞–Ω–∏–µ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É **FIFO** (–ø–µ—Ä–≤—ã–º–∏ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å—Ç–∞—Ä—ã–µ –±–∞–ª–ª—ã)

**–£—Ä–æ–≤–Ω–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏:**
- BRONZE (–Ω–æ–≤–∏—á–∫–∏) ‚Üí SILVER (10+ –∑–∞–∫–∞–∑–æ–≤) ‚Üí GOLD (50+ –∑–∞–∫–∞–∑–æ–≤) ‚Üí PLATINUM (100+ –∑–∞–∫–∞–∑–æ–≤)

---

## 1. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –∑–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é –Ω–µ–¥–æ–≤–µ—Å–∞

**–ê–∫—Ç–æ—Ä:** –°–∏—Å—Ç–µ–º–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ)

### –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π

1. –°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–æ–±–∏—Ä–∞–µ—Ç –∑–∞–∫–∞–∑ ‚Üí –≤–∑–≤–µ—à–∏–≤–∞–µ—Ç —Ç–æ–≤–∞—Ä
2. –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤–µ—Å –º–µ–Ω—å—à–µ –∑–∞–∫–∞–∑–∞–Ω–Ω–æ–≥–æ (–Ω–µ–¥–æ–≤–µ—Å)
3. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é:
   ```
   shortage = orderedQuantity - actualQuantity  // –≤ –≥—Ä–∞–º–º–∞—Ö
   compensationAmount = (shortage / 1000) * pricePerKg
   bonusPoints = Math.ceil(compensationAmount)  // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö
   ```
4. –°–æ–∑–¥–∞—ë—Ç—Å—è `LoyaltyTransaction`:
   ```typescript
   {
     type: "WEIGHT_COMPENSATION",
     amount: 15,  // –±–∞–ª–ª–æ–≤
     expiresAt: Date.now() + 12 –º–µ—Å—è—Ü–µ–≤,
     metadata: {
       orderId,
       productName: "–Ø–±–ª–æ–∫–∏ –ì–∞–ª–∞",
       orderedQuantity: 1000,  // 1–∫–≥
       actualQuantity: 950,    // 950–≥
       shortage: 50            // –Ω–µ–¥–æ–≤–µ—Å 50–≥
     }
   }
   ```
5. –ë–∞–ª–ª—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ (—Å—Ç–∞—Ç—É—Å `DELIVERED`)

### –ü–æ—Ä–æ–≥–∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏

| –ù–µ–¥–æ–≤–µ—Å | –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è |
|---------|-------------|
| 0-5–≥ | 0 –±–∞–ª–ª–æ–≤ (–ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –≤–µ—Å–æ–≤) |
| 5-50–≥ | –ü–æ —Ñ–æ—Ä–º—É–ª–µ |
| 50-100–≥ | –ü–æ —Ñ–æ—Ä–º—É–ª–µ + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ 10 –±–∞–ª–ª–æ–≤ |
| >100–≥ | –ü–æ —Ñ–æ—Ä–º—É–ª–µ + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ 50 –±–∞–ª–ª–æ–≤ + –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–ø–æ—Ä |

**–ü—Ä–∏–º–µ—Ä:**
- –ó–∞–∫–∞–∑–∞–Ω–æ: 1–∫–≥ —è–±–ª–æ–∫ –ø–æ 250‚ÇΩ/–∫–≥
- –§–∞–∫—Ç–∏—á–µ—Å–∫–∏: 950–≥
- –ù–µ–¥–æ–≤–µ—Å: 50–≥
- –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è: (50/1000) √ó 250 = 12.5‚ÇΩ ‚Üí **13 –±–∞–ª–ª–æ–≤** + –±–æ–Ω—É—Å 10 = **23 –±–∞–ª–ª–∞**

---

## 2. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫—ç—à–±–µ–∫–∞ –∑–∞ –∑–∞–∫–∞–∑—ã

**–ê–∫—Ç–æ—Ä:** –°–∏—Å—Ç–µ–º–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏)

### –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π

1. –ó–∞–∫–∞–∑ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω ‚Üí `Order.status = DELIVERED`
2. –°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫—ç—à–±–µ–∫:
   ```typescript
   const tier = customer.loyalty.tier;  // BRONZE/SILVER/GOLD/PLATINUM
   const cashbackRate = getCashbackRate(tier);  // 1%/2%/3%/5%
   
   // –ö—ç—à–±–µ–∫ —Ç–æ–ª—å–∫–æ —Å —Ç–æ–≤–∞—Ä–æ–≤ (–±–µ–∑ –¥–æ—Å—Ç–∞–≤–∫–∏)
   const cashbackAmount = order.totalCartSum * cashbackRate;
   const bonusPoints = Math.floor(cashbackAmount);
   ```
3. –°–æ–∑–¥–∞—ë—Ç—Å—è `LoyaltyTransaction`:
   ```typescript
   {
     type: "ORDER_CASHBACK",
     amount: 40,  // –±–∞–ª–ª–æ–≤
     expiresAt: Date.now() + 6 –º–µ—Å—è—Ü–µ–≤,
     metadata: {
       orderId,
       orderAmount: 2000,
       tier: "SILVER",
       cashbackRate: 0.02
     }
   }
   ```
4. –ë–∞–ª–ª—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ `customerLoyalty.balance.available`

### –£—Ä–æ–≤–Ω–∏ –∏ –∫—ç—à–±–µ–∫

| –£—Ä–æ–≤–µ–Ω—å | –ö—ç—à–±–µ–∫ | –£—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è |
|---------|--------|-------------------|
| **BRONZE** | 1% | –ù–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| **SILVER** | 2% | 10+ –∑–∞–∫–∞–∑–æ–≤ **–∏–ª–∏** –ø–æ—Ç—Ä–∞—á–µ–Ω–æ 10–ö‚ÇΩ+ |
| **GOLD** | 3% | 50+ –∑–∞–∫–∞–∑–æ–≤ **–∏–ª–∏** –ø–æ—Ç—Ä–∞—á–µ–Ω–æ 50–ö‚ÇΩ+ |
| **PLATINUM** | 5% | 100+ –∑–∞–∫–∞–∑–æ–≤ **–∏–ª–∏** –ø–æ—Ç—Ä–∞—á–µ–Ω–æ 150–ö‚ÇΩ+ |

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞.

---

## 3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è

**–ê–∫—Ç–æ—Ä:** –°–∏—Å—Ç–µ–º–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) –∏–ª–∏ PlatformStaff (–≤—Ä—É—á–Ω—É—é)

### –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å

**–ö–æ–≥–¥–∞:** –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —É—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
```typescript
{
  type: "FIRST_ORDER_BONUS",
  amount: 100,
  expiresAt: Date.now() + 12 –º–µ—Å—è—Ü–µ–≤
}
```

### –°–µ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ (streak)

**–ö–æ–≥–¥–∞:** –ö–∞–∂–¥—ã–µ 5 –∑–∞–∫–∞–∑–æ–≤ –ø–æ–¥—Ä—è–¥ (–±–µ–∑ –æ—Ç–º–µ–Ω)
```typescript
{
  type: "STREAK_BONUS",
  amount: 50 + (streakCount * 25),  // 50, 75, 100, 125...
  metadata: { streakCount: 2 }  // –í—Ç–æ—Ä–∞—è —Å–µ—Ä–∏—è = 75 –±–∞–ª–ª–æ–≤
}
```

### –û—Ç–∑—ã–≤ —Å —Ñ–æ—Ç–æ

**–ö–æ–≥–¥–∞:** –ö–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–≤–∏–ª –æ—Ç–∑—ã–≤ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏
```typescript
{
  type: "REVIEW_BONUS",
  amount: 20,
  expiresAt: Date.now() + 6 –º–µ—Å—è—Ü–µ–≤,
  metadata: { orderId, reviewId }
}
```

### –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

**–ö–æ–≥–¥–∞:** –ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π –¥—Ä—É–≥ —Å–¥–µ–ª–∞–ª –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑
```typescript
// –ü—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–º—É
{
  type: "REFERRAL_BONUS",
  amount: 200,
  metadata: { referredCustomer: friendId }
}

// –ù–æ–≤–∏—á–∫—É
{
  type: "REFERRAL_WELCOME",
  amount: 100,
  metadata: { referredBy: friendId }
}
```

### –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è

**–ö–æ–≥–¥–∞:** –ó–∞ –Ω–µ–¥–µ–ª—é –¥–æ –¥–Ω—è —Ä–æ–∂–¥–µ–Ω–∏—è
```typescript
{
  type: "BIRTHDAY_BONUS",
  amount: 300,
  expiresAt: birthday + 30 –¥–Ω–µ–π,  // –î–µ–π—Å—Ç–≤—É–µ—Ç –º–µ—Å—è—Ü
  metadata: { birthday }
}
```

---

## 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ

**–ê–∫—Ç–æ—Ä:** Customer

### –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π

1. –ö–ª–∏–µ–Ω—Ç –≤ –∫–æ—Ä–∑–∏–Ω–µ ‚Üí –≤–∏–¥–∏—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±–∞–ª–ª—ã
2. –í–≤–æ–¥–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–∏–ª–∏ –ø–æ–ª–∑—É–Ω–æ–∫)
3. –°–∏—Å—Ç–µ–º–∞ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç:
   ```typescript
   const maxUsablePoints = Math.floor(cartTotal * 0.30);  // 30% –ª–∏–º–∏—Ç
   const actualPoints = Math.min(
     requestedPoints,
     customerLoyalty.balance.available,
     maxUsablePoints
   );
   ```
4. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –±–∞–ª–ª—ã —Ä–µ–∑–µ—Ä–≤–∏—Ä—É—é—Ç—Å—è:
   ```typescript
   {
     // CustomerLoyalty
     balance: {
       available: 300 - 200,  // –£–º–µ–Ω—å—à–∞–µ—Ç—Å—è
       pending: 0 + 200       // –†–µ–∑–µ—Ä–≤–∏—Ä—É—é—Ç—Å—è
     }
   }
   
   {
     // LoyaltyTransaction
     type: "ORDER_PAYMENT_PENDING",
     amount: -200,  // –°–ø–∏—Å–∞–Ω–∏–µ
     relatedOrder: orderId,
     status: "PENDING"
   }
   ```
5. –ü–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ —Ä–µ–∑–µ—Ä–≤ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è:
   ```typescript
   {
     balance: {
       pending: 200 - 200  // –û–±–Ω—É–ª—è–µ—Ç—Å—è
     },
     statistics: {
       spent: 0 + 200  // –ò—Ç–æ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ
     }
   }
   
   {
     // LoyaltyTransaction
     status: "COMPLETED"
   }
   ```

### –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞

```typescript
// –í–æ–∑–≤—Ä–∞—Ç –±–∞–ª–ª–æ–≤
{
  balance: {
    available: 100 + 200,  // –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è
    pending: 200 - 200     // –û–±–Ω—É–ª—è–µ—Ç—Å—è
  }
}

{
  type: "ORDER_PAYMENT_REFUNDED",
  amount: +200,  // –í–æ–∑–≤—Ä–∞—Ç
  relatedOrder: orderId
}
```

**API:**
- `POST /customer/cart/apply-points`
- `POST /customer/cart/remove-points`

---

## 5. –ò—Å—Ç–µ—á–µ–Ω–∏–µ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è

**–ê–∫—Ç–æ—Ä:** –°–∏—Å—Ç–µ–º–∞ (cron job –µ–∂–µ–¥–Ω–µ–≤–Ω–æ)

### –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π

1. Cron job –≤ 00:00 ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å –∏—Å—Ç—ë–∫—à–∏–º —Å—Ä–æ–∫–æ–º
2. –ù–∞—Ö–æ–¥–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≥–¥–µ `expiresAt < Date.now()`
3. –î–ª—è –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
   ```typescript
   {
     // –°–æ–∑–¥–∞—ë—Ç—Å—è —Å–ø–∏—Å–∞–Ω–∏–µ
     type: "EXPIRED",
     amount: -50,
     metadata: {
       originalTransaction: transactionId,
       expiresAt: Date
     }
   }
   
   {
     // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
     balance.available -= 50
     balance.expired += 50
   }
   ```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–∫–æ—Ä–æ–º –∏—Å—Ç–µ—á–µ–Ω–∏–∏

–ó–∞ 7 –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è (–µ—Å–ª–∏ –±–∞–ª–ª–æ–≤ ‚â•50):
```
üì¢ –£ –≤–∞—Å –∏—Å—Ç–µ–∫–∞–µ—Ç 120 –±–∞–ª–ª–æ–≤ —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π!
–£—Å–ø–µ–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ 01.12.2024
```

**API:** `GET /customer/loyalty/expiring` - –±–∞–ª–ª—ã —Å –∏—Å—Ç–µ–∫–∞—é—â–∏–º —Å—Ä–æ–∫–æ–º

---

## 6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏

**–ê–∫—Ç–æ—Ä:** –°–∏—Å—Ç–µ–º–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞)

### –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π

1. –ó–∞–∫–∞–∑ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è:
   ```typescript
   function updateTier(customer: Customer) {
     const { ordersCount, totalSpent } = customer.statistics;
     
     let newTier = "BRONZE";
     let tierBonus = 0;
     
     if (ordersCount >= 100 || totalSpent >= 150000) {
       newTier = "PLATINUM";
       tierBonus = 1000;
     } else if (ordersCount >= 50 || totalSpent >= 50000) {
       newTier = "GOLD";
       tierBonus = 300;
     } else if (ordersCount >= 10 || totalSpent >= 10000) {
       newTier = "SILVER";
       tierBonus = 100;
     }
     
     if (newTier !== customer.loyalty.tier) {
       customer.loyalty.tier = newTier;
       // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–∞ –∑–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ
       addBonus({ type: "TIER_UPGRADE", amount: tierBonus });
       // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
       notify(customer, `üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —É—Ä–æ–≤–Ω—è ${newTier}!`);
     }
   }
   ```

### –ü—Ä–∏–≤–∏–ª–µ–≥–∏–∏ —É—Ä–æ–≤–Ω–µ–π

| –£—Ä–æ–≤–µ–Ω—å | –ü—Ä–∏–≤–∏–ª–µ–≥–∏–∏ |
|---------|-----------|
| **SILVER** | 2% –∫—ç—à–±–µ–∫, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞, 1 –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞/–º–µ—Å—è—Ü |
| **GOLD** | 3% –∫—ç—à–±–µ–∫, VIP –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ |
| **PLATINUM** | 5% –∫—ç—à–±–µ–∫, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä, —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏, —Ä–∞–Ω–Ω–∏–π –¥–æ—Å—Ç—É–ø |

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–≤–æ–¥–∫–∞

### –°—É—â–Ω–æ—Å—Ç—å CustomerLoyalty

```typescript
{
  customer: ObjectId,
  balance: {
    available: number,     // –î–æ—Å—Ç—É–ø–Ω–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
    pending: number,       // –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥ –∑–∞–∫–∞–∑—ã
    expired: number        // –ò—Å—Ç–µ–∫–ª–æ (–¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
  },
  statistics: {
    totalEarned: number,   // –í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ
    totalSpent: number,    // –í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ
    currentStreak: number  // –ó–∞–∫–∞–∑–æ–≤ –ø–æ–¥—Ä—è–¥
  },
  tier: LoyaltyTier,       // BRONZE/SILVER/GOLD/PLATINUM
  transactions: ObjectId[] // –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
}
```

### –°—É—â–Ω–æ—Å—Ç—å LoyaltyTransaction

```typescript
{
  customer: ObjectId,
  type: TransactionType,   // ORDER_CASHBACK, WEIGHT_COMPENSATION, etc.
  amount: number,          // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ (–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ) –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ (—Å–ø–∏—Å–∞–Ω–∏–µ)
  status: "PENDING" | "COMPLETED" | "CANCELLED",
  expiresAt?: Date,        // –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
  relatedOrder?: ObjectId,
  metadata: Record<string, any>,
  createdAt: Date
}
```

### –¢–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–ù–∞—á–∏—Å–ª–µ–Ω–∏—è (+):**
- `ORDER_CASHBACK` - –∫—ç—à–±–µ–∫ –∑–∞ –∑–∞–∫–∞–∑
- `WEIGHT_COMPENSATION` - –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –Ω–µ–¥–æ–≤–µ—Å–∞
- `FIRST_ORDER_BONUS` - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å
- `STREAK_BONUS` - —Å–µ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤
- `REVIEW_BONUS` - –æ—Ç–∑—ã–≤ —Å —Ñ–æ—Ç–æ
- `REFERRAL_BONUS` - –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–≥–∞
- `BIRTHDAY_BONUS` - –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è
- `TIER_UPGRADE` - –ø–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è
- `MANUAL_ADJUSTMENT` - —Ä—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∞–¥–º–∏–Ω–æ–º

**–°–ø–∏—Å–∞–Ω–∏—è (-):**
- `ORDER_PAYMENT_PENDING` - —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
- `ORDER_PAYMENT_COMPLETED` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- `ORDER_PAYMENT_REFUNDED` - –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
- `EXPIRED` - –∏—Å—Ç–µ—á–µ–Ω–∏–µ —Å—Ä–æ–∫–∞

### API

**Customer:**
- `GET /customer/loyalty` - –±–∞–ª–∞–Ω—Å, —É—Ä–æ–≤–µ–Ω—å, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `GET /customer/loyalty/transactions` - –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- `GET /customer/loyalty/expiring` - –±–∞–ª–ª—ã —Å –∏—Å—Ç–µ–∫–∞—é—â–∏–º —Å—Ä–æ–∫–æ–º
- `POST /customer/cart/apply-points` - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –±–∞–ª–ª—ã
- `GET /customer/loyalty/tier-progress` - –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è

**Platform:**
- `POST /platform/loyalty/manual-adjustment` - —Ä—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞

### –ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞

1. **1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å** –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
2. **–ú–∞–∫—Å–∏–º—É–º 30%** –æ—Ç —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞ –º–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏
3. **–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:** 6-12 –º–µ—Å—è—Ü–µ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
4. **–°–ø–∏—Å–∞–Ω–∏–µ FIFO:** —Å—Ç–∞—Ä—ã–µ –±–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏
5. **–ù–µ–¥–æ–≤–µ—Å <5–≥** –Ω–µ –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç—Å—è (–ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –≤–µ—Å–æ–≤)
6. **–ö—ç—à–±–µ–∫ —Ç–æ–ª—å–∫–æ —Å —Ç–æ–≤–∞—Ä–æ–≤** (–±–µ–∑ –¥–æ—Å—Ç–∞–≤–∫–∏)
7. **–í–æ–∑–≤—Ä–∞—Ç –±–∞–ª–ª–æ–≤** –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞
8. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è** –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞

---

## –ü—Ä–∏–º–µ—Ä—ã

### –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```typescript
// –£ –∫–ª–∏–µ–Ω—Ç–∞ 300 –±–∞–ª–ª–æ–≤, —É—Ä–æ–≤–µ–Ω—å SILVER (2% –∫—ç—à–±–µ–∫)

// 1. –ó–∞–∫–∞–∑ –Ω–∞ 2000‚ÇΩ
const maxUsable = 2000 * 0.30;  // 600‚ÇΩ –º–∞–∫—Å–∏–º—É–º
const usePoints = 300;  // –ö–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å–µ
const totalToPay = 2000 - 300;  // –ü–ª–∞—Ç–∏—Ç 1700‚ÇΩ

// 2. –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ
loyalty.balance.available = 0;
loyalty.balance.pending = 300;

// 3. –ü–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏ - —Å–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞
loyalty.balance.pending = 0;
loyalty.statistics.totalSpent = 300;

// 4. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫—ç—à–±–µ–∫–∞
const cashback = 2000 * 0.02;  // 40 –±–∞–ª–ª–æ–≤
const weightBonus = 5;  // –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –Ω–µ–¥–æ–≤–µ—Å–∞
loyalty.balance.available = 45;

// –ò—Ç–æ–≥–æ: –∫–ª–∏–µ–Ω—Ç –ø–æ—Ç—Ä–∞—Ç–∏–ª 300, –∑–∞—Ä–∞–±–æ—Ç–∞–ª 45
```

---

## –°–≤—è–∑—å —Å –¥—Ä—É–≥–∏–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏

**Order Flow:**
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
- –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫—ç—à–±–µ–∫–∞ –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏
- –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –Ω–µ–¥–æ–≤–µ—Å–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ

**Finance Flow:**
- –ë–∞–ª–ª—ã —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ —Å–∫–∏–¥–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
- –ù–µ –≤–ª–∏—è—é—Ç –Ω–∞ –∫–æ–º–∏—Å—Å–∏—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (–º–∞–≥–∞–∑–∏–Ω –ø–ª–∞—Ç–∏—Ç —Å –ø–æ–ª–Ω–æ–π —Å—É–º–º—ã)

**Dispute Flow:**
- –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –∑–∞ —Ä–µ—à—ë–Ω–Ω—ã–µ —Å–ø–æ—Ä—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –±–∞–ª–ª–∞–º–∏

**Rating Flow:**
- –ë–æ–Ω—É—Å—ã –∑–∞ –æ—Ç–∑—ã–≤—ã —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏

---

> **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤  
> **–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 2024-11-24
