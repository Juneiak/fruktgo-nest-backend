# Сквозные процессы для селлеров (draft v0.1)

Документ описывает сквозные процессы (end-to-end флоу) со стороны **селлера** и его магазинов.

Цель:

* зафиксировать, как селлер подключается к платформе и дальше работает с магазинами,
* дать основу для проектирования доменов Shops/Sellers, Inventory, Orders, Finance, Employee,
* использовать как вход для backend-архитектуры, UI и автотестов.

---

## 1. Онбординг селлера и создание магазина

### 1.1. Регистрация селлера

1. Будущий селлер заходит на сайт/в приложение или получает ссылку от менеджера платформы.
2. Заполняет форму регистрации селлера:

   * ФИО контактного лица,
   * контакты (телефон, email, Telegram),
   * тип юр. лица (ИП/ООО/др.),
   * ИНН, ОГРН/ОГРНИП и др. реквизиты (минимально необходимые для старта),
   * базовая информация о бренде.
3. Система создаёт сущность `Seller` и привязывает к ней аккаунт пользователя.
4. Статус верификации селлера (`verifiedStatus`):

   * `IS_CHECKING` — на проверке документов (default),
   * после проверки — `VERIFIED` (одобрен) или `NOT_VERIFIED` (отклонен).

**Бекенд:**

* Модель `Seller` с реквизитами и статусом.
* Валидация полей (минимальная на уровне схем, детальная позже).

### 1.2. Создание магазина

1. Селлер (или менеджер платформы) создаёт один или несколько магазинов:

   * название магазина,
   * адрес,
   * геопозиция (для зоны доставки),
   * режим работы,
   * формат (только доставка / доставка+самовывоз).
2. Магазин привязывается к `Seller` и создаётся сущность `Shop`.
3. Магазин проходит модерацию платформы:

   * статус верификации `IS_CHECKING` → `VERIFIED` (одобрен) / `NOT_VERIFIED` (отклонен).
4. После верификации (`VERIFIED`) магазин становится доступен для привязки товаров, сотрудников, заказов.

**Бекенд:**

* Модель `Shop`, связь с `Seller`.
* Статусы магазина и история изменений.

---

## 2. Управление сотрудниками магазина (Employee)

### 2.1. Добавление сотрудников

1. Селлер в панели выбирает магазин и раздел "Сотрудники".
2. Добавляет сотрудника:

   * ФИО,
   * контакт (телефон/Telegram),
   * роль (кассир, упаковщик, курьер, менеджер, кладовщик),
   * привязка к одному или нескольким магазинам.
3. Система:

   * создаёт `Employee` с указанными данными,
   * генерирует приглашение (ссылка/QR/код) для авторизации сотрудника в приложении/боте.

### 2.2. Управление доступами

1. Селлер может изменять роли сотрудника:

   * повышать до менеджера магазина,
   * ограничивать доступ только сборкой, только доставкой и т.п.
2. Может блокировать/разблокировать сотрудника.
3. Бекенд применяет RBAC:

   * `Employee` имеет набор разрешений в рамках конкретного `Shop`.

**Бекенд:**

* Модель `Employee` со связями `Employee-Shop`, `Employee-Seller`.
* Сервисы выдачи токенов/ключей для Telegram-бота/приложения.

---

## 3. Управление каталогом товаров

### 3.1. Создание товаров (мастер-каталог)

1. Селлер создаёт товары в своём мастер-каталоге (`Product`):

   * название товара (например, "Яблоко Гала"),
   * категория (фрукты, овощи, орехи и т.д.),
   * базовая цена,
   * единица измерения (кг, шт),
   * шаг продажи (0.5кг, 1шт и т.д.),
   * описание, фото, происхождение.
2. Товар создаётся на уровне селлера (`product.owner = sellerId`).
3. На этом этапе товар ещё **не доступен для продажи** — это просто запись в каталоге.

### 3.2. Распределение товаров по магазинам

1. Селлер выбирает товар из своего каталога и прикрепляет его к конкретному магазину.
2. Создаётся `ShopProduct` (связь Product ↔ Shop):

   * `shopProduct.product` = productId,
   * `shopProduct.pinnedTo` = shopId,
   * `shopProduct.stockQuantity` = начальные остатки,
   * `shopProduct.status` = ACTIVE (по умолчанию).
3. Селлер может прикрепить один и тот же `Product` к нескольким магазинам.
4. Для каждого `ShopProduct` можно:

   * управлять остатками (`stockQuantity`),
   * менять статус (ACTIVE/PAUSED/OUT_OF_STOCK/ARCHIVED),
   * добавлять дополнительные изображения (специфичные для магазина).

### 3.3. Управление витриной

1. Клиенты видят только товары через `ShopProduct` (не напрямую `Product`).
2. Селлер может управлять отображением:

   * сортировкой товаров,
   * статусами (ACTIVE = показывается, PAUSED = скрыт).
3. В будущем: подборки, акции, персональные рекомендации.

**Бекенд:**

* Модель `Product` (мастер-каталог селлера).
* Модель `ShopProduct` (связь Product ↔ Shop с остатками и статусом).
* Двухуровневая модель: Product → ShopProduct → Order.

---

## 4. Складской учёт (Inventory)

### 4.1. Начальная загрузка остатков

1. При запуске магазина селлер вводит стартовые остатки:

   * по каждому SKU,
   * с учётом единиц измерения (кг, шт, упаковки).
2. Система создаёт `InventoryRecord` и начальные `StockMovement` (тип `initial`).

### 4.2. Поступления товара

1. При очередной поставке менеджер/кладовщик:

   * создаёт документ поступления (можно как упрощённый `StockMovement` пакетно),
   * указывает поставщика (опционально), товары, количество.
2. Система:

   * увеличивает остатки по соответствующим позициям,
   * фиксирует движение.

### 4.3. Списания и порча

1. При просрочке или порче товара сотрудник создаёт списание:

   * указывает товар, количество, причину (порча, истёк срок и т.п.).
2. Система уменьшает остатки и создаёт `StockMovement` (тип `write_off`).
3. Эти данные позже попадают в отчёты по потерям.

### 4.4. Инвентаризация

1. Периодически магазин проводит инвентаризацию:

   * вводятся фактические остатки,
   * система сравнивает с учётными.
2. Разница фиксируется отдельными движениями (досрочные/излишки).

**Бекенд:**

* Модели `InventoryRecord`, `StockMovement`.
* Инвариант: сумма движений по SKU формирует текущий остаток.

---

## 5. Обработка заказов клиентов (заказы, фулфилмент)

### 5.1. Получение заказа

1. Клиент создаёт и оплачивает заказ.
2. Бекенд назначает заказ конкретному магазину (`Shop`), исходя из логики подбора (по умолчанию — выбранный клиентом магазин).
3. В панели магазина и в интерфейсах сотрудников появляется новый `Order` со статусом `paid` / `new`.

### 5.2. Назначение задач сотрудникам

1. Менеджер/система автоматически создаёт `Task` типа `picking` (сборка заказа) и привязывает к сотруднику (или в общий пул).
2. У сотрудника (в приложении/боте) появляется задача "Собрать заказ #N".

### 5.3. Сборка и упаковка

1. Сотрудник принимает задачу, статус задачи становится `in_progress`.
2. По мере сборки:

   * сканирует/отмечает позиции (при наличии),
   * может отметить замену (если допускается)

     * либо флаг "нет в наличии" для определённых позиций.
3. После завершения сборки:

   * задача помечается как `completed`,
   * заказ получает статус `picked` / `ready_for_delivery` / `ready_for_pickup`,
   * система фиксирует резервирование/списание остатков.

### 5.4. Доставка / самовывоз

**Самовывоз:**

1. Магазин готовит заказ к выдаче.
2. При приходе клиента сотрудник отмечает заказ как "выдан" → статус `delivered`.

**Доставка:**

1. Создаётся задача `Task` типа `delivery` для курьера.
2. Курьер:

   * принимает задачу,
   * видит адрес, контакт клиента,
   * по пути может отмечать промежуточные статусы (выехал, прибыл).
3. После вручения заказа клиенту курьер отмечает выполнение → заказ `delivered`.

### 5.5. Проблемные ситуации

1. Клиент не вышел на связь / не принял заказ:

   * курьер отмечает проблему,
   * менеджер решает — возврат на магазин, повторная доставка, частичное списание.
2. Ошибка в заказе выявлена на этапе сборки:

   * возможно согласование замен через поддержку/клиента,
   * либо частичное списание и корректировка заказа.

**Бекенд:**

* Модели `Order`, `OrderItem`, `Task`.
* Чёткие статусы и переходы заказов и задач.

---

## 6. Финансы селлера

### 6.1. Доходы от заказов

1. Каждый доставленный/выданный заказ попадает в финансовую подсистему:

   * фиксируется валовый доход по заказу,
   * рассчитывается комиссия платформы,
   * чистый доход селлера.
2. Эти данные агрегируются в рамках `SettlementPeriod`.

### 6.2. Расчётные периоды и отчётность

1. Для каждого селлера ведутся расчётные периоды (например, раз в 2 недели):

   * начало и конец периода,
   * сумма валового оборота,
   * сумма комиссий платформы,
   * удержания (возвраты, штрафы),
   * итог к выплате.
2. Селлер в панели видит:

   * список периодов,
   * детализацию по заказам,
   * статус выплаты (ожидается/выплачено/заморожено).

### 6.3. Выплаты и акты

1. По завершении периода платформа инициирует `Payout` селлеру.
2. Селлер может выгрузить:

   * акт сверки/отчёт по продажам,
   * (опционально) счёт/закрывающие документы.

**Бекенд:**

* Модели `SettlementPeriod`, `SettlementTransaction`, `Payout`.
* Логика связывания заказов, возвратов и штрафов с транзакциями периода.

---

## 7. Аналитика и отчёты для селлера

### 7.1. Операционная аналитика

1. Селлер может видеть в панели:

   * оборот по магазинам за выбранный период,
   * количество заказов,
   * средний чек,
   * долю отмен/возвратов.

### 7.2. Товарная аналитика

1. Отчёты по товарам:

   * топ продаваемых позиций,
   * товары с высокой долей списаний,
   * маржинальность по категориям (позже).

### 7.3. Производительность сотрудников

1. Базовые метрики:

   * количество собранных заказов по сотруднику,
   * среднее время сборки/доставки,
   * доля проблемных заказов.

**Бекенд:**

* Либо агрегирующие таблицы/коллекции, либо отдельный analytics-слой.

---

## 8. Взаимодействие селлера с платформой

### 8.1. Поддержка селлеров

1. Селлер может обращаться в поддержку платформы:

   * вопросы по расчётам,
   * технические проблемы,
   * модерация товаров.
2. Система создаёт `SupportCase` с типом "селлер" и привязкой к `Seller`/`Shop`.

### 8.2. Оповещения от платформы

1. Платформа уведомляет селлера о:

   * изменении тарифов и комиссий,
   * блокировках товаров/магазина,
   * важных инцидентах.
2. Каналы: email, Telegram, внутренняя inbox-панель.

---

## 9. Настройки магазина и операционная конфигурация

1. Селлер управляет настройками магазина:

   * режим работы,
   * время cut-off для доставки,
   * минимальная сумма заказа,
   * доступные способы оплаты и доставки (если настраиваемые).
2. Эти настройки учитываются при показе витрины и при расчёте условий оформления заказа клиенту.

**Бекенд:**

* Конфигурация на уровне `ShopSettings`.

---

## 10. Масштабирование: сеть магазинов

1. Один селлер может иметь несколько магазинов в разных районах/городах.
2. В панели селлера должна быть сводная информация по сети + возможность проваливаться в конкретный магазин.
3. Заказы и остатки учитываются по каждому магазину отдельно.

**Инвариант:**

* Любой заказ всегда привязан к конкретному `Shop`.

---

Этот документ — v0.1. В следующих итерациях можно детализировать:

* статусы заказов и задач (state machine),
* статусную модель магазинов и селлеров,
* сценарии оффлайн-касс и протоколов,
* расширенную систему мотивации и штрафов для сотрудников.
