# Business Model (draft v0.1)

Документ описывает **предполагаемую бизнес-модель платформы** на уровне, достаточном для:
- проектирования backend-доменов;
- понимания связей сущностей и инвариантов;
- использования ИИ как контекста («как всё устроено с бизнес-стороны»).

Подробные сквозные процессы см. в отдельных документах:
- @/docs/business/client-flows.md
- @/docs/business/seller-flows.md
- @/docs/business/shop-flows.md
- @/docs/business/employee-flows.md
- @/docs/business/platform-staff-flows.md

Документ — живой, по мере уточнения бизнес-модели дополняется и правится.

---

## 1. Общая концепция продукта

Платформа — это **маркетплейс относительно быстрой доставки**:

- фрукты, овощи, ягоды;
- зелень;
- орехи, сухофрукты;
- сопутствующая бакалея (крупы, ореховые пасты и т.п.).

Форматы клиентских интерфейсов:
- мобильное приложение;
- веб-сайт;
- (дополнительно) Telegram-бот.

Основная идея для клиента:
- быстро, удобно, «как Xiaomi в мире еды» — без излишеств, но стабильно, предсказуемо и качественно;
- акцент на свежесть, минимальную боль при выборе и оплате;
- **гарантия качества продуктов** (аналог китайского Poizon для продуктов):
  - если товар не соответствует заявленному качеству (лежалый, тухлый, недовес, повреждения), клиент может открыть **спор** между собой и магазином;
  - платформа выступает арбитром и **гарантом качества**, при этом больше на стороне клиента для обеспечения доверия;
  - возможные решения спора: возврат денег, предоставление скидки, замена товара;
  - каждая посылка проверяется на качество (визуально + вес);
  - ведётся **рейтинг надёжности клиента** для отслеживания злоупотреблений системой споров;
  - логика с весом:
    - клиент заказывает, например, 500гр товара;
    - отмерить ровно 500гр сложно, поэтому магазин отмеряет приблизительно;
    - **недовес**: разница возвращается клиенту в виде **баллов** (бонусов), которые можно использовать в следующих заказах;
    - **перевес**: если отмерили больше заказанного, перевес идёт за счёт продавца (клиент не доплачивает).

Основная идея для магазинов (селлеров):
- **бесплатная инфраструктура для ведения бизнеса** — платформа не берет абонентскую плату, только % от онлайн-заказов;
- **комплексное решение для управления магазином**:
  - **складской учёт**: простая, но функциональная система управления остатками, приход/расход, инвентаризация, списания;
  - **управление сотрудниками**: найм, увольнение, прикрепление к магазинам, настройка ролей и доступов;
  - **управление сменами**: открытие/закрытие смен, отслеживание рабочего времени, производительности;
  - **витрина и каталог**: настройка ассортимента, цен, фото, описаний; управление видимостью товаров;
  - **представление в интернете**: автоматическая страница магазина на платформе, доступная всем клиентам;
  - **инструменты маркетинга**: 
    - акции и скидки;
    - промокоды;
    - управление рейтингом и отзывами;
    - статистика эффективности рекламных кампаний;
  - **аналитика работы**:
    - онлайн-заказы (конверсия, средний чек, популярные товары);
    - офлайн-продажи (если ведется учет через платформу);
    - финансовые показатели (выручка, комиссия, чистая прибыль);
    - операционные метрики (скорость сборки, время доставки, % отмен);
    - сравнение периодов, динамика роста;
- **прозрачные финансы**:
  - расчётные периоды с детализацией по каждому заказу;
  - автоматические отчёты и выплаты;
  - онлайн-доступ к балансу и транзакциям в любой момент;
- **минимальный порог входа**: не нужны большие инвестиции в IT-инфраструктуру, достаточно просто подключиться к платформе.

---

## 2. Основные участники и их роли

### 2.1. Клиент (Customer)

- Заходит в приложение / на сайт / в бота.
- Ищет товары, формирует корзину, оформляет и оплачивает заказ.
- Получает заказ (доставка / самовывоз), может оставить отзыв, обратиться в поддержку, запросить возврат.

Бекендовый контекст:
- сущность `Customer`;
- истории заказов, адреса, настройки, поддержка.

### 2.2. Селлер (Seller)

- Юр лицо / ИП, которое подключается к платформе.
- Может владеть **одним или несколькими** магазинами (`Shop`).
- Определяет ассортимент, цены, операционные процессы внутри своих магазинов.
- Получает выплаты от платформы по расчётным периодам.

Бекендовый контекст:
- сущность `Seller` (реквизиты, статусы, тариф/комиссия, привязка к пользователям-владельцам).

### 2.3. Магазин (Shop)

- Конкретная торговая точка/точка сборки:
  - адрес;
  - режим работы;
  - зона обслуживания (доставка/самовывоз).

- В контексте бизнеса:
  - **все заказы всегда привязаны к конкретному Shop**;
  - остатки и складской учёт ведутся по Shop.

Бекенд:
- сущность `Shop` со статусами (active / pending / blocked / закрыт для заказов).

### 2.4. Сотрудники магазина (Employee)

- Работают **внутри магазина**:
  - сборщики;
  - упаковщики;
  - курьеры;
  - кладовщики;
  - менеджеры смен.
- Заходят в панели / боты / приложения для выполнения операционной работы.

Бекенд:
- сущность `Employee`, привязка к `Shop`, роли внутри магазина;
- `Shift` (смены), `Task` (задачи по заказам/складу).

### 2.5. Сотрудники платформы (PlatformStaff)

- Персонал, который работает **на стороне платформы**:
  - владелец/админ (MVP);
  - позже: финансы, поддержка, менеджеры селлеров, риск.
- Имеют доступ к бэкофису `/api/platform/**`.

Бекенд:
- сущность `PlatformStaff` (роль `platform_admin` в MVP, остальные роли — фундамент на будущее).

### 2.6. Внешние сервисы

- Платёжный провайдер (например, ЮKassa) — оплата клиентом, СБП и т.д.
- Служба доставки (например, Dostavista или аналог) — по мере необходимости.
- Эти интеграции важны для бизнес-модели, но в MVP можно частично эмулировать/упрощать.

---

## 3. Базовая ценность и потоки денег

### 3.1. Что происходит в деньгах (в общем виде)

1. Клиент создаёт заказ и оплачивает его **онлайн** (СБП/карта).
2. Деньги поступают на сторону платформы / платёжного провайдера (точная схематика — агентская).
3. Платформа:
   - удерживает свою комиссию и возможные сборы;
   - фиксирует «доход селлера» по заказу;
   - в рамках расчётных периодов формирует выплаты селлерам (Payout).

### 3.2. Агентская модель (предполагаемая)

> **Важно:** здесь схема описана как целевая, детали могут меняться.

- Платформа выступает агентом:
  - принимает оплату от клиента;
  - реализует товары **от имени селлера** (агентский договор);
  - перечисляет селлеру выручку за вычетом комиссии и удержаний.
- Комиссия платформы (динамическая):
  - Базовая: % от суммы заказа (10–30%, зависит от договорённости);
  - Может снижаться при выполнении условий:
    - долгое сотрудничество (например, -2% после 6 месяцев);
    - высокий оборот (например, -1% при обороте >500к/мес);
    - высокий рейтинг качества;
  - Может повышаться как штраф:
    - много жалоб от покупателей (+3-5%);
    - систематические нарушения SLA;
    - низкий рейтинг магазина;
  - Возможна минимальная комиссия по заказу (например, 50₽ при сумме <500₽).

### 3.3. Расчётные периоды и выплаты

- Для каждого **магазина** (Shop) ведётся сущность `SettlementPeriod` (в модуле `finance/shop-account`):
  - период (даты);
  - валовой оборот по заказам магазина;
  - комиссия платформы (с учетом динамики);
  - возвраты/штрафы;
  - итог к выплате;
  - статус (open / closed / paid / frozen).
- После окончания периода и расчётов:
  - деньги, готовые к выводу, **аккумулируются** в `SellerAccount` (модуль `finance/seller-account`);
  - продавец видит общую сумму по всем своим магазинам;
- Выплаты (`Payout`) делаются **с задержкой** (например, раз в 2 недели, после закрытия периода).

Бекендовые инварианты (high level):
- Заказы входят в период по дате доставки/завершения (или по дате оплаты — надо будет зафиксировать).
- Закрытый период **не изменяется**; корректировки делаются отдельными транзакциями.
- Все действия по ручным корректировкам должны быть связаны с `PlatformStaff`.

---

## 4. Ключевые бизнес-сущности (на концептуальном уровне)

Здесь — не техническая схема БД, а «что есть что» с точки зрения бизнеса.

### 4.1. Каталог и товары

- `Product` — бизнес-единица товара (например, «Яблоко Гала»).
- `SKU` — конкретный SKU/вариант (упаковка, вес, размер).
- `ShopProduct` / `Price` — связь товара с магазином:
  - цена в конкретном магазине;
  - доступность;
  - настройки витрины (сортировка, коллекции).

### 4.2. Заказы и оплата

- `Order`:
  - клиент;
  - магазин (Shop);
  - список `OrderItem`;
  - суммы;
  - способ получения (доставка / самовывоз);
  - статусы (created / pending_payment / paid / picking / ready / in_delivery / delivered / canceled / refund и т.д.).
- `Payment`:
  - платёжный метод;
  - сумма;
  - статусы (init / success / failed / refunded).
- `Refund`:
  - ссылка на Order / Payment;
  - сумма (частичная/полная);
  - причина.

### 4.3. Склад и остатки

- `Inventory` / `Stock`:
  - остатки по SKU в рамках магазина.
- `StockMovement`:
  - тип (initial / intake / sale / return / write_off / inventory_adjustment);
  - количество (±);
  - ссылка на источник (поставка, заказ, инвентаризация).
- Инвариант:
  - текущий остаток по SKU в Shop = сумма всех движений по SKU в этом Shop.

### 4.4. Финансы

- `SettlementPeriod`:
  - селлер;
  - период;
  - суммы и статус.
- `SettlementTransaction`:
  - тип (доход по заказу, возврат, штраф, корректировка и т.п.);
  - ссылка на Order/Refund/ручное действие;
  - знак (+/-).
- `Payout`:
  - селлер;
  - связанный период;
  - сумма;
  - статус выплаты.

### 4.5. Операции магазина (операционный контур)

- `Task`:
  - тип (picking, packing, delivery, stock_intake, stock_write_off, inventory и т.д.);
  - статус (new / in_progress / completed / canceled);
  - ссылки на Order / Shop / Employee / Shift.
- `Shift`:
  - сотрудник;
  - магазин;
  - время начала/окончания;
  - статус (active / closed).

### 4.6. Поддержка и инциденты

- `SupportCase`:
  - инициатор (client / seller / employee / platform);
  - связанный Order / Shop / Seller;
  - статус (open / in_progress / resolved / closed);
  - история сообщений/решений.
- `AuditLog`:
  - кто (PlatformStaff / Seller / Employee);
  - что сделал;
  - над чем;
  - когда.

---

## 5. Жизненный цикл заказа (бизнес-уровень)

Кратко (детально см. `client-flows.md`, `seller-flows.md`, `employee-flows.md`, `shop-flows.md`).

1. **Клиент**:
   - выбирает магазин/точку (явно или по гео/логике платформы),
   - формирует корзину,
   - оставляет адрес и контакт,
   - оплачивает заказ.

2. **Платёж**:
   - платёжный провайдер подтверждает оплату,
   - бекенд фиксирует `Payment` и ставит заказ в статус `paid`.

3. **Магазин**:
   - заказ привязывается к конкретному `Shop`,
   - в панели магазина появляется новый заказ,
   - создаются задачи `Task` на сборку/упаковку/доставку.

4. **Операции магазина**:
   - сотрудники (`Employee`) в панелях/ботах:
     - открывают заказ,
     - собирают, упаковывают, передают курьеру / готовят к самовывозу;
   - при сборке обновляются остатки/резервы;
   - задаются финальные веса/суммы (если есть весовой товар).

5. **Доставка / самовывоз**:
   - курьер доставляет заказ и отмечает статус (delivered / failed);
   - при самовывозе сотрудник выдаёт заказ и подтверждает в системе.

6. **Завершение**:
   - заказ получает финальный статус (delivered / canceled / refund);
   - данные уходят в финансовый контур (SettlementPeriod).

7. **Возвраты/проблемы**:
   - через `SupportCase`/обращения фиксируются проблемы;
   - при необходимости создаются `Refund` и корректировки в `SettlementTransaction`.

---

## 6. Ключевые бизнес-инварианты (важно для бэкенда)

На уровне бизнес-логики, которые желательно держать как «правила вселенной»:

1. **Каждый заказ привязан к одному магазину (`Shop`).**  
   В MVP нет мульти-магазинной корзины.

2. **Остатки считаются через движения.**  
   Нет прямого ручного редактирования поля `quantity` без `StockMovement`.

3. **Оплаченный заказ не «удаляется».**  
   Он может:
   - переходить в статусы отмены/возврата,
   - корректироваться через `Refund` и финансовые транзакции.

4. **Закрытый расчётный период не переписывается.**  
   Любые изменения постфактум — только через дополнительные `SettlementTransaction`.

5. **Любое критичное действие PlatformStaff (финансы, блокировки, тарифы) — с аудитом.**

6. **Любая операционная активность магазина должна быть связана с `Employee` и `Shop`.**

---

## 7. MVP-ограничения (для фокуса бэка)

Чтобы бэкенд не «улетел» в overengineering, фиксируем примерные ограничения MVP (могут корректироваться):

- один город / ограниченный список городов;
- один тип платформенного сотрудника — `platform_admin`;
- нет сложной системы лояльности/реферальных схем (можно закладывать хук, но не реализовывать);
- один платёжный провайдер;
- одна модель доставки (или простая «свой курьер», интеграции позже);
- базовая аналитика (без отдельного BI-движка, но с возможностью агрегаций по заказам/селлерам/магазинам).

---

## 8. Как использовать этот документ при разработке бэка

- При проектировании новых модулей:
  - сверяться, на каком уровне эта логика — клиент/магазин/платформа;
  - проверять, не ломает ли фича инварианты (остатки, Settlements, связи с Shop/Seller).
- При общении с ИИ:
  - давать этот документ как основной контекст по бизнеску;
  - ссылаться на конкретные разделы (например: «см. раздел 4.2 про Order/Payment/Refund»).
- При уточнениях:
  - править в первую очередь этот файл, затем уже детальные `*-flows.md` и `domain-*.md`.

Документ — v0.1 и предполагает дальнейшую детализацию (особенно по финансам, складу и state machine заказов).