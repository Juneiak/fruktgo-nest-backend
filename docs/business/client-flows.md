# Сквозные процессы для клиентов (draft v0.1)

Документ описывает сквозные процессы (end-to-end флоу) именно со стороны **клиента** маркетплейса быстрой доставки свежих продуктов.

Цель:

* зафиксировать, **как клиент взаимодействует с системой от первого касания до пост-обслуживания**,
* дать основу для проектирования API, БД, фронтенда и автотестов.

---

## 1. Клиентский процесс: первый визит и онбординг

### 1.1. Первый визит (гость)

1. Клиент открывает приложение / сайт как гость.
2. Система определяет город (по геолокации / IP / выбору пользователя).
3. Клиент видит витрину:

   * базовые коллекции (хиты, акции, подборки),
   * ограниченный функционал без авторизации (просмотр, добавление в корзину).
4. Клиент может:

   * просматривать категории и товары,
   * добавить товары в корзину,
   * попытаться перейти к оформлению.

**Требования к бекенду:**

* Поддержка гостевых сессий и корзины (привязка к device/session).
* API для получения доступных магазинов/витрины по городу.

### 1.2. Регистрация / авторизация

1. При попытке оформить заказ система предлагает:

   * войти (если уже есть аккаунт),
   * зарегистрироваться.
2. **Обязательная авторизация (MVP):**

   * через **Telegram** (Login Widget / deep-link из бота),
   * с привязкой **номера телефона**.
   * Минимум: `telegramId` + `phone`.
3. Дополнительные способы авторизации (в будущем):

   * SMS/звонок напрямую (без Telegram),
   * email+пароль (опционально).
4. После успешной авторизации:

   * гостевая корзина при необходимости мёрджится с корзиной аккаунта,
   * создаётся/обновляется профиль клиента (`Customer`).

**Требования к бекенду:**

* Модель `Customer` с полями `telegramId` (unique) и `phone` (unique).
* Механизм привязки гостевой корзины к пользователю при логине.
* Telegram auth flow (Login Widget или bot deep-link).

---

## 2. Каталог, поиск и подбор товаров

### 2.1. Просмотр витрины

1. Клиент выбирает магазин (явно или система подбирает оптимальный по зоне доставки).
2. Запрашивает каталог:

   * категории,
   * подборки (акции, новинки, хиты),
   * персональные рекомендации (в будущем).
3. Клиент листает товары, открывает карточки товаров.

**API/БД:**

* Категории, товары, SKU, цены, доступность по магазину.

### 2.2. Поиск и фильтрация

1. Клиент использует поиск по ключевым словам ("яблоки", "манго", "смесь орехов").
2. Применяет фильтры:

   * по типу товара (фрукты, овощи, ягоды, зелень, сухофрукты, орехи, бакалея),
   * по цене,
   * по акциям.
3. Результаты отображаются с учётом доступности товаров в выбранном магазине/зоне.

**API/БД:**

* Эластичный поиск (позже) или базовый фильтр по полям.
* Учёт наличия (inventory) при формировании выдачи.

---

## 3. Корзина и оформление заказа

### 3.1. Управление корзиной

1. Клиент добавляет товар/sku в корзину с указанием количества.
2. Система:

   * создаёт/обновляет объект `Cart`,
   * пересчитывает предварительную сумму заказа.
3. Клиент может:

   * изменять количество,
   * удалять позиции,
   * очищать корзину.

Особенности для свежих продуктов:

* Возможность веса/насыпных товаров (например, диапазон веса или округление до фасовки магазина) — на раннем этапе можно упростить.

### 3.2. Выбор адреса и способа получения

1. Клиент переходит к оформлению.
2. Выбирает:

   * существующий адрес или добавляет новый,
   * способ получения: доставка / самовывоз.
3. Система проверяет:

   * зона доставки / доступность магазина по этому адресу,
   * доступные интервалы времени (если используется слотирование).

**API/БД:**

* Сущность `Address` в рамках `CustomerProfile`.
* Сервис проверки зоны доставки.

### 3.3. Подтверждение заказа и расчёт стоимости

1. Клиент видит итоговый расчёт:

   * стоимость товаров,
   * скидки/промокоды (если есть),
   * стоимость доставки,
   * итог к оплате.
2. Клиент вводит промокод (при наличии).
3. Система валидирует промокод и обновляет расчёт.
4. После подтверждения создаётся предварительный заказ (черновой `Order` в статусе draft/pending_payment).

**API/БД:**

* Временный статус заказа до успешной оплаты.
* Чёткий инвариант: сумма заказа, состав и цены фиксируются на момент создания заказа.

---

## 4. Оплата заказа

### 4.1. Инициация оплаты

1. Клиент выбирает способ оплаты (например, СБП, карта, и т.п. — зависит от интеграций).
2. Бекенд создаёт запись `Payment`:

   * статус `initiated`,
   * сумма,
   * привязка к заказу,
   * данные плательщика.
3. Клиент перенаправляется/инициирует оплату через платёжный провайдер.

### 4.2. Завершение оплаты

1. Платёжный провайдер возвращает результат (webhook / callback).
2. Бекенд:

   * валидирует данные,
   * обновляет `Payment` (success/failed/canceled),
   * при success переводит `Order` в статус `paid`,
   * при ошибке — оставляет/переводит заказ в статус `payment_failed` (с возможностью повторной оплаты).
3. Клиент получает информацию:

   * об успешной оплате и переходе к сборке заказа,
   * или о неуспехе и вариантах повторить попытку.

**Инварианты:**

* Нельзя изменить состав заказа после успешной оплаты (только отмена/частичный возврат).
* Денежная логика (комиссия, агентская модель) привязана к успешному платежу.

---

## 5. Отслеживание статуса и получение заказа

### 5.1. Статусы заказа для клиента

Типовые статусы, видимые клиенту:

* `created` / `pending_payment` — заказ создан, в ожидании оплаты.
* `paid` — оплачен, ожидает сборки.
* `in_progress` / `picking` — заказ собирается.
* `ready_for_delivery` / `ready_for_pickup` — готов к выдаче/доставке.
* `on_the_way` — в пути к клиенту.
* `delivered` — доставлен / получен.
* `canceled` — отменён.

Бекенд хранит более детальные внутренние статусы, но клиенту показывается упрощённая модель.

### 5.2. Уведомления

1. При изменении ключевых статусов:

   * `paid`,
   * `ready_for_delivery/ready_for_pickup`,
   * `on_the_way`,
   * `delivered`,
   * `canceled`,
     клиент получает уведомление (push/SMS/Telegram/email).

2. Клиент может открыть экран заказа и увидеть:

   * текущий статус,
   * ETA (примерное время доставки),
   * контакт/чат поддержки (при необходимости).

---

## 6. Отмена, частичный отказ и возвраты

### 6.1. Отмена до сборки/отправки

1. Клиент запрашивает отмену заказа из приложения/сайта.
2. Бекенд проверяет:

   * текущий статус заказа,
   * правила (можно ли отменить на этой стадии).
3. Если заказ ещё не в сборке/не передан на доставку:

   * заказ переводится в `canceled`,
   * инициируется полный возврат средств через платёжный провайдер.

### 6.2. Частичный отказ при доставке / после получения

Сценарий зависит от бизнес-правил (v0 можно упростить):

1. Клиент сообщает о проблеме (через приложение/поддержку):

   * товар плохого качества,
   * не тот товар,
   * недовоз.
2. Поддержка/система фиксирует кейс `SupportCase` с привязкой к `Order` и позициям.
3. Возможные действия:

   * частичный возврат по конкретным позициям,
   * бонусы/кешбек/промокод вместо возврата денег.

**API/БД:**

* `Refund` и/или `Compensation` как сущности.
* Связь с `Payment` и финансовой подсистемой.

---

## 7. Оценки, отзывы и повторные заказы

### 7.1. Оценка заказа/магазина

1. После статуса `delivered` клиенту может приходить запрос на оценку:

   * оценка по шкале (например, 1–5),
   * текстовый отзыв,
   * возможность указать проблему.
2. Отзывы могут быть привязаны к:

   * заказу в целом,
   * магазину,
   * конкретным товарам (позже).

**API/БД:**

* Сущность `Review` (типы: по магазину, по товару, по заказу).

---

## 8. Профиль, адреса и платёжные настройки

### 8.1. Профиль клиента

1. Клиент может управлять профилем:

   * имя,
   * контакты (телефон, Telegram),
   * предпочтения (опционально).
2. Все изменения сохраняются в `Customer`.

### 8.2. Адреса доставки

1. Клиент может:

   * добавлять новые адреса,
   * редактировать существующие,
   * помечать адрес по умолчанию.
2. Бекенд хранит историю адресов с возможностью деактивации.

### 8.3. Платёжные методы (если применимо)

1. В будущем — возможность привязки платёжных методов (tokenized cards и т.п.).
2. В MVP можно ограничиться разовой оплатой без сохранения платёжных данных на стороне платформы.

---

## 9. Взаимодействие с поддержкой

### 9.1. Обращения в поддержку

1. Клиент из приложения открывает раздел "Помощь" / "Поддержка".
2. Может:

   * создать обращение по конкретному заказу,
   * задать общий вопрос.
3. Система создаёт `SupportCase`:

   * тип (качество, недовоз, оплата, другое),
   * статус (новый, в работе, решён),
   * привязка к клиенту и заказу.

### 9.2. Каналы коммуникации

* Встроенный чат в приложении/сайте (позже).
* Интеграция с Telegram/почтой для уведомлений и ответов.

---

## 10. Лояльность и промо (на будущее)

На уровне процессов стоит зарезервировать:

1. **Промокоды и акции**:

   * клиент вводит промокод при оформлении,
   * видит баннеры/акции в каталоге.

2. **Баллы лояльности/кэшбек**:

   * начисление баллов за заказы,
   * списание баллов при последующих заказах.

3. **Реферальная программа**:

   * приглашение друзей,
   * бонусы за первый заказ приглашённого.

Эти процессы можно включить в следующую итерацию бизнес-модели и архитектуры.
