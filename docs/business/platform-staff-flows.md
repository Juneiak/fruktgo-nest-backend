# Сквозные процессы для PlatformStaff (MVP) (draft v0.1)

Документ описывает сквозные процессы (end-to-end флоу) для **сотрудников платформы (PlatformStaff)**, работающих в бэкофисе / админке, с учётом того, что на этапе MVP используется только один тип сотрудника — администратор платформы (`platform_admin`).

## Цель

* зафиксировать, **как сотрудники платформы взаимодействуют с системой**;
* задать фундамент под **разделение ролей** (finance, support, seller_manager, risk и т.д.),
* но **в MVP используется только один тип — бог-админ (`platform_admin`)**, имеющий полный доступ.

---

## 0. Модель ролей (фундамент)

В модели `PlatformStaff` предусмотрены роли:

* `platform_admin` — полный доступ (в MVP единственный реально используемый);
* `platform_finance` — финансы, расчётные периоды, выплаты (будущее);
* `platform_support` — поддержка клиентов/селлеров (будущее);
* `platform_seller_manager` — модерация селлеров и магазинов (будущее);
* `platform_risk` — риск-контроль/антифрод (будущее).

**Для MVP:** все функциональные флоу из этого документа выполняются одним `PlatformStaff` с ролью `platform_admin`.

---

## 1. Онбординг и управление учётками PlatformStaff

### 1.1. Создание администратора платформы (MVP)

1. На этапе развёртывания системы создаётся как минимум одна запись `PlatformStaff`:

   * `name` (ФИО / ник),
   * `email` и/или `phone`,
   * роли: `['platform_admin']`,
   * статус: `active`.
2. Данные для входа (пароль / код / приглашение) передаются безопасным каналом владельцу платформы.

В будущем создание новых сотрудников платформы будет делаться через UI, но для MVP достаточно:

* либо ручного создания записи в БД / сидера,
* либо минимальной формы в админке, доступной только существующему `platform_admin`.

### 1.2. Изменение данных и блокировка

Администратор может для себя или других PlatformStaff (когда они появятся):

1. Обновить:

   * контакты (email/phone),
   * имя,
   * служебные заметки.
2. Сменить статус:

   * `active` → `blocked` (полный запрет доступа),
   * `blocked` → `active` (разблокировка).

**Инвариант:** для `blocked` PlatformStaff:

* новые токены не выдаются;
* любые запросы с его идентификатором должны отклоняться.

---

## 2. Авторизация и доступ в бэкофис

### 2.1. Вход в систему (MVP-вариант)

Базовый флоу:

1. Админ открывает URL бэкофиса (например, `/backoffice` или `/platform`).
2. Вводит:

   * email/телефон,
   * пароль или одноразовый код.
3. Бекенд:

   * находит `PlatformStaff` по email/телефону,
   * проверяет пароль/код,
   * проверяет статус `active`,
   * формирует JWT/сессию вида:

```json
{
  "platformStaffId": "…",
  "platformRoles": ["platform_admin"],
  "exp": 1234567890
}
```

4. Админ получает доступ к бэкофису.

В дальнейшем можно добавить вход через Telegram-бота, но для MVP это необязательно.

### 2.2. Проверка прав при запросах

1. Все маршруты бэкофиса помещаются под namespace, например:
   `/api/platform/**`.
2. Любой запрос к `/api/platform/**` проходит через:

   * **PlatformAuthGuard** – проверка токена, поднятие `PlatformStaff` из БД, проверка `status = active`;
   * **PlatformRolesGuard** – проверка наличия нужной роли (в MVP — `platform_admin`).

Пример логики (абстрактно):

* для доступа к любому `/api/platform/**` достаточно `platform_admin`;
* при появлении других ролей можно писать: `PlatformRolesGuard('platform_finance')` и т.п.

---

## 3. Ежедневный флоу PlatformStaff в MVP (бог-админ)

В MVP **один админ делает всё**, что в будущем может быть разделено по ролям.

### 3.1. Управление селлерами и магазинами

1. Админ заходит в раздел **Селлеры**:

   * видит список `Seller`,
   * видит статус каждого (active / pending / rejected / blocked).
2. Обрабатывает заявки новых селлеров:

   * проверяет реквизиты (ИНН, данные),
   * присваивает статус:

     * `active` — допущен к работе,
     * `rejected` — отказ,
     * `pending` / `on_hold` — если нужно ещё что-то проверить.
3. Управляет магазинами `Shop`:

   * активирует / блокирует магазины,
   * следит, чтобы у блокированных магазинов не создавались новые заказы.

Результат: **контролируемый список селлеров и их магазинов**, которые попадают на витрину клиентам.

### 3.2. Управление каталогом “сверху” (если нужно)

Даже если селлеры частично сами управляют каталогом, админ может:

* модерировать товары (название, фото, категории);
* скрывать/блокировать товары, нарушающие правила;
* править ошибки в описаниях.

(Это может быть минимально реализовано в MVP, но бизнес-флоу предусмотрен.)

### 3.3. Контроль заказов и инцидентов

Админ может:

1. Смотреть список заказов:

   * по селлерам,
   * по статусам (created, paid, in_progress, delivered, canceled, refund и т.п.).
2. Проваливаться в проблемные заказы:

   * недоставлен, спор клиент-селлер, сомнительная активность.
3. При необходимости:

   * вручную менять статусы (например, закрыть проблемный заказ),
   * инициировать возврат / корректировку (в привязке к финподсистеме).

---

## 4. Финансы и расчётные периоды (выполняет admin в MVP)

В будущем это зона `platform_finance`, но сейчас всё делает `platform_admin`.

### 4.1. Расчётные периоды селлеров

1. Система создаёт `SettlementPeriod` для каждого селлера (например, раз в 2 недели).
2. Админ в бэкофисе видит:

   * список периодов,
   * оборот, комиссии, итоговые суммы к выплате,
   * статус периода (открыт / рассчитан / закрыт).
3. При необходимости вносит ручные корректировки:

   * штрафы,
   * дополнительные бонусы,
   * исправление ошибок по конкретным заказам.

Все ручные изменения должны логироваться (кто, когда, что поменял).

### 4.2. Выплаты селлерам

1. После закрытия `SettlementPeriod` админ:

   * проверяет итог к выплате,
   * запускает создание `Payout` (может быть кнопка типа «Сформировать выплаты»).
2. В зависимости от интеграции:

   * либо выплаты идут автоматически через платёжный сервис,
   * либо админ помечает выплаты как проведённые вручную (например, после перевода через банк).
3. Статусы `Payout`:

   * `pending` → `processing` → `completed` или `failed`.

Админ отвечает за:

* целостность расчётов,
* запуск выплат,
* корректировку статусов при ошибках.

---

## 5. Поддержка клиентов и селлеров (через admin в MVP)

Пока нет выделенной роли `platform_support`, все обращения идут к админу.

### 5.1. Работа с обращениями

1. Клиент/селлер создаёт обращение `SupportCase`:

   * через приложение,
   * через форму на сайте,
   * или через поддержку (Telegram/почта → ручной занос).
2. Админ видит список кейсов:

   * новые, в работе, решённые;
   * фильтры по типу (клиент / селлер / employee).
3. Открывает кейс, видит:

   * автора обращения,
   * связанные заказы, платежи, магазины,
   * историю сообщений.
4. Отвечает:

   * пишет комментарий/ответ,
   * инициирует возврат / корректировку / блокировку,
   * может связаться с селлером или клиентом.

### 5.2. Закрытие кейса

1. После решения проблема:

   * кейс помечается как `resolved`/`closed`,
   * указывается причина/результат (возврат, компенсация, объяснение и т.д.).
2. Это используется для аналитики и контроля качества обслуживания.

---

## 6. Управление платформой и настройками (admin)

### 6.1. Глобальные настройки

Админ может:

* управлять списком городов и регионов;
* задавать минимальные суммы заказа, базовые тарифы, ограничения;
* управлять интеграциями:

  * ключи платёжных систем,
  * настройки служб доставки,
  * токены для Telegram-ботов;
* включать/выключать фичи (feature flags) — по мере появления.

### 6.2. Управление персоналом платформы (на будущее)

Даже если в MVP только один `platform_admin`, структура подразумевает:

* создание новых `PlatformStaff`;
* выдачу им ролей (`platform_finance`, `platform_support`, …);
* блокировку/разблокировку.

В MVP можно ограничиться:

* либо отсутствием UI (создание через сиды/консоль),
* либо очень простым экраном «Список сотрудников платформы» для будущего.

---

## 7. Аудит действий PlatformStaff

Даже в MVP полезно сразу заложить аудит для критичных операций.

### 7.1. Что логировать

Любое действие `platform_admin`, которое:

* меняет деньги (Settlement, Payout, Refund),
* меняет статусы селлеров/магазинов,
* меняет тарифы,
* делает ручные корректировки заказов,

должно создавать запись `AuditLog` с полями:

* `actorType: 'platform_staff'`,
* `actorId: platformStaffId`,
* `action` (код действия: `BLOCK_SELLER`, `SETTLEMENT_CORRECTION`, `MANUAL_REFUND` и т.д.),
* `entityType`, `entityId` (над чем действие),
* `meta` (детали до/после, причина),
* `createdAt`.

### 7.2. Использование аудита

* внутренние проверки «кто что сделал и почему»;
* диагностика ошибок;
* юридическая надёжность (особенно по выплатам и блокировкам).

---

## 8. Ограничения и инварианты для PlatformStaff-флоу

1. Все маршруты `/api/platform/**` доступны **только** при наличии валидного токена `PlatformStaff` со статусом `active`.
2. В MVP любая операция в `/api/platform/**` требует роли `platform_admin`.
3. В будущем роли `platform_finance`, `platform_support`, `platform_seller_manager`, `platform_risk` будут получать отдельные наборы прав, но модель уже поддерживает массив `roles`.
4. Любые изменения, влияющие на финансы и статус селлеров/магазинов, должны быть:

   * авторизованы через PlatformStaff,
   * зафиксированы в аудите.

---

Это v0.1. В следующих итерациях можно:

* на основе этого документа разметить конкретные endpoint’ы `/api/platform/**`,
* и отдельно сделать мини-матрицу: **операция → нужна ли для MVP → какая роль в будущем** (сейчас везде `platform_admin`, позже добавим дробление).
